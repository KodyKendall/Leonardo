<%= turbo_frame_tag dom_id(tender_line_item) do %>
  <div class="mb-6">
    <!-- Main Card with Collapsible Breakdown Details -->
    <div class="card bg-base-100 shadow-md">
      <div class="card-body">
        <%= form_with model: [tender_line_item.tender, tender_line_item],
                      data: {
                        controller: "dirty-form",
                        action: "input->dirty-form#change change->dirty-form#change turbo:submit-end->dirty-form#reset"
                      } do |f| %>
          <!-- Delete Button (Top Right) -->
          <div class="flex justify-end mb-3">
            <%= button_to tender_tender_line_item_path(tender_line_item.tender, tender_line_item),
                          method: :delete,
                          class: "btn btn-xs btn-ghost text-error",
                          form: { data: { turbo_confirm: "Delete this line item?" } },
                          title: "Delete" do %>
              <i class="fas fa-trash"></i>
            <% end %>
          </div>

          <!-- All Fields in One Row -->
          <div class="grid grid-cols-12 gap-2">
            <!-- Page -->
            <div class="col-span-1">
              <label class="label label-text text-xs font-semibold">Page</label>
              <%= f.text_field :page_number, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Item # -->
            <div class="col-span-1">
              <label class="label label-text text-xs font-semibold">Item</label>
              <%= f.text_field :item_number, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Description -->
            <div class="col-span-3">
              <label class="label label-text text-xs font-semibold">Description</label>
              <%= f.text_field :item_description, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Unit -->
            <div class="col-span-1">
              <label class="label label-text text-xs font-semibold">Unit</label>
              <%= f.text_field :unit_of_measure, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Quantity -->
            <div class="col-span-1">
              <label class="label label-text text-xs font-semibold">Qty</label>
              <%= f.number_field :quantity, step: 0.01, min: 0, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Rate -->
            <div class="col-span-1.5">
              <label class="label label-text text-xs font-semibold">Rate</label>
              <%= f.number_field :rate, step: 0.01, min: 0, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Line Total -->
            <div class="col-span-1.5 flex flex-col justify-end">
              <div class="text-xs text-gray-500 font-semibold">Line Total</div>
              <div class="font-bold text-gray-900 text-sm p-2 rounded text-center">R<%= number_with_precision(tender_line_item.total_amount, precision: 2, delimiter: ",") %></div>
            </div>
          </div>

          <!-- Save Button & Dirty Indicator -->
          <div class="flex items-center gap-3 mt-3">
            <%= f.submit "Save", class: "btn btn-primary btn-sm", data: { dirty_form_target: "submit" } %>
            <span class="hidden text-warning text-sm font-medium" data-dirty-form-target="indicator">
              Unsaved changes
            </span>
            <button type="button" class="btn btn-ghost btn-sm ml-auto material-breakdown-toggle" onclick="document.getElementById('toggle_<%= tender_line_item.id %>').click()">
              <i class="fas fa-chevron-down"></i>
              Rate Buildup
            </button>
          </div>
        <% end %>
      </div>

      <!-- Collapse Wrapper for Breakdown Details -->
      <div class="collapse" data-line-item-id="<%= tender_line_item.id %>" id="collapse_<%= tender_line_item.id %>">
        <!-- Checkbox Toggle (hidden but controls collapse) -->
        <input type="checkbox" class="line-item-toggle" id="toggle_<%= tender_line_item.id %>" />
        
        <!-- Header Section (empty to prevent event interception) -->
        <div class="collapse-title p-0"></div>

        <!-- Expandable Breakdown Details Section -->
        <div class="collapse-content pt-0">
          <div class="card-body border-t">
            <!-- Two-Column Layout: Rate Build-Up (Left) | Material Breakdown (Right) -->
            <div class="grid grid-cols-2 gap-6">
              <!-- Rate Build-Up (Left) -->
              <div>
                <% if tender_line_item.line_item_rate_build_up %>
                  <%= render tender_line_item.line_item_rate_build_up %>
                <% else %>
                  <div class="alert alert-warning">No rate build-up found</div>
                <% end %>
              </div>

              <!-- Material Breakdown (Right) -->
              <div>
                <% if tender_line_item.line_item_material_breakdown %>
                  <%= render tender_line_item.line_item_material_breakdown %>
                <% else %>
                  <div class="alert alert-warning">No material breakdown found</div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>
