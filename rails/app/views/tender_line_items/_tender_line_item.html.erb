<%= turbo_frame_tag dom_id(tender_line_item) do %>
  <div class="mb-6">
    <%= form_with model: [tender_line_item.tender, tender_line_item],
                  data: {
                    controller: "dirty-form",
                    action: "input->dirty-form#change change->dirty-form#change turbo:submit-end->dirty-form#reset"
                  } do |f| %>
      <!-- Line Item Header Card -->
      <div class="card bg-base-100 shadow-md">
        <div class="card-body">
          <!-- Delete Button (Top Right) -->
          <div class="flex justify-end mb-3">
            <%= button_to tender_tender_line_item_path(tender_line_item.tender, tender_line_item),
                          method: :delete,
                          class: "btn btn-xs btn-ghost text-error",
                          form: { data: { turbo_confirm: "Delete this line item?" } },
                          title: "Delete" do %>
              <i class="fas fa-trash"></i>
            <% end %>
          </div>

          <!-- All Fields in One Row -->
          <div class="grid grid-cols-12 gap-2">
            <!-- Item # -->
            <div class="col-span-1">
              <label class="label label-text text-xs font-semibold">Item #</label>
              <%= f.text_field :item_number, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Category -->
            <div class="col-span-2">
              <label class="label label-text text-xs font-semibold">Category</label>
              <%= f.select :section_category,
                  options_for_select(TenderLineItem.section_categories.keys, tender_line_item.section_category),
                  { include_blank: "Select..." },
                  class: "select select-sm select-bordered w-full" %>
            </div>

            <!-- Description -->
            <div class="col-span-3">
              <label class="label label-text text-xs font-semibold">Description</label>
              <%= f.text_field :item_description, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Notes -->
            <div class="col-span-2">
              <label class="label label-text text-xs font-semibold">Notes</label>
              <%= f.text_field :notes, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Quantity -->
            <div class="col-span-1">
              <label class="label label-text text-xs font-semibold">Qty</label>
              <%= f.number_field :quantity, step: 0.01, min: 0, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Unit -->
            <div class="col-span-1">
              <label class="label label-text text-xs font-semibold">Unit</label>
              <%= f.text_field :unit_of_measure, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Rate -->
            <div class="col-span-1.5">
              <label class="label label-text text-xs font-semibold">Rate (R)</label>
              <%= f.number_field :rate, step: 0.01, min: 0, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Page -->
            <div class="col-span-1">
              <label class="label label-text text-xs font-semibold">Page</label>
              <%= f.text_field :page_number, class: "input input-sm input-bordered w-full" %>
            </div>

            <!-- Line Total -->
            <div class="col-span-1.5 flex flex-col justify-end">
              <div class="text-xs text-gray-500 font-semibold">Line Total</div>
              <div class="font-bold text-gray-900 text-sm bg-success bg-opacity-10 p-2 rounded text-center">R<%= number_with_precision(tender_line_item.total_amount, precision: 2) %></div>
            </div>
          </div>

          <!-- Save Button & Dirty Indicator -->
          <div class="flex items-center gap-3 mt-3">
            <%= f.submit "Save", class: "btn btn-primary btn-sm", data: { dirty_form_target: "submit" } %>
            <span class="hidden text-warning text-sm font-medium" data-dirty-form-target="indicator">
              Unsaved changes
            </span>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Expandable Breakdowns Section -->
    <div class="collapse collapse-arrow border border-base-300 bg-base-100 mt-2 shadow-md">
      <input type="checkbox" class="line-item-toggle" data-line-item-id="<%= tender_line_item.id %>" />
      <div class="collapse-title font-semibold text-base flex items-center gap-2">
        <i class="fas fa-chevron-down"></i>
        Breakdown Details
      </div>

      <div class="collapse-content pt-4">
        <!-- Two-Column Layout: Rate Build-Up (Left) | Material Breakdown (Right) -->
        <div class="grid grid-cols-2 gap-6">
          <!-- Rate Build-Up (Left) -->
          <div>
            <% if tender_line_item.line_item_rate_build_up %>
              <%= render tender_line_item.line_item_rate_build_up %>
            <% else %>
              <div class="alert alert-warning">No rate build-up found</div>
            <% end %>
          </div>

          <!-- Material Breakdown (Right) -->
          <div>
            <% if tender_line_item.line_item_material_breakdown %>
              <%= render tender_line_item.line_item_material_breakdown %>
            <% else %>
              <div class="alert alert-warning">No material breakdown found</div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>
