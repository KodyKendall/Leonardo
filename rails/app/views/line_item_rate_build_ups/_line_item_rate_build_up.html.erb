<%= turbo_frame_tag dom_id(line_item_rate_build_up) do %>
  <div class="card bg-base-100 shadow" data-controller="line-item-rate-build-up">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h2 class="card-title text-xl">Rate Buildup</h2>
          <% if line_item_rate_build_up.tender_line_item.present? %>
            <p class="text-gray-600 text-sm">
              <span class="font-semibold"><%= line_item_rate_build_up.tender_line_item.item_number || "Item" %></span>
              — <%= line_item_rate_build_up.tender_line_item.item_description %>
            </p>
          <% end %>
        </div>
      </div>

      <% rate_components = [
        { name: "Material Supply", rate_field: :material_supply_rate, included_field: :material_supply_included, is_multiplier: true, readonly: true },
        { name: "Fabrication", rate_field: :fabrication_rate, included_field: :fabrication_included, is_multiplier: true },
        { name: "Overheads", rate_field: :overheads_rate, included_field: :overheads_included, is_multiplier: true },
        { name: "Shop Priming", rate_field: :shop_priming_rate, included_field: :shop_priming_included, is_multiplier: true },
        { name: "Onsite Painting", rate_field: :onsite_painting_rate, included_field: :onsite_painting_included, is_multiplier: true },
        { name: "Delivery", rate_field: :delivery_rate, included_field: :delivery_included, is_multiplier: true },
        { name: "Bolts", rate_field: :bolts_rate, included_field: :bolts_included, is_multiplier: true },
        { name: "Erection", rate_field: :erection_rate, included_field: :erection_included, is_multiplier: true },
        { name: "Crainage", rate_field: :crainage_rate, included_field: :crainage_included, is_multiplier: true },
        { name: "Cherry Picker", rate_field: :cherry_picker_rate, included_field: :cherry_picker_included, is_multiplier: true },
        { name: "Galvanizing", rate_field: :galvanizing_rate, included_field: :galvanizing_included, is_multiplier: true }
      ] %>

      <%= form_with model: line_item_rate_build_up, 
                    local: true, 
                    id: "line_item_rate_build_up_form",
                    url: line_item_rate_build_up_path(line_item_rate_build_up),
                    method: :patch,
                    data: { turbo: true } do |form| %>
        <div class="overflow-x-auto">
          <table class="table table-sm w-full">
            <thead>
              <tr class="bg-base-200">
                <th>Component</th>
                <th class="text-center">Included</th>
                <th class="text-right">Rate (R)</th>
                <th class="text-right">Amount (R)</th>
              </tr>
            </thead>
            <tbody>
              <% rate_components.each_with_index do |component, index| %>
                <% rate_value = line_item_rate_build_up.send(component[:rate_field]) || 0 %>
                <% is_included = line_item_rate_build_up.send(component[:included_field]) %>
                <% is_multiplier = component[:is_multiplier] %>
                <% is_readonly = component[:readonly] %>
                <tr class="hover:bg-base-200" data-line-item-rate-build-up-target="row">
                  <td class="font-medium">
                    <div class="flex items-center gap-1">
                      <%= component[:name] %>
                      <% if is_readonly %>
                        <span class="tooltip tooltip-warning" data-tip="Calculated automatically">
                          <i class="fas fa-lock text-xs text-warning"></i>
                        </span>
                      <% elsif is_multiplier %>
                        <span class="tooltip tooltip-info" data-tip="Enter a decimal multiplier (e.g., 0.75 = 75%, 1.0 = 100%, 1.25 = 125%)">
                          <i class="fas fa-info-circle text-xs text-info"></i>
                        </span>
                      <% end %>
                    </div>
                  </td>
                  <td class="text-center">
                    <% if is_readonly %>
                      <span class="text-sm font-medium"><%= number_to_currency(is_included || 0, unit: "", precision: 2) %></span>
                    <% else %>
                      <!-- All components: Multiplier field -->
                      <%= form.number_field component[:included_field],
                          step: 0.01,
                          min: 0,
                          max: 5.0,
                          placeholder: "1.0",
                          class: "input input-sm input-bordered w-20 text-center",
                          data: {
                            line_item_rate_build_up_target: "multiplierInput"
                          } %>
                    <% end %>
                  </td>
                  <td class="text-right">
                    <% if is_readonly %>
                      <span class="text-sm font-medium"><%= number_to_currency(rate_value || 0, unit: "R ", precision: 2) %></span>
                    <% else %>
                      <%= form.number_field component[:rate_field],
                          step: 0.01,
                          min: 0,
                          class: "input input-sm input-bordered w-28 text-right",
                          data: {
                            line_item_rate_build_up_target: "rateInput"
                          } %>
                    <% end %>
                  </td>
                  <td class="text-right font-semibold" data-line-item-rate-build-up-target="amountCell">
                    <% component_rate = rate_value || 0 %>
                    <% multiplier = (is_included || 0).to_f %>
                    <% amount = component_rate * multiplier %>
                    <span class="<%= 'text-gray-400' if multiplier == 0 %>">
                      <%= multiplier > 0 ? number_to_currency(amount, unit: "R ", precision: 2) : "—" %>
                    </span>
                  </td>
                </tr>
              <% end %>

              <!-- Custom Items Section -->
              <% if line_item_rate_build_up.rate_buildup_custom_items.any? %>
                <% line_item_rate_build_up.rate_buildup_custom_items.ordered.each_with_index do |custom_item, idx| %>
                  <tr class="hover:bg-base-200 border-t-2 border-orange-200 bg-orange-50" 
                      data-line-item-rate-build-up-target="customRow"
                      data-custom-item-id="<%= custom_item.id %>">
                    <td class="font-medium">
                      <%= form.fields_for :rate_buildup_custom_items, custom_item do |cf| %>
                        <%= cf.text_field :description,
                            placeholder: "e.g., Special Coating",
                            class: "input input-sm input-bordered w-full",
                            data: {
                              line_item_rate_build_up_target: "customDescription"
                            } %>
                      <% end %>
                    </td>
                    <td class="text-center">
                      <%= form.fields_for :rate_buildup_custom_items, custom_item do |cf| %>
                        <%= cf.number_field :included,
                            step: 0.01,
                            min: 0.01,
                            max: 5.0,
                            placeholder: "1.0",
                            class: "input input-sm input-bordered w-20 text-center",
                            data: {
                              line_item_rate_build_up_target: "customIncluded"
                            } %>
                      <% end %>
                    </td>
                    <td class="text-right">
                      <%= form.fields_for :rate_buildup_custom_items, custom_item do |cf| %>
                        <%= cf.number_field :rate,
                            step: 0.01,
                            min: 0,
                            placeholder: "0.00",
                            class: "input input-sm input-bordered w-28 text-right",
                            data: {
                              line_item_rate_build_up_target: "customRate"
                            } %>
                      <% end %>
                    </td>
                    <td class="text-right font-semibold" data-line-item-rate-build-up-target="customAmount">
                      <% amount = ((custom_item.rate || 0).to_f * (custom_item.included || 1.0).to_f) %>
                      <% if amount > 0 %>
                        <%= number_to_currency(amount, unit: "R ", precision: 2) %>
                      <% else %>
                        —
                      <% end %>
                    </td>
                    <td class="text-center">
                      <%= form.fields_for :rate_buildup_custom_items, custom_item do |cf| %>
                        <button type="button" 
                                class="btn btn-sm btn-ghost text-red-500 hover:text-red-700"
                                data-action="click->line-item-rate-build-up#removeCustomItem">
                          <i class="fas fa-trash"></i>
                        </button>
                        <%= cf.hidden_field :_destroy, data: { line_item_rate_build_up_target: "destroyField" } %>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              <% end %>

              <!-- Add Custom Item Button Row -->
              <tr data-line-item-rate-build-up-target="addButtonRow">
                <td colspan="5" class="text-center py-2">
                  <div class="flex justify-center gap-2">
                    <button type="button" 
                            class="btn btn-sm btn-outline text-orange-600 border-orange-300 hover:bg-orange-50"
                            data-action="click->line-item-rate-build-up#addCustomItem">
                      <i class="fas fa-plus mr-1"></i> Add Custom Item
                    </button>
                    <button type="button" 
                            class="btn btn-sm btn-outline text-blue-600 border-blue-300 hover:bg-blue-50"
                            data-action="click->line-item-rate-build-up#toggleMassCalc">
                      <i class="fas fa-calculator mr-1"></i> Calc. Rate /m or /each
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="border-t-2 border-base-300">
                <td colspan="3" class="text-right font-bold">Subtotal:</td>
                <td class="text-right font-bold text-blue-600" data-line-item-rate-build-up-target="subtotal">
                  <%= number_to_currency(line_item_rate_build_up.subtotal, unit: "R ", precision: 2) %>
                </td>
              </tr>
              <tr class="<%= 'hidden' if (line_item_rate_build_up.mass_calc || 1.0) == 1.0 %>" data-line-item-rate-build-up-target="massCalcRow">
                <td colspan="2" class="text-right font-medium">Mass Calc:</td>
                <td class="text-right">
                  <%= form.number_field :mass_calc,
                      step: 0.0001,
                      min: 0.0001,
                      placeholder: "1.0",
                      class: "input input-sm input-bordered w-28 text-right",
                      data: {
                        line_item_rate_build_up_target: "massCalcInput"
                      } %>
                </td>
                <td class="text-right font-semibold text-blue-600">
                  <% mass_calc_total = line_item_rate_build_up.subtotal * (line_item_rate_build_up.mass_calc || 1.0).to_f %>
                  <%= number_to_currency(mass_calc_total, unit: "R ", precision: 2) %>
                </td>
              </tr>
              <tr>
                <td colspan="2" class="text-right font-medium">Margin (%):</td>
                <td class="text-right">
                  <%= form.number_field :margin_percentage,
                      step: 0.01,
                      min: 0,
                      max: 100,
                      placeholder: "e.g., 10.5 for 10.5%",
                      class: "input input-sm input-bordered w-28 text-right",
                      data: {
                        line_item_rate_build_up_target: "marginInput"
                      } %>
                </td>
                <td class="text-right font-semibold text-orange-600" data-line-item-rate-build-up-target="marginDisplay">
                  <%= "#{line_item_rate_build_up.margin_percentage}%" %>
                </td>
              </tr>
              <tr>
                <td colspan="3" class="text-right font-medium">Before Rounding:</td>
                <td class="text-right font-semibold text-purple-600" data-line-item-rate-build-up-target="beforeRounding">
                  <%= number_to_currency(line_item_rate_build_up.total_before_rounding, unit: "R ", precision: 2) %>
                </td>
              </tr>
              <tr class="bg-green-50">
                <td colspan="3" class="text-right font-bold text-lg">
                  <div class="flex items-center justify-end gap-3">
                    <div class="flex items-center gap-1.5 font-normal text-sm text-gray-500">
                      <span>Round up to nearest:</span>
                      <%= form.select :rounding_interval, [['None', 0], 10, 20, 50, 100], {}, 
                          class: "select select-bordered select-xs font-semibold text-gray-700",
                          disabled: line_item_rate_build_up.tender_line_item&.tender&.status == 'Submitted' %>
                    </div>
                    <span>Final Rate:</span>
                  </div>
                  <span class="hidden text-warning" data-line-item-rate-build-up-target="totalDirtyIndicator">*</span>
                </td>
                <td class="text-right font-bold text-lg text-green-600" data-line-item-rate-build-up-target="roundedRate">
                  <%= number_to_currency(line_item_rate_build_up.rounded_rate, unit: "R ", precision: 2) %>
                </td>
              </tr>
            </tfoot>
          </table>

          <div class="mt-6 flex gap-2 items-center">
            <%= form.submit "Save & Calculate",
                class: "btn btn-primary btn-sm transition-colors",
                data: { line_item_rate_build_up_target: "saveButton" } %>
            <span class="hidden text-warning text-sm font-medium" data-line-item-rate-build-up-target="dirtyIndicator">
              <span class="text-warning font-bold">*</span> Unsaved changes
            </span>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
