<%= turbo_frame_tag dom_id(line_item_rate_build_up) do %>
  <div class="card bg-base-100 shadow" data-controller="line-item-rate-build-up">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h2 class="card-title text-xl">Rate Buildup</h2>
          <% if line_item_rate_build_up.tender_line_item.present? %>
            <p class="text-gray-600 text-sm">
              <span class="font-semibold"><%= line_item_rate_build_up.tender_line_item.item_number || "Item" %></span>
              — <%= line_item_rate_build_up.tender_line_item.item_description %>
            </p>
          <% end %>
        </div>
      </div>

      <% rate_components = [
        { name: "Material Supply", rate_field: :material_supply_rate, included_field: :material_supply_included, is_multiplier: true, readonly: true },
        { name: "Fabrication", rate_field: :fabrication_rate, included_field: :fabrication_included, is_multiplier: true },
        { name: "Overheads", rate_field: :overheads_rate, included_field: :overheads_included, is_multiplier: true },
        { name: "Shop Priming", rate_field: :shop_priming_rate, included_field: :shop_priming_included, is_multiplier: true },
        { name: "Onsite Painting", rate_field: :onsite_painting_rate, included_field: :onsite_painting_included, is_multiplier: true },
        { name: "Delivery", rate_field: :delivery_rate, included_field: :delivery_included, is_multiplier: true },
        { name: "Bolts", rate_field: :bolts_rate, included_field: :bolts_included, is_multiplier: true },
        { name: "Erection", rate_field: :erection_rate, included_field: :erection_included, is_multiplier: true },
        { name: "Crainage", rate_field: :crainage_rate, included_field: :crainage_included, is_multiplier: true },
        { name: "Cherry Picker", rate_field: :cherry_picker_rate, included_field: :cherry_picker_included, is_multiplier: true },
        { name: "Galvanizing", rate_field: :galvanizing_rate, included_field: :galvanizing_included, is_multiplier: true }
      ] %>

      <%= form_with model: line_item_rate_build_up, 
                    local: true, 
                    id: "line_item_rate_build_up_form",
                    url: line_item_rate_build_up_path(line_item_rate_build_up),
                    method: :patch,
                    data: { turbo: true } do |form| %>
        <div class="overflow-x-auto">
          <table class="table table-sm w-full">
            <thead>
              <tr class="bg-base-200">
                <th>Component</th>
                <th class="text-center">Included</th>
                <th class="text-right">Rate (R)</th>
                <th class="text-right">Amount (R)</th>
              </tr>
            </thead>
            <tbody>
              <% rate_components.each_with_index do |component, index| %>
                <% rate_value = line_item_rate_build_up.send(component[:rate_field]) || 0 %>
                <% is_included = line_item_rate_build_up.send(component[:included_field]) %>
                <% is_multiplier = component[:is_multiplier] %>
                <% is_readonly = component[:readonly] %>
                <tr class="hover:bg-base-200" data-line-item-rate-build-up-target="row">
                  <td class="font-medium">
                    <div class="flex items-center gap-1">
                      <%= component[:name] %>
                      <% if is_readonly %>
                        <span class="tooltip tooltip-warning" data-tip="Calculated automatically">
                          <i class="fas fa-lock text-xs text-warning"></i>
                        </span>
                      <% elsif is_multiplier %>
                        <span class="tooltip tooltip-info" data-tip="Enter a decimal multiplier (e.g., 0.75 = 75%, 1.0 = 100%, 1.25 = 125%)">
                          <i class="fas fa-info-circle text-xs text-info"></i>
                        </span>
                      <% end %>
                    </div>
                  </td>
                  <td class="text-center">
                    <% if is_readonly %>
                      <span class="text-sm font-medium"><%= number_to_currency(is_included || 0, unit: "", precision: 2) %></span>
                    <% else %>
                      <!-- All components: Multiplier field -->
                      <%= form.number_field component[:included_field],
                          step: 0.01,
                          min: 0,
                          max: 5.0,
                          placeholder: "1.0",
                          class: "input input-sm input-bordered w-20 text-center",
                          data: {
                            line_item_rate_build_up_target: "multiplierInput",
                            action: "blur->line-item-rate-build-up#saveOnBlur"
                          } %>
                    <% end %>
                  </td>
                  <td class="text-right">
                    <% if is_readonly %>
                      <span class="text-sm font-medium"><%= number_to_currency(rate_value || 0, unit: "R ", precision: 2) %></span>
                    <% else %>
                      <%= form.number_field component[:rate_field],
                          step: 0.01,
                          min: 0,
                          class: "input input-sm input-bordered w-28 text-right",
                          data: {
                            line_item_rate_build_up_target: "rateInput",
                            action: "blur->line-item-rate-build-up#saveOnBlur"
                          } %>
                    <% end %>
                  </td>
                  <td class="text-right font-semibold" data-line-item-rate-build-up-target="amountCell">
                    <% component_rate = rate_value || 0 %>
                    <% multiplier = (is_included || 0).to_f %>
                    <% amount = component_rate * multiplier %>
                    <span class="<%= 'text-gray-400' if multiplier == 0 %>">
                      <%= multiplier > 0 ? number_to_currency(amount, unit: "R ", precision: 2) : "—" %>
                    </span>
                  </td>
                </tr>
              <% end %>
            </tbody>
            <tfoot>
              <tr class="border-t-2 border-base-300">
                <td colspan="3" class="text-right font-bold">Subtotal:</td>
                <td class="text-right font-bold text-blue-600" data-line-item-rate-build-up-target="subtotal">
                  <%= number_to_currency(line_item_rate_build_up.subtotal, unit: "R ", precision: 2) %>
                </td>
              </tr>
              <tr>
                <td colspan="2" class="text-right font-medium">Margin (%):</td>
                <td class="text-right">
                  <%= form.number_field :margin_percentage,
                      step: 0.01,
                      min: 0,
                      max: 100,
                      placeholder: "e.g., 10.5 for 10.5%",
                      class: "input input-sm input-bordered w-28 text-right",
                      data: {
                        line_item_rate_build_up_target: "marginInput",
                        action: "blur->line-item-rate-build-up#saveOnMarginBlur"
                      } %>
                </td>
                <td class="text-right font-semibold text-orange-600" data-line_item_rate_build_up_target="marginDisplay">
                  <%= "#{line_item_rate_build_up.margin_percentage}%" %>
                </td>
              </tr>
              <tr>
                <td colspan="3" class="text-right font-medium">Before Rounding:</td>
                <td class="text-right font-semibold text-purple-600" data-line-item-rate-build-up-target="beforeRounding">
                  <%= number_to_currency(line_item_rate_build_up.total_before_rounding, unit: "R ", precision: 2) %>
                </td>
              </tr>
              <tr class="bg-green-50">
                <td colspan="3" class="text-right font-bold text-lg">
                  Final Rate:
                  <span class="hidden text-warning" data-line_item_rate_build_up_target="totalDirtyIndicator">*</span>
                </td>
                <td class="text-right font-bold text-lg text-green-600" data-line-item-rate-build-up-target="roundedRate">
                  <%= number_to_currency(line_item_rate_build_up.rounded_rate, unit: "R ", precision: 2) %>
                </td>
              </tr>
            </tfoot>
          </table>

          <div class="mt-6 flex gap-2 items-center">
            <%= form.submit "Save & Calculate",
                class: "btn btn-primary btn-sm transition-colors",
                data: { line_item_rate_build_up_target: "saveButton" } %>
            <span class="hidden text-warning text-sm font-medium" data-line_item_rate_build_up_target="dirtyIndicator">
              <span class="text-warning font-bold">*</span> Unsaved changes
            </span>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
