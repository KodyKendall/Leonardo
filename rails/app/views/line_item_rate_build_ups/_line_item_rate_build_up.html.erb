<%= turbo_frame_tag dom_id(line_item_rate_build_up) do %>
  <div class="card bg-base-100 shadow" data-controller="line-item-rate-build-up">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h2 class="card-title text-xl">Rate Buildup</h2>
          <% if line_item_rate_build_up.tender_line_item.present? %>
            <p class="text-gray-600 text-sm">
              <span class="font-semibold"><%= line_item_rate_build_up.tender_line_item.item_number || "Item" %></span>
              — <%= line_item_rate_build_up.tender_line_item.item_description %>
            </p>
          <% end %>
        </div>
      </div>

      <% rate_components = [
        { name: "Material Supply", rate_field: :material_supply_rate, included_field: :material_supply_included },
        { name: "Fabrication", rate_field: :fabrication_rate, included_field: :fabrication_included },
        { name: "Overheads", rate_field: :overheads_rate, included_field: :overheads_included },
        { name: "Shop Priming", rate_field: :shop_priming_rate, included_field: :shop_priming_included },
        { name: "Onsite Painting", rate_field: :onsite_painting_rate, included_field: :onsite_painting_included },
        { name: "Delivery", rate_field: :delivery_rate, included_field: :delivery_included },
        { name: "Bolts", rate_field: :bolts_rate, included_field: :bolts_included },
        { name: "Erection", rate_field: :erection_rate, included_field: :erection_included },
        { name: "Crainage", rate_field: :crainage_rate, included_field: :crainage_included },
        { name: "Cherry Picker", rate_field: :cherry_picker_rate, included_field: :cherry_picker_included },
        { name: "Galvanizing", rate_field: :galvanizing_rate, included_field: :galvanizing_included }
      ] %>

      <%= form_with model: line_item_rate_build_up, 
                    local: true, 
                    id: "line_item_rate_build_up_form",
                    url: line_item_rate_build_up_path(line_item_rate_build_up),
                    method: :patch do |form| %>
        <div class="overflow-x-auto">
          <table class="table table-sm w-full">
            <thead>
              <tr class="bg-base-200">
                <th>Component</th>
                <th class="text-center">Included</th>
                <th class="text-right">Rate (R)</th>
                <th class="text-right">Amount (R)</th>
              </tr>
            </thead>
            <tbody>
              <% rate_components.each_with_index do |component, index| %>
                <% rate_value = line_item_rate_build_up.send(component[:rate_field]) || 0 %>
                <% is_included = line_item_rate_build_up.send(component[:included_field]) %>
                <% is_material_supply = index == 0 %>
                <tr class="hover:bg-base-200" data-line-item-rate-build-up-target="row">
                  <td class="font-medium">
                    <div class="flex items-center gap-1">
                      <%= component[:name] %>
                      <% if is_material_supply %>
                        <span class="badge badge-sm badge-info gap-1">
                          <i class="fas fa-bolt text-xs"></i>
                          Auto
                        </span>
                      <% end %>
                    </div>
                  </td>
                  <td class="text-center">
                    <%= form.check_box component[:included_field],
                        class: "checkbox checkbox-sm",
                        data: {
                          line_item_rate_build_up_target: "includedCheckbox",
                          action: "change->line-item-rate-build-up#calculate"
                        } %>
                  </td>
                  <td class="text-right">
                    <% if is_material_supply %>
                      <%= form.number_field component[:rate_field],
                          step: 0.01,
                          min: 0,
                          class: "input input-sm input-bordered w-28 text-right bg-gray-100 cursor-not-allowed opacity-75",
                          readonly: true,
                          data: {
                            line_item_rate_build_up_target: "rateInput"
                          } %>
                    <% else %>
                      <%= form.number_field component[:rate_field],
                          step: 0.01,
                          min: 0,
                          class: "input input-sm input-bordered w-28 text-right",
                          data: {
                            line_item_rate_build_up_target: "rateInput",
                            action: "input->line-item-rate-build-up#calculate"
                          } %>
                    <% end %>
                  </td>
                  <td class="text-right font-semibold" data-line-item-rate-build-up-target="amountCell">
                    <% if is_material_supply %>
                      <% material_supply_total = line_item_rate_build_up.tender_line_item.line_item_material_breakdown&.total || 0 %>
                      <span class="<%= 'text-gray-400' unless is_included %>">
                        <%= is_included ? number_to_currency(material_supply_total, unit: "R ", precision: 2) : "—" %>
                      </span>
                    <% else %>
                      <span class="<%= 'text-gray-400' unless is_included %>">
                        <%= is_included ? number_to_currency(rate_value, unit: "R ", precision: 2) : "—" %>
                      </span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
            <tfoot>
              <tr class="border-t-2 border-base-300">
                <td colspan="3" class="text-right font-bold">Subtotal:</td>
                <td class="text-right font-bold text-blue-600" data-line-item-rate-build-up-target="subtotal">
                  <%= number_to_currency(line_item_rate_build_up.subtotal, unit: "R ", precision: 2) %>
                </td>
              </tr>
              <tr>
                <td colspan="2" class="text-right font-medium">Margin (%):</td>
                <td class="text-right">
                  <%= form.number_field :margin_percentage,
                      step: 0.01,
                      min: 0,
                      max: 100,
                      placeholder: "e.g., 10.5 for 10.5%",
                      class: "input input-sm input-bordered w-28 text-right",
                      data: {
                        line_item_rate_build_up_target: "marginInput",
                        action: "input->line-item-rate-build-up#calculate blur->line-item-rate-build-up#saveOnMarginBlur"
                      } %>
                </td>
                <td class="text-right font-semibold text-orange-600" data-line-item-rate_build_up_target="marginDisplay">
                  <%= "#{line_item_rate_build_up.margin_percentage}%" %>
                </td>
              </tr>
              <tr>
                <td colspan="3" class="text-right font-medium">Before Rounding:</td>
                <td class="text-right font-semibold text-purple-600" data-line-item-rate-build-up-target="beforeRounding">
                  <%= number_to_currency(line_item_rate_build_up.total_before_rounding, unit: "R ", precision: 2) %>
                </td>
              </tr>
              <tr class="bg-green-50">
                <td colspan="3" class="text-right font-bold text-lg">Final Rate:</td>
                <td class="text-right font-bold text-lg text-green-600" data-line-item-rate-build-up-target="roundedRate">
                  <%= number_to_currency(line_item_rate_build_up.rounded_rate, unit: "R ", precision: 2) %>
                </td>
              </tr>
            </tfoot>
          </table>

          <div class="mt-6 flex gap-2 items-center">
            <%= form.submit "Save",
                class: "btn btn-primary btn-sm",
                data: { line_item_rate_build_up_target: "saveButton" } %>
            <span class="hidden text-warning text-sm font-medium" data-line-item-rate-build-up-target="dirtyIndicator">
              Unsaved changes
            </span>
            <% if line_item_rate_build_up.tender_line_item.present? %>
              <%= link_to "Back to Tender", tender_path(line_item_rate_build_up.tender_line_item.tender), class: "btn btn-ghost btn-sm" %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
