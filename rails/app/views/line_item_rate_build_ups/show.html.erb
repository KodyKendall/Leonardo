<% content_for :title, "Rate Buildup - #{@line_item_rate_build_up.tender_line_item.item_number}" %>

<div class="container mx-auto p-6">
  <% if notice.present? %>
    <div class="alert alert-success mb-6">
      <i class="fas fa-check-circle"></i>
      <span><%= notice %></span>
    </div>
  <% end %>

  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold">Rate Buildup</h1>
      <p class="text-gray-600 mt-2">
        <span class="font-semibold"><%= @line_item_rate_build_up.tender_line_item.item_number || "Item" %></span>
        — <%= @line_item_rate_build_up.tender_line_item.item_description %>
      </p>
    </div>
    <%= link_to "Back to Tender", tender_path(@line_item_rate_build_up.tender_line_item.tender), class: "btn btn-ghost" %>
  </div>

  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <form id="buildup-form">
        <div class="overflow-x-auto">
          <table class="table table-sm w-full">
            <thead>
              <tr>
                <th>Component / Material</th>
                <th>Included?</th>
                <th class="text-right">Price (₹)</th>
                <th class="text-right">Subtotal (₹)</th>
              </tr>
            </thead>
            <tbody id="buildup-tbody">
              <!-- Material Supply -->
              <tr class="buildup-row" data-field="material_supply">
                <td class="font-medium">Material Supply</td>
                <td>
                  <input type="checkbox" class="checkbox checkbox-sm included-checkbox" data-included-field="fabrication_included" <%= @line_item_rate_build_up.fabrication_included? ? 'checked' : '' %>>
                </td>
                <td class="text-right">
                  <input type="number" step="0.01" min="0" class="input input-sm input-bordered w-24 text-right price-input" data-price-field="material_supply_rate" value="<%= number_with_precision(@line_item_rate_build_up.material_supply_rate, precision: 2) %>">
                </td>
                <td class="text-right font-semibold subtotal-cell"><%= number_with_precision(@line_item_rate_build_up.material_supply_rate, precision: 2) %></td>
              </tr>

              <!-- Fabrication -->
              <tr class="buildup-row" data-field="fabrication">
                <td class="font-medium">Fabrication</td>
                <td>
                  <input type="checkbox" class="checkbox checkbox-sm included-checkbox" data-included-field="fabrication_included" <%= @line_item_rate_build_up.fabrication_included? ? 'checked' : '' %>>
                </td>
                <td class="text-right">
                  <input type="number" step="0.01" min="0" class="input input-sm input-bordered w-24 text-right price-input" data-price-field="fabrication_rate" value="<%= number_with_precision(@line_item_rate_build_up.fabrication_rate, precision: 2) %>">
                </td>
                <td class="text-right font-semibold subtotal-cell"><%= number_with_precision(@line_item_rate_build_up.fabrication_included? ? @line_item_rate_build_up.fabrication_rate : 0, precision: 2) %></td>
              </tr>

              <!-- Overheads -->
              <tr class="buildup-row" data-field="overheads">
                <td class="font-medium">Overheads</td>
                <td>
                  <input type="checkbox" class="checkbox checkbox-sm included-checkbox" data-included-field="overheads_included" <%= @line_item_rate_build_up.overheads_included? ? 'checked' : '' %>>
                </td>
                <td class="text-right">
                  <input type="number" step="0.01" min="0" class="input input-sm input-bordered w-24 text-right price-input" data-price-field="overheads_rate" value="<%= number_with_precision(@line_item_rate_build_up.overheads_rate, precision: 2) %>">
                </td>
                <td class="text-right font-semibold subtotal-cell"><%= number_with_precision(@line_item_rate_build_up.overheads_included? ? @line_item_rate_build_up.overheads_rate : 0, precision: 2) %></td>
              </tr>

              <!-- Shop Priming -->
              <tr class="buildup-row" data-field="shop_priming">
                <td class="font-medium">Shop Priming</td>
                <td>
                  <input type="checkbox" class="checkbox checkbox-sm included-checkbox" data-included-field="shop_priming_included" <%= @line_item_rate_build_up.shop_priming_included? ? 'checked' : '' %>>
                </td>
                <td class="text-right">
                  <input type="number" step="0.01" min="0" class="input input-sm input-bordered w-24 text-right price-input" data-price-field="shop_priming_rate" value="<%= number_with_precision(@line_item_rate_build_up.shop_priming_rate, precision: 2) %>">
                </td>
                <td class="text-right font-semibold subtotal-cell"><%= number_with_precision(@line_item_rate_build_up.shop_priming_included? ? @line_item_rate_build_up.shop_priming_rate : 0, precision: 2) %></td>
              </tr>

              <!-- Onsite Painting -->
              <tr class="buildup-row" data-field="onsite_painting">
                <td class="font-medium">Onsite Painting</td>
                <td>
                  <input type="checkbox" class="checkbox checkbox-sm included-checkbox" data-included-field="onsite_painting_included" <%= @line_item_rate_build_up.onsite_painting_included? ? 'checked' : '' %>>
                </td>
                <td class="text-right">
                  <input type="number" step="0.01" min="0" class="input input-sm input-bordered w-24 text-right price-input" data-price-field="onsite_painting_rate" value="<%= number_with_precision(@line_item_rate_build_up.onsite_painting_rate, precision: 2) %>">
                </td>
                <td class="text-right font-semibold subtotal-cell"><%= number_with_precision(@line_item_rate_build_up.onsite_painting_included? ? @line_item_rate_build_up.onsite_painting_rate : 0, precision: 2) %></td>
              </tr>

              <!-- Delivery -->
              <tr class="buildup-row" data-field="delivery">
                <td class="font-medium">Delivery</td>
                <td>
                  <input type="checkbox" class="checkbox checkbox-sm included-checkbox" data-included-field="delivery_included" <%= @line_item_rate_build_up.delivery_included? ? 'checked' : '' %>>
                </td>
                <td class="text-right">
                  <input type="number" step="0.01" min="0" class="input input-sm input-bordered w-24 text-right price-input" data-price-field="delivery_rate" value="<%= number_with_precision(@line_item_rate_build_up.delivery_rate, precision: 2) %>">
                </td>
                <td class="text-right font-semibold subtotal-cell"><%= number_with_precision(@line_item_rate_build_up.delivery_included? ? @line_item_rate_build_up.delivery_rate : 0, precision: 2) %></td>
              </tr>

              <!-- Bolts -->
              <tr class="buildup-row" data-field="bolts">
                <td class="font-medium">Bolts</td>
                <td>
                  <input type="checkbox" class="checkbox checkbox-sm included-checkbox" data-included-field="bolts_included" <%= @line_item_rate_build_up.bolts_included? ? 'checked' : '' %>>
                </td>
                <td class="text-right">
                  <input type="number" step="0.01" min="0" class="input input-sm input-bordered w-24 text-right price-input" data-price-field="bolts_rate" value="<%= number_with_precision(@line_item_rate_build_up.bolts_rate, precision: 2) %>">
                </td>
                <td class="text-right font-semibold subtotal-cell"><%= number_with_precision(@line_item_rate_build_up.bolts_included? ? @line_item_rate_build_up.bolts_rate : 0, precision: 2) %></td>
              </tr>

              <!-- Erection -->
              <tr class="buildup-row" data-field="erection">
                <td class="font-medium">Erection</td>
                <td>
                  <input type="checkbox" class="checkbox checkbox-sm included-checkbox" data-included-field="erection_included" <%= @line_item_rate_build_up.erection_included? ? 'checked' : '' %>>
                </td>
                <td class="text-right">
                  <input type="number" step="0.01" min="0" class="input input-sm input-bordered w-24 text-right price-input" data-price-field="erection_rate" value="<%= number_with_precision(@line_item_rate_build_up.erection_rate, precision: 2) %>">
                </td>
                <td class="text-right font-semibold subtotal-cell"><%= number_with_precision(@line_item_rate_build_up.erection_included? ? @line_item_rate_build_up.erection_rate : 0, precision: 2) %></td>
              </tr>

              <!-- Crainage -->
              <tr class="buildup-row" data-field="crainage">
                <td class="font-medium">Crainage</td>
                <td>
                  <input type="checkbox" class="checkbox checkbox-sm included-checkbox" data-included-field="crainage_included" <%= @line_item_rate_build_up.crainage_included? ? 'checked' : '' %>>
                </td>
                <td class="text-right">
                  <input type="number" step="0.01" min="0" class="input input-sm input-bordered w-24 text-right price-input" data-price-field="crainage_rate" value="<%= number_with_precision(@line_item_rate_build_up.crainage_rate, precision: 2) %>">
                </td>
                <td class="text-right font-semibold subtotal-cell"><%= number_with_precision(@line_item_rate_build_up.crainage_included? ? @line_item_rate_build_up.crainage_rate : 0, precision: 2) %></td>
              </tr>

              <!-- Cherry Picker -->
              <tr class="buildup-row" data-field="cherry_picker">
                <td class="font-medium">Cherry Picker</td>
                <td>
                  <input type="checkbox" class="checkbox checkbox-sm included-checkbox" data-included-field="cherry_picker_included" <%= @line_item_rate_build_up.cherry_picker_included? ? 'checked' : '' %>>
                </td>
                <td class="text-right">
                  <input type="number" step="0.01" min="0" class="input input-sm input-bordered w-24 text-right price-input" data-price-field="cherry_picker_rate" value="<%= number_with_precision(@line_item_rate_build_up.cherry_picker_rate, precision: 2) %>">
                </td>
                <td class="text-right font-semibold subtotal-cell"><%= number_with_precision(@line_item_rate_build_up.cherry_picker_included? ? @line_item_rate_build_up.cherry_picker_rate : 0, precision: 2) %></td>
              </tr>

              <!-- Galvanizing -->
              <tr class="buildup-row" data-field="galvanizing">
                <td class="font-medium">Galvanizing</td>
                <td>
                  <input type="checkbox" class="checkbox checkbox-sm included-checkbox" data-included-field="galvanizing_included" <%= @line_item_rate_build_up.galvanizing_included? ? 'checked' : '' %>>
                </td>
                <td class="text-right">
                  <input type="number" step="0.01" min="0" class="input input-sm input-bordered w-24 text-right price-input" data-price-field="galvanizing_rate" value="<%= number_with_precision(@line_item_rate_build_up.galvanizing_rate, precision: 2) %>">
                </td>
                <td class="text-right font-semibold subtotal-cell"><%= number_with_precision(@line_item_rate_build_up.galvanizing_included? ? @line_item_rate_build_up.galvanizing_rate : 0, precision: 2) %></td>
              </tr>
            </tbody>
          </table>
        </div>
      </form>

      <!-- Summary Section -->
      <div class="mt-8 pt-6 border-t border-gray-200">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="stat bg-base-100">
            <div class="stat-title text-sm">Subtotal</div>
            <div class="stat-value text-lg text-blue-600" id="display-subtotal">₹ <%= number_with_precision(@line_item_rate_build_up.subtotal, precision: 2) %></div>
          </div>
          <div class="stat bg-base-100">
            <div class="stat-title text-sm">Margin</div>
            <div class="stat-value text-lg text-orange-600" id="display-margin">₹ <%= number_with_precision(@line_item_rate_build_up.margin_amount, precision: 2) %></div>
          </div>
          <div class="stat bg-base-100">
            <div class="stat-title text-sm">Before Rounding</div>
            <div class="stat-value text-lg text-purple-600" id="display-before-rounding">₹ <%= number_with_precision(@line_item_rate_build_up.total_before_rounding, precision: 2) %></div>
          </div>
          <div class="stat bg-base-100 border-2 border-green-500">
            <div class="stat-title text-sm font-bold">Final Rate</div>
            <div class="stat-value text-lg text-green-600" id="display-rounded-rate">₹ <%= number_with_precision(@line_item_rate_build_up.rounded_rate, precision: 2) %></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="mt-6 flex gap-2 flex-wrap">
    <button id="save-btn" class="btn btn-primary gap-2" onclick="saveChanges()">
      <i class="fas fa-save"></i>
      Save Changes
    </button>
    <%= link_to "Back to Tender", tender_path(@line_item_rate_build_up.tender_line_item.tender), class: "btn btn-ghost" %>
  </div>
</div>

<script>
  const BUILDUP_ID = '<%= @line_item_rate_build_up.id %>';

  // Update table subtotals when price or checkbox changes
  document.querySelectorAll('.price-input, .included-checkbox').forEach(input => {
    input.addEventListener('change', updateTableSubtotals);
    input.addEventListener('input', updateTableSubtotals);
  });

  function updateTableSubtotals() {
    document.querySelectorAll('.buildup-row').forEach(row => {
      const priceInput = row.querySelector('.price-input');
      const checkbox = row.querySelector('.included-checkbox');
      const subtotalCell = row.querySelector('.subtotal-cell');
      
      if (priceInput && checkbox && subtotalCell) {
        const price = parseFloat(priceInput.value) || 0;
        const isIncluded = checkbox.checked;
        const subtotal = isIncluded ? price : 0;
        
        subtotalCell.textContent = subtotal.toFixed(2);
      }
    });
  }

  async function saveChanges() {
    const saveBtn = document.getElementById('save-btn');
    const originalHTML = saveBtn.innerHTML;
    
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    try {
      const updateData = {};
      
      document.querySelectorAll('.buildup-row').forEach(row => {
        const priceInput = row.querySelector('.price-input');
        const checkbox = row.querySelector('.included-checkbox');
        
        if (priceInput && checkbox) {
          const priceField = priceInput.getAttribute('data-price-field');
          const includedField = checkbox.getAttribute('data-included-field');
          
          updateData[priceField] = parseFloat(priceInput.value) || 0;
          updateData[includedField] = checkbox.checked;
        }
      });

      const response = await fetch(`/line_item_rate_build_ups/${BUILDUP_ID}.json`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        },
        body: JSON.stringify({ line_item_rate_build_up: updateData })
      });

      if (!response.ok) {
        const errorData = await response.json();
        showToast('Failed to save: ' + (errorData.error || 'Unknown error'), 'error');
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalHTML;
        return;
      }

      const data = await response.json();
      
      console.log('Response data:', data);
      
      // Update summary display
      if (data && data.subtotal !== undefined) {
        document.getElementById('display-subtotal').textContent = '₹ ' + parseFloat(data.subtotal).toFixed(2);
      }
      if (data && data.margin_amount !== undefined) {
        document.getElementById('display-margin').textContent = '₹ ' + parseFloat(data.margin_amount).toFixed(2);
      }
      if (data && data.total_before_rounding !== undefined) {
        document.getElementById('display-before-rounding').textContent = '₹ ' + parseFloat(data.total_before_rounding).toFixed(2);
      }
      if (data && data.rounded_rate !== undefined) {
        document.getElementById('display-rounded-rate').textContent = '₹ ' + parseFloat(data.rounded_rate).toFixed(2);
      }

      showToast('Changes saved successfully!', 'success');
    } catch (error) {
      console.error('Error saving changes:', error);
      showToast('Failed to save changes', 'error');
    } finally {
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalHTML;
    }
  }

  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} shadow-lg fixed top-4 right-4 z-50 flex items-center gap-2 max-w-sm`;
    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i><span>${message}</span>`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    document.body.appendChild(container);
    return container;
  }
</script>
