<%= turbo_frame_tag "line_item_rate_build_up_#{line_item_rate_build_up.id}" do %>
  <div class="card bg-base-100 shadow-md mb-4" data-controller="breakdown-editor" data-breakdown-type="rate-build-up">
    <!-- Header -->
    <div class="card-body pb-3">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="card-title text-lg font-bold">Rate Build-Up</h3>
          <span class="badge badge-info">Steel Sections</span>
        </div>
        <button type="button" class="btn btn-sm btn-ghost" data-action="breakdown-editor#toggleEditMode" data-edit-button>
          <i class="fas fa-edit"></i> Edit
        </button>
      </div>
    </div>

    <!-- Rate Items Table Header -->
    <div class="px-6 pb-2 border-t">
      <div class="grid grid-cols-12 gap-3 text-xs font-semibold text-gray-600 uppercase tracking-wide">
        <div class="col-span-5">Component</div>
        <div class="col-span-3">Rate</div>
        <div class="col-span-2">Included</div>
        <div class="col-span-2 text-right">Amount</div>
      </div>
    </div>

    <!-- Rate Items (Each Component) -->
    <div class="border-t">
      <% rate_components = [
        { label: "Material Supply", rate_field: :material_supply_rate, included_field: :material_supply_included },
        { label: "Fabrication", rate_field: :fabrication_rate, included_field: :fabrication_included },
        { label: "Overheads", rate_field: :overheads_rate, included_field: :overheads_included },
        { label: "Shop Priming", rate_field: :shop_priming_rate, included_field: :shop_priming_included },
        { label: "Onsite Painting", rate_field: :onsite_painting_rate, included_field: :onsite_painting_included },
        { label: "Delivery", rate_field: :delivery_rate, included_field: :delivery_included },
        { label: "Bolts", rate_field: :bolts_rate, included_field: :bolts_included },
        { label: "Erection", rate_field: :erection_rate, included_field: :erection_included },
        { label: "Crainage", rate_field: :crainage_rate, included_field: :crainage_included },
        { label: "Cherry Picker", rate_field: :cherry_picker_rate, included_field: :cherry_picker_included },
        { label: "Galvanizing", rate_field: :galvanizing_rate, included_field: :galvanizing_included }
      ] %>

      <% rate_components.each do |component| %>
        <% is_included = line_item_rate_build_up.send(component[:included_field]) %>
        <% rate_value = line_item_rate_build_up.send(component[:rate_field]).to_f %>
        <%= turbo_frame_tag "rate_item_#{line_item_rate_build_up.id}_#{component[:label].parameterize}" do %>
          <%= render 'line_item_rate_build_ups/rate_item_row', line_item_rate_build_up: line_item_rate_build_up, component: component, is_included: is_included, rate_value: rate_value %>
        <% end %>
      <% end %>
    </div>

    <!-- Totals Section -->
    <div id="rate_build_up_totals_<%= line_item_rate_build_up.id %>" class="px-6 py-4 bg-gray-50 border-t space-y-2">
      <div class="flex justify-between text-sm">
        <span class="font-semibold text-gray-700">SUBTOTAL:</span>
        <span class="font-semibold text-gray-900">R<%= number_with_precision(line_item_rate_build_up.subtotal, precision: 2) %></span>
      </div>

      <div class="flex justify-between text-sm">
        <span class="font-semibold text-gray-700">MARGIN %:</span>
        <form id="markup_form_<%= line_item_rate_build_up.id %>" 
              action="<%= line_item_rate_build_up_path(line_item_rate_build_up) %>" 
              method="patch"
              data-controller="markup-form" 
              class="inline"
              data-turbo="true">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <input type="number" 
                 name="line_item_rate_build_up[margin_percentage]" 
                 placeholder="0%" 
                 step="0.1" 
                 value="<%= line_item_rate_build_up.margin_percentage || 0 %>"
                 class="input input-bordered input-xs w-24 text-right" 
                 data-action="blur->markup-form#saveOnBlur"
                 data-markup-form-target="input" />
        </form>
      </div>

      <div class="flex justify-between text-lg font-bold border-t pt-2">
        <span class="text-gray-900">TOTAL:</span>
        <span class="text-blue-600">R<%= number_with_precision(line_item_rate_build_up.rounded_rate, precision: 2) %></span>
      </div>
    </div>
  </div>
<% end %>
