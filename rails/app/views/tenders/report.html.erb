<% content_for :title, "Tender Report - #{@tender.e_number}" %>

<%
  # Configuration
  items_per_first_page = 18
  items_per_subsequent_page = 25

  # Calculate line total helper
  def calculate_line_total(item)
    rate = item.line_item_rate_build_up&.rounded_rate || item.rate || 0
    item.quantity * rate
  end

  # Group items into pages
  all_items = @line_items.to_a
  pages = []
  remaining_items = all_items.dup
  page_num = 1
  running_total = BigDecimal("0")

  while remaining_items.any?
    items_this_page = page_num == 1 ? items_per_first_page : items_per_subsequent_page
    page_items = remaining_items.shift(items_this_page)

    brought_forward = running_total if page_num > 1
    page_total = page_items.reject(&:is_heading).sum { |item| calculate_line_total(item) }
    running_total += page_total

    pages << {
      number: page_num,
      items: page_items,
      brought_forward: brought_forward,
      page_total: page_total,
      carried_forward: running_total
    }
    page_num += 1
  end

  # Handle empty tenders
  if pages.empty?
    pages << { number: 1, items: [], brought_forward: nil, page_total: 0, carried_forward: 0 }
  end

  # Calculate totals
  p_and_g_total = @p_and_g_items.sum { |item| item.quantity * item.rate }
  line_items_subtotal = running_total
  grand_total = line_items_subtotal + @shop_drawings_total + p_and_g_total

  # Expiration date
  expiration_date = @tender.submission_deadline || (@tender.created_at + 30.days)
%>

<% pages.each_with_index do |page_data, index| %>
<div class="page w-[7.7in] min-h-[10in] mx-auto mb-5 bg-white p-0 flex flex-col shadow-lg print:shadow-none">

  <!-- Header -->
  <div class="flex justify-between items-end pb-2 border-b-2 border-rsb-blue mb-2">
    <%= image_tag "RSB-Logo.png", class: "h-16 w-auto object-contain", alt: "RSB Logo" %>
    <div class="text-rsb-light text-[28pt] font-normal italic tracking-wider">TENDER</div>
  </div>

  <!-- Tender Info -->
  <div class="flex justify-between mb-2">
    <div class="flex-1">
      <p class="text-[9pt] my-0.5"><span class="font-bold text-rsb-blue">PROJECT:</span> <%= @tender.tender_name %></p>
      <p class="text-[9pt] my-0.5"><span class="font-bold text-rsb-blue">CLIENT:</span> <%= @tender.display_client_name %></p>
    </div>
    <div class="text-right text-[9pt]">
      <table class="ml-auto">
        <tr><td class="text-gray-500 pr-2 text-right">Date:</td><td><%= @tender.created_at.strftime("%B %d, %Y") %></td></tr>
        <tr><td class="text-gray-500 pr-2 text-right">Tender#:</td><td><%= @tender.e_number || "INSERT" %></td></tr>
        <tr><td class="text-gray-500 pr-2 text-right">Expiration:</td><td><%= expiration_date.strftime("%B %d, %Y") %></td></tr>
        <tr><td class="text-gray-500 pr-2 text-right">Page:</td><td><%= page_data[:number] %></td></tr>
        <tr><td class="text-gray-500 pr-2 text-right">Contact:</td><td>072 575 7766</td></tr>
        <tr><td></td><td class="text-blue-600">rspencer@rsbcontracts.com</td></tr>
      </table>
    </div>
  </div>

  <!-- Line Items Table -->
  <table class="w-full border-collapse text-[8pt] flex-1">
    <thead>
      <% if page_data[:brought_forward] %>
      <tr class="bg-amber-50">
        <th colspan="5" class="border border-gray-300 px-1.5 py-1 text-left font-bold">Brought Forward:</th>
        <th class="border border-gray-300 px-1.5 py-1 text-right w-[14%]"></th>
        <th class="border border-gray-300 px-1.5 py-1 text-right w-[16%] font-bold"><span class="currency"><%= number_with_delimiter(page_data[:brought_forward].round(2), delimiter: ",") %></span></th>
      </tr>
      <% end %>
      <tr class="bg-gray-100">
        <th class="border border-gray-300 px-1.5 py-1 text-center w-[6%]">Page</th>
        <th class="border border-gray-300 px-1.5 py-1 text-center w-[6%]">Item</th>
        <th class="border border-gray-300 px-1.5 py-1 text-left w-[44%]">Description</th>
        <th class="border border-gray-300 px-1.5 py-1 text-center w-[6%]">Unit</th>
        <th class="border border-gray-300 px-1.5 py-1 text-right w-[8%]">Qty</th>
        <th class="border border-gray-300 px-1.5 py-1 text-right w-[14%]">Rate</th>
        <th class="border border-gray-300 px-1.5 py-1 text-right w-[16%]">Line Total</th>
      </tr>
    </thead>
    <tbody>
      <% page_data[:items].each do |item| %>
        <% if item.is_heading %>
          <tr class="bg-blue-50">
            <td class="border border-gray-200 px-1.5 py-1.5 text-center"></td>
            <td class="border border-gray-200 px-1.5 py-1.5 text-center"></td>
            <td class="border border-gray-200 px-1.5 py-1.5 font-bold text-rsb-blue" colspan="5"><%= item.item_description %></td>
          </tr>
        <% else %>
          <% rate = item.line_item_rate_build_up&.rounded_rate || item.rate || 0 %>
          <% line_total = item.quantity * rate %>
          <tr class="even:bg-gray-50">
            <td class="border border-gray-200 px-1.5 py-1 text-center align-top"><%= item.page_number %></td>
            <td class="border border-gray-200 px-1.5 py-1 text-center align-top"><%= item.item_number %></td>
            <td class="border border-gray-200 px-1.5 py-1 align-top"><%= item.item_description %></td>
            <td class="border border-gray-200 px-1.5 py-1 text-center align-top"><%= item.unit_of_measure %></td>
            <td class="border border-gray-200 px-1.5 py-1 text-right align-top"><%= number_with_precision(item.quantity, precision: 2, delimiter: ",") %></td>
            <td class="border border-gray-200 px-1.5 py-1 text-right align-top">
              <% if rate > 0 %><span class="currency"><%= number_with_delimiter(rate.round(2), delimiter: ",") %></span><% else %>-<% end %>
            </td>
            <td class="border border-gray-200 px-1.5 py-1 text-right align-top">
              <% if line_total > 0 %>
                <span class="currency"><%= number_with_delimiter(line_total.round(2), delimiter: ",") %></span>
              <% elsif item.notes.present? && item.notes.downcase.include?("included") %>
                <span class="text-gray-500 text-[7pt]">INCLUDED IN RATES</span>
              <% else %>-<% end %>
            </td>
          </tr>
        <% end %>
      <% end %>

      <% if index < pages.length - 1 %>
        <!-- Carried Forward -->
        <tr class="bg-amber-50">
          <td colspan="5" class="border border-gray-300 px-1.5 py-1.5 text-right font-bold italic border-t-2 border-t-gray-500">Carried Forward:</td>
          <td class="border border-gray-300 px-1.5 py-1.5 border-t-2 border-t-gray-500"></td>
          <td class="border border-gray-300 px-1.5 py-1.5 text-right font-bold italic border-t-2 border-t-gray-500"><span class="currency"><%= number_with_delimiter(page_data[:carried_forward].round(2), delimiter: ",") %></span></td>
        </tr>
      <% else %>
        <!-- Line Items Subtotal -->
        <tr class="bg-gray-100">
          <td colspan="5" class="border border-gray-300 px-1.5 py-1.5 text-right font-bold border-t-2 border-t-gray-500">Line Items Sub Total:</td>
          <td class="border border-gray-300 px-1.5 py-1.5 border-t-2 border-t-gray-500"></td>
          <td class="border border-gray-300 px-1.5 py-1.5 text-right font-bold border-t-2 border-t-gray-500"><span class="currency"><%= number_with_delimiter(line_items_subtotal.round(2), delimiter: ",") %></span></td>
        </tr>

        <% if @shop_drawings_total > 0 %>
        <tr>
          <td colspan="5" class="border border-gray-200 px-1.5 py-1 text-right">Shop Drawings:</td>
          <td class="border border-gray-200 px-1.5 py-1"></td>
          <td class="border border-gray-200 px-1.5 py-1 text-right"><span class="currency"><%= number_with_delimiter(@shop_drawings_total.round(2), delimiter: ",") %></span></td>
        </tr>
        <% end %>

        <% if @p_and_g_items.any? %>
        <tr>
          <td colspan="7" class="bg-blue-100 px-2 py-1 font-bold text-[9pt] text-rsb-blue uppercase border-l-4 border-l-rsb-blue">PRELIMINARIES & GENERALS</td>
        </tr>
        <% @p_and_g_items.each do |pg_item| %>
        <tr class="even:bg-gray-50">
          <td class="border border-gray-200 px-1.5 py-1 text-center">-</td>
          <td class="border border-gray-200 px-1.5 py-1 text-center">P&G</td>
          <td class="border border-gray-200 px-1.5 py-1"><%= pg_item.description %></td>
          <td class="border border-gray-200 px-1.5 py-1 text-center"><%= pg_item.category&.humanize %></td>
          <td class="border border-gray-200 px-1.5 py-1 text-right"><%= number_with_precision(pg_item.quantity, precision: 2, delimiter: ",") %></td>
          <td class="border border-gray-200 px-1.5 py-1 text-right"><span class="currency"><%= number_with_delimiter(pg_item.rate.round(2), delimiter: ",") %></span></td>
          <td class="border border-gray-200 px-1.5 py-1 text-right"><span class="currency"><%= number_with_delimiter((pg_item.quantity * pg_item.rate).round(2), delimiter: ",") %></span></td>
        </tr>
        <% end %>
        <tr class="bg-gray-100">
          <td colspan="5" class="border border-gray-300 px-1.5 py-1.5 text-right font-bold border-t-2 border-t-gray-500">P&G Sub Total:</td>
          <td class="border border-gray-300 px-1.5 py-1.5 border-t-2 border-t-gray-500"></td>
          <td class="border border-gray-300 px-1.5 py-1.5 text-right font-bold border-t-2 border-t-gray-500"><span class="currency"><%= number_with_delimiter(p_and_g_total.round(2), delimiter: ",") %></span></td>
        </tr>
        <% end %>

        <!-- Grand Total -->
        <tr class="bg-rsb-blue text-white">
          <td colspan="5" class="px-1.5 py-2 text-right font-bold text-[10pt]">Sub Total :</td>
          <td class="px-1.5 py-2 text-right font-bold text-[10pt]">R</td>
          <td class="px-1.5 py-2 text-right font-bold text-[10pt]"><%= number_with_delimiter(grand_total.round(2), delimiter: ",") %></td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <!-- Footer -->
  <div class="mt-auto pt-2 border-t border-gray-300 text-[7pt] text-gray-500">
    <p class="italic mb-1.5">This Tender is Subject to the conditions noted in our standard tender qualifications:</p>
    <div class="flex justify-between items-center pt-1 border-t border-rsb-blue">
      <div class="font-bold text-gray-700">RSB Directors: R. Spencer, R. Swart, J. Barnard</div>
      <div class="text-center flex-1">087 711 0657 | info@rsbcontracts.com | www.rsbcontracts.com</div>
      <div class="text-right">2 Newgold Street, Comet, Boksburg | P.O. Box 6665, Dunswart, 1508</div>
    </div>
    <div class="text-right text-[8pt] text-gray-500 mt-1">Page <%= page_data[:number] %></div>
  </div>
</div>
<% end %>
