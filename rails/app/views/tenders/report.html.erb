<% content_for :title, "Tender Report - #{@tender.e_number}" %>

<!-- Action Bar (Hidden on Print) -->
<div class="no-print sticky top-0 z-50 bg-white border-b border-gray-200 px-4 py-3 mb-6 shadow-sm flex justify-between items-center">
  <div class="flex items-center gap-4">
    <%= link_to tender_path(@tender), class: "text-gray-600 hover:text-gray-900 flex items-center gap-2" do %>
      <i class="fa-solid fa-arrow-left"></i> Back to Tender
    <% end %>
    <h1 class="text-xl font-bold text-gray-800">Tender Report Preview: <%= @tender.e_number %></h1>
    
    <!-- Report Options Form -->
    <div class="flex items-center gap-4 border-l border-gray-200 pl-4 ml-2">
      <%= form_with model: @tender, url: tender_path(@tender), method: :patch, data: { turbo_frame: "report_preview" }, class: "flex items-center gap-3" do |f| %>
        <%= hidden_field_tag :source, 'report' %>
        <div class="flex items-center gap-2">
          <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider whitespace-nowrap">P&G Display:</label>
          <%= f.select :p_and_g_display_mode, Tender::PG_DISPLAY_MODES, {}, { onchange: "this.form.requestSubmit()", class: "select select-bordered select-xs" } %>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider whitespace-nowrap">Shop Drawings:</label>
          <%= f.select :shop_drawings_display_mode, Tender::SHOP_DRAWINGS_DISPLAY_MODES, {}, { onchange: "this.form.requestSubmit()", class: "select select-bordered select-xs" } %>
        </div>
      <% end %>
    </div>
  </div>
  <div class="flex gap-2">
    <button onclick="window.print()" class="rounded-md px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium inline-flex items-center gap-2">
      <i class="fa-solid fa-print"></i> Browser Print
    </button>
    <%= link_to report_tender_path(@tender, format: :pdf), class: "rounded-md px-4 py-2 bg-red-600 hover:bg-red-500 text-white font-medium inline-flex items-center gap-2" do %>
      <i class="fa-solid fa-file-pdf"></i> Download PDF
    <% end %>
  </div>
</div>

<%= turbo_frame_tag "report_preview" do %>
  <%
    # Calculate line total helper
    def calculate_line_total(item)
      rate = item.line_item_rate_build_up&.rounded_rate || item.rate || 0
      item.quantity * rate
    end

    # Calculate totals
    p_and_g_total = @p_and_g_items.sum { |item| item.quantity * item.rate }
    line_items_subtotal = @line_items.reject(&:is_heading).sum { |item| calculate_line_total(item) }
    grand_total = line_items_subtotal + @shop_drawings_total + p_and_g_total

    # Expiration date
    expiration_date = @tender.submission_deadline || (@tender.created_at + 30.days)
  %>

  <div class="page w-[7.7in] mx-auto bg-white p-0 shadow-lg print:shadow-none">
  <table class="w-full border-collapse text-[8pt]">
    <thead>
      <!-- Main Header (Repeats on every page in PDF) -->
      <tr>
        <th colspan="7" class="text-left font-normal p-0 border-none">
          <div class="flex justify-between items-end pb-2 border-b-2 border-rsb-blue mb-2">
            <%= image_tag "RSB-Logo.png", class: "h-16 w-auto object-contain", alt: "RSB Logo" %>
            <div class="text-rsb-light text-[28pt] font-normal italic tracking-wider">TENDER</div>
          </div>

          <div class="flex justify-between mb-2">
            <div class="flex-1">
              <p class="text-[9pt] my-0.5"><span class="font-bold text-rsb-blue">PROJECT:</span> <%= @tender.tender_name %></p>
              <p class="text-[9pt] my-0.5"><span class="font-bold text-rsb-blue">CLIENT:</span> <%= @tender.display_client_name %></p>
            </div>
            <div class="text-right text-[9pt]">
              <table class="ml-auto">
                <tr><td class="text-gray-500 pr-2 text-right font-normal">Date:</td><td class="font-normal"><%= @tender.created_at.strftime("%B %d, %Y") %></td></tr>
                <tr><td class="text-gray-500 pr-2 text-right font-normal">Tender#:</td><td class="font-normal"><%= @tender.e_number || "INSERT" %></td></tr>
                <tr><td class="text-gray-500 pr-2 text-right font-normal">Expiration:</td><td class="font-normal"><%= expiration_date.strftime("%B %d, %Y") %></td></tr>
                <tr><td class="text-gray-500 pr-2 text-right font-normal">Contact:</td><td class="font-normal">072 575 7766</td></tr>
                <tr><td></td><td class="text-blue-600 font-normal">rspencer@rsbcontracts.com</td></tr>
              </table>
            </div>
          </div>
        </th>
      </tr>
      
      <!-- Table Headers -->
      <tr class="bg-gray-100">
        <th class="border border-gray-300 px-1.5 py-1 text-center w-[6%]">Page</th>
        <th class="border border-gray-300 px-1.5 py-1 text-center w-[6%]">Item</th>
        <th class="border border-gray-300 px-1.5 py-1 text-left w-[44%]">Description</th>
        <th class="border border-gray-300 px-1.5 py-1 text-center w-[6%]">Unit</th>
        <th class="border border-gray-300 px-1.5 py-1 text-right w-[8%]">Qty</th>
        <th class="border border-gray-300 px-1.5 py-1 text-right w-[14%]">Rate</th>
        <th class="border border-gray-300 px-1.5 py-1 text-right w-[16%]">Line Total</th>
      </tr>
    </thead>

    <tbody>
      <!-- 1. PRELIMINARIES & GENERALS (P&Gs) -->
      <% if @p_and_g_items.any? %>
        <tr>
          <td colspan="7" class="bg-blue-100 px-2 py-1 font-bold text-[9pt] text-rsb-blue uppercase border-l-4 border-l-rsb-blue">PRELIMINARIES & GENERALS</td>
        </tr>
        
        <% if @tender.p_and_g_display_mode == 'rolled_up' %>
          <tr class="even:bg-gray-50">
            <td class="border border-gray-200 px-1.5 py-1 text-center">-</td>
            <td class="border border-gray-200 px-1.5 py-1 text-center">P&G</td>
            <td class="border border-gray-200 px-1.5 py-1" colspan="4">Preliminaries & Generals (Rolled-up)</td>
            <td class="border border-gray-200 px-1.5 py-1 text-right font-bold"><span class="currency"><%= number_with_delimiter(p_and_g_total.round(2), delimiter: ",") %></span></td>
          </tr>
        <% else %>
          <% @p_and_g_items.each do |pg_item| %>
            <tr class="even:bg-gray-50">
              <td class="border border-gray-200 px-1.5 py-1 text-center">-</td>
              <td class="border border-gray-200 px-1.5 py-1 text-center">P&G</td>
              <td class="border border-gray-200 px-1.5 py-1"><%= pg_item.description %></td>
              <td class="border border-gray-200 px-1.5 py-1 text-center"><%= pg_item.category&.humanize %></td>
              <td class="border border-gray-200 px-1.5 py-1 text-right"><%= number_with_precision(pg_item.quantity, precision: 2, delimiter: ",") %></td>
              <td class="border border-gray-200 px-1.5 py-1 text-right"><span class="currency"><%= number_with_delimiter(pg_item.rate.round(2), delimiter: ",") %></span></td>
              <td class="border border-gray-200 px-1.5 py-1 text-right"><span class="currency"><%= number_with_delimiter((pg_item.quantity * pg_item.rate).round(2), delimiter: ",") %></span></td>
            </tr>
          <% end %>
          <tr class="bg-gray-100">
            <td colspan="5" class="border border-gray-300 px-1.5 py-1.5 text-right font-bold border-t-2 border-t-gray-500">P&G Sub Total:</td>
            <td class="border border-gray-300 px-1.5 py-1.5 border-t-2 border-t-gray-500"></td>
            <td class="border border-gray-300 px-1.5 py-1.5 text-right font-bold border-t-2 border-t-gray-500"><span class="currency"><%= number_with_delimiter(p_and_g_total.round(2), delimiter: ",") %></span></td>
          </tr>
        <% end %>
      <% end %>

      <!-- 2. SHOP DRAWINGS -->
      <% if @shop_drawings_total > 0 %>
        <tr class="bg-blue-50">
          <td class="border border-gray-200 px-1.5 py-1.5 text-center"></td>
          <td class="border border-gray-200 px-1.5 py-1.5 text-center"></td>
          <td class="border border-gray-200 px-1.5 py-1.5 font-bold text-rsb-blue" colspan="5">SHOP DRAWINGS</td>
        </tr>
        <tr>
          <td class="border border-gray-200 px-1.5 py-1 text-center">-</td>
          <td class="border border-gray-200 px-1.5 py-1 text-center">SD</td>
          <td class="border border-gray-200 px-1.5 py-1">Shop Drawings & 3D Modeling</td>
          
          <% if @tender.shop_drawings_display_mode == 'tonnage_rate' %>
            <% 
              sd_tonnes = @tender.project_rate_buildup&.shop_drawings_tonnes_for_calculation || 0
              sd_rate = @tender.project_rate_buildup&.shop_drawings_rate || 0
            %>
            <td class="border border-gray-200 px-1.5 py-1 text-center">t</td>
            <td class="border border-gray-200 px-1.5 py-1 text-right"><%= number_with_precision(sd_tonnes, precision: 2, delimiter: ",") %></td>
            <td class="border border-gray-200 px-1.5 py-1 text-right"><span class="currency"><%= number_with_delimiter(sd_rate.round(2), delimiter: ",") %></span></td>
          <% else %>
            <td class="border border-gray-200 px-1.5 py-1 text-center">Sum</td>
            <td class="border border-gray-200 px-1.5 py-1 text-right">1.00</td>
            <td class="border border-gray-200 px-1.5 py-1 text-right"><span class="currency"><%= number_with_delimiter(@shop_drawings_total.round(2), delimiter: ",") %></span></td>
          <% end %>
          <td class="border border-gray-200 px-1.5 py-1 text-right"><span class="currency"><%= number_with_delimiter(@shop_drawings_total.round(2), delimiter: ",") %></span></td>
        </tr>
      <% end %>

      <!-- 3. LINE ITEMS -->
      <% @line_items.each do |item| %>
        <% if item.is_heading %>
          <tr class="bg-blue-50">
            <td class="border border-gray-200 px-1.5 py-1.5 text-center"></td>
            <td class="border border-gray-200 px-1.5 py-1.5 text-center"></td>
            <td class="border border-gray-200 px-1.5 py-1.5 font-bold text-rsb-blue text-center" colspan="5"><%= item.item_description %></td>
          </tr>
        <% else %>
          <% rate = item.line_item_rate_build_up&.rounded_rate || item.rate || 0 %>
          <% line_total = item.quantity * rate %>
          <tr class="even:bg-gray-50">
            <td class="border border-gray-200 px-1.5 py-1 text-center align-top"><%= item.page_number %></td>
            <td class="border border-gray-200 px-1.5 py-1 text-center align-top"><%= item.item_number %></td>
            <td class="border border-gray-200 px-1.5 py-1 align-top"><%= item.item_description %></td>
            <td class="border border-gray-200 px-1.5 py-1 text-center align-top"><%= item.unit_of_measure %></td>
            <td class="border border-gray-200 px-1.5 py-1 text-right align-top"><%= number_with_precision(item.quantity, precision: 2, delimiter: ",") %></td>
            <td class="border border-gray-200 px-1.5 py-1 text-right align-top">
              <% if rate > 0 %><span class="currency"><%= number_with_delimiter(rate.round(2), delimiter: ",") %></span><% else %>-<% end %>
            </td>
            <td class="border border-gray-200 px-1.5 py-1 text-right align-top">
              <% if line_total > 0 %>
                <span class="currency"><%= number_with_delimiter(line_total.round(2), delimiter: ",") %></span>
              <% elsif item.notes.present? && item.notes.downcase.include?("included") %>
                <span class="text-gray-500 text-[7pt]">INCLUDED IN RATES</span>
              <% else %>-<% end %>
            </td>
          </tr>
        <% end %>
      <% end %>

      <!-- Line Items Subtotal -->
      <tr class="bg-gray-100">
        <td colspan="5" class="border border-gray-300 px-1.5 py-1.5 text-right font-bold border-t-2 border-t-gray-500">Line Items Sub Total:</td>
        <td class="border border-gray-300 px-1.5 py-1.5 border-t-2 border-t-gray-500"></td>
        <td class="border border-gray-300 px-1.5 py-1.5 text-right font-bold border-t-2 border-t-gray-500"><span class="currency"><%= number_with_delimiter(line_items_subtotal.round(2), delimiter: ",") %></span></td>
      </tr>

      <!-- Grand Total -->
      <tr class="bg-rsb-blue text-white">
        <td colspan="5" class="px-1.5 py-2 text-right font-bold text-[10pt]">Sub Total :</td>
        <td class="px-1.5 py-2 text-right font-bold text-[10pt]">R</td>
        <td class="px-1.5 py-2 text-right font-bold text-[10pt]"><%= number_with_delimiter(grand_total.round(2), delimiter: ",") %></td>
      </tr>
    </tbody>

    <tfoot>
      <tr>
        <td colspan="7" class="pt-8 border-none">
          <div class="pt-2 border-t border-gray-300 text-[7pt] text-gray-500">
            <p class="italic mb-1.5">This Tender is Subject to the conditions noted in our standard tender qualifications:</p>
            <div class="flex justify-between items-center pt-1 border-t border-rsb-blue">
              <div class="font-bold text-gray-700">RSB Directors: R. Spencer, R. Swart</div>
              <div class="text-center flex-1">087 711 0657 | info@rsbcontracts.com | www.rsbcontracts.com</div>
              <div class="text-right">2 Newgold Street, Comet, Boksburg | P.O. Box 6665, Dunswart, 1508</div>
            </div>
            <div class="text-right text-[8pt] text-gray-500 mt-1">Page <span class="page-number"></span></div>
          </div>
        </td>
      </tr>
    </tfoot>
  </table>
</div>
<% end %>
