<% content_for :title, "Tender Builder - #{@tender.tender_name}" %>

<div class="container mx-auto p-6">
  <!-- Header Section -->
  <turbo-frame id="builder_header">
    <%= render "builder_header", tender: @tender %>
  </turbo-frame>

  <!-- Main Builder Layout: Workspace + Summary -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
    
    <!-- Left: Line Items Workspace (2 columns wide on desktop) -->
    <div class="lg:col-span-2">
      <div class="card bg-base-100 shadow">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="card-title mb-0">
              <i class="fas fa-list"></i>
              Line Items
              <span id="line_items_count" class="badge badge-lg"><%= @line_items.size %></span>
            </h2>
            
            <%= link_to new_tender_tender_line_item_path(@tender),
                        class: "btn btn-sm btn-primary gap-2",
                        data: { turbo_frame: "new_line_item_form" } do %>
              <i class="fas fa-plus"></i>
              Add Line Item
            <% end %>
          </div>

          <!-- New/Edit Form Frame -->
          <turbo-frame id="new_line_item_form" class="mb-4"></turbo-frame>

          <!-- Line Items List -->
          <div id="line_items" class="space-y-3">
            <%= render partial: "tender_line_items/line_item",
                       collection: @line_items,
                       as: :line_item %>
          </div>

          <!-- Empty State -->
          <% if @line_items.empty? %>
            <div class="alert alert-info mt-4">
              <i class="fas fa-info-circle"></i>
              <div>No line items yet. Click "Add Line Item" to get started.</div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Right: Summary Panel (1 column) -->
    <aside class="lg:col-span-1">
      <turbo-frame id="builder_summary">
        <%= render "builder_summary", tender: @tender %>
      </turbo-frame>
    </aside>
  </div>

  <!-- Inclusions & Exclusions Section -->
  <div class="card bg-base-100 shadow mt-6">
    <div class="card-body">
      <h2 class="card-title mb-6">
        <i class="fas fa-check-square"></i>
        Inclusions & Exclusions
      </h2>

      <div id="inclusions-container" class="space-y-3">
        <!-- Fabrication Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Fabrication Included?</span>
            <span class="text-xs text-gray-500">Labour and manufacturing</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="fabrication_included"
            <%= @tender.tender_inclusions_exclusion&.fabrication_included ? 'checked' : '' %>
          >
        </label>

        <!-- Overheads Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Overheads Included?</span>
            <span class="text-xs text-gray-500">Administrative and indirect costs</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="overheads_included"
            <%= @tender.tender_inclusions_exclusion&.overheads_included ? 'checked' : '' %>
          >
        </label>

        <!-- Primer Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Primer Included in Line Item Rate?</span>
            <span class="text-xs text-gray-500">Base coating</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="primer_included"
            <%= @tender.tender_inclusions_exclusion&.primer_included ? 'checked' : '' %>
          >
        </label>

        <!-- Final Paint Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Final Paint Included in Line Item Rate?</span>
            <span class="text-xs text-gray-500">Finish coating</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="final_paint_included"
            <%= @tender.tender_inclusions_exclusion&.final_paint_included ? 'checked' : '' %>
          >
        </label>

        <!-- Delivery Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Delivery Included?</span>
            <span class="text-xs text-gray-500">Transportation to site</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="delivery_included"
            <%= @tender.tender_inclusions_exclusion&.delivery_included ? 'checked' : '' %>
          >
        </label>

        <!-- Bolts Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Bolts Included in Line Item Rate?</span>
            <span class="text-xs text-gray-500">Fasteners and hardware</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="bolts_included"
            <%= @tender.tender_inclusions_exclusion&.bolts_included ? 'checked' : '' %>
          >
        </label>

        <!-- Erection Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Erection Included in Line Item Rate?</span>
            <span class="text-xs text-gray-500">Assembly and installation</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="erection_included"
            <%= @tender.tender_inclusions_exclusion&.erection_included ? 'checked' : '' %>
          >
        </label>

        <!-- Crainage Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Crainage Included in Line Item Rate?</span>
            <span class="text-xs text-gray-500">Crane operations</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="crainage_included"
            <%= @tender.tender_inclusions_exclusion&.crainage_included ? 'checked' : '' %>
          >
        </label>

        <!-- Cherry Pickers Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Cherry Pickers Included in Line Item Rate?</span>
            <span class="text-xs text-gray-500">Aerial work platforms</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="cherry_pickers_included"
            <%= @tender.tender_inclusions_exclusion&.cherry_pickers_included ? 'checked' : '' %>
          >
        </label>

        <!-- Steel Galvanized -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Is the Steel Galvanized?</span>
            <span class="text-xs text-gray-500">Hot-dip galvanized finish</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="steel_galvanized"
            <%= @tender.tender_inclusions_exclusion&.steel_galvanized ? 'checked' : '' %>
          >
        </label>
      </div>

      <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
        <span id="save-status" class="text-sm text-gray-500"></span>
        <button 
          id="save-ie-btn" 
          class="btn btn-sm btn-primary gap-2"
          onclick="saveInclusionsExclusions()"
        >
          <i class="fas fa-save"></i>
          Save Changes
        </button>
      </div>
    </div>
  </div>

  <!-- Linked BOQ Section -->
  <% if @tender.boqs.any? %>
    <div class="card bg-base-100 shadow mt-6">
      <div class="card-body">
        <div class="flex justify-between items-center mb-4">
          <h2 class="card-title mb-0">
            <i class="fas fa-cube"></i>
            Linked BOQ Items
            <span id="boq-items-count" class="badge badge-lg"><%= @tender.boqs.first.boq_items.count %></span>
          </h2>
          <button 
            id="mirror-boq-btn"
            class="btn btn-sm btn-success gap-2"
            onclick="mirrorBoqItemsToLineItems()"
          >
            <i class="fas fa-copy"></i>
            Mirror to Line Items
          </button>
        </div>

        <div id="boq-items-container">
          <div class="overflow-x-auto">
            <table class="table table-sm w-full">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Item Number</th>
                  <th>Description</th>
                  <th>Unit</th>
                  <th>Quantity</th>
                  <th>Category</th>
                </tr>
              </thead>
              <tbody>
                <% @tender.boqs.first.boq_items.order(:sequence_order).each_with_index do |item, idx| %>
                  <tr>
                    <td><%= idx + 1 %></td>
                    <td class="font-semibold"><%= item.item_number %></td>
                    <td><%= truncate(item.item_description, length: 50) %></td>
                    <td><%= item.unit_of_measure %></td>
                    <td class="font-semibold"><%= number_with_precision(item.quantity, precision: 3) %></td>
                    <td><span class="badge"><%= item.section_category %></span></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="mt-6 flex gap-2">
    <%= link_to "Edit Tender Details", edit_tender_path(@tender), class: "btn btn-ghost", data: { turbo_visit_control: "reload" } %>
    <%= link_to "Back to Tenders", tenders_path, class: "btn btn-ghost" %>
  </div>
</div>

<script>
  const TENDER_ID = '<%= @tender.id %>';

  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} shadow-lg fixed top-4 right-4 z-50 flex items-center gap-2 max-w-sm`;
    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i><span>${message}</span>`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    document.body.appendChild(container);
    return container;
  }

  async function addNewTenderLineItem() {
    try {
      const response = await fetch(`/tenders/${TENDER_ID}/tender_line_items.json`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        },
        body: JSON.stringify({ tender_line_item: { quantity: 1, rate: 0, page_number: '', item_number: '', item_description: '', unit_of_measure: '', section_category: null, notes: '' } })
      });

      if (!response.ok) {
        const errorData = await response.json();
        showToast('Failed to create line item: ' + (errorData.error || 'Unknown error'), 'error');
        return;
      }

      showToast('Line item created successfully!', 'success');
      refreshTenderItems();
    } catch (error) {
      console.error('Error creating line item:', error);
      showToast('Failed to create line item', 'error');
    }
  }

  function editRow(button, itemId) {
    const row = button.closest('tr');
    const isEditing = row.classList.contains('editing-mode');
    
    if (isEditing) {
      cancelEdit(row);
    } else {
      enableEditMode(row, itemId);
    }
  }

  function enableEditMode(row, itemId) {
    row.classList.add('editing-mode');
    
    const editBtn = row.querySelector('.edit-row-btn');
    const deleteBtn = row.querySelector('.delete-row-btn');
    editBtn.innerHTML = '<i class="fas fa-times"></i>';
    editBtn.classList.add('btn-error');
    editBtn.classList.remove('btn-ghost');
    editBtn.title = 'Cancel editing';
    deleteBtn.classList.remove('hidden');
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn btn-xs btn-success ml-1';
    saveBtn.innerHTML = '<i class="fas fa-check"></i>';
    saveBtn.title = 'Save changes';
    saveBtn.onclick = () => saveRowChanges(row, itemId);
    editBtn.parentElement.appendChild(saveBtn);
    
    const editableCells = row.querySelectorAll('.editable-cell');
    editableCells.forEach(cell => {
      const field = cell.getAttribute('data-field');
      let currentValue = cell.textContent.trim().replace('â€”', '');
      
      // Create appropriate input based on field type
      let input;
      if (field === 'section_category') {
        // For category, get the display value from row data attribute
        const categoryDisplay = row.getAttribute('data-category-display') || currentValue;
        input = createCategorySelect(field, categoryDisplay);
      } else if (field === 'quantity' || field === 'rate' || field === 'page_number') {
        input = document.createElement('input');
        input.type = 'number';
        input.step = field === 'quantity' ? '0.01' : (field === 'rate' ? '0.01' : '1');
        input.min = '0';
        input.value = currentValue;
        input.className = 'input input-bordered input-sm w-full';
      } else {
        input = document.createElement('input');
        input.type = 'text';
        input.value = currentValue;
        input.className = 'input input-bordered input-sm w-full';
      }
      
      input.setAttribute('data-field', field);
      cell.innerHTML = '';
      cell.appendChild(input);
    });
  }

  function createCategorySelect(field, currentValue) {
    const select = document.createElement('select');
    select.className = 'select select-bordered select-sm w-full';
    select.setAttribute('data-field', field);
    
    const categories = [
      'Blank',
      'Steel Sections',
      'Paintwork',
      'Bolts',
      'Gutter Meter',
      'M16 Mechanical Anchor',
      'M16 Chemical',
      'M20 Chemical',
      'M24 Chemical',
      'M16 HD Bolt',
      'M20 HD Bolt',
      'M24 HD Bolt',
      'M30 HD Bolt',
      'M36 HD Bolt',
      'M42 HD Bolt'
    ];
    
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      option.selected = cat === currentValue;
      select.appendChild(option);
    });
    
    return select;
  }

  function cancelEdit(row) {
    row.classList.remove('editing-mode');
    const saveBtn = row.querySelector('.btn-success');
    if (saveBtn) saveBtn.remove();
    
    const editBtn = row.querySelector('.edit-row-btn');
    const deleteBtn = row.querySelector('.delete-row-btn');
    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
    editBtn.classList.remove('btn-error');
    editBtn.classList.add('btn-ghost');
    editBtn.title = 'Edit this row';
    deleteBtn.classList.add('hidden');
    
    const itemId = row.getAttribute('data-item-id');
    reloadRow(row, itemId);
  }

  async function saveRowChanges(row, itemId) {
    const editBtn = row.querySelector('.edit-row-btn');
    const saveBtn = row.querySelector('.btn-success');
    const originalEditHTML = editBtn.innerHTML;
    const originalSaveHTML = saveBtn.innerHTML;
    
    editBtn.disabled = true;
    saveBtn.disabled = true;
    editBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
      const updateData = {};
      row.querySelectorAll('.editable-cell').forEach(cell => {
        const field = cell.getAttribute('data-field');
        const input = cell.querySelector('input');
        const select = cell.querySelector('select');
        
        if (input) {
          // For numeric fields, parse as float; for text fields, keep as string
          const value = input.value;
          if (field === 'quantity' || field === 'rate' || field === 'page_number') {
            updateData[field] = parseFloat(value);
          } else {
            updateData[field] = value;
          }
        } else if (select) {
          updateData[field] = select.value;
        }
      });
      
      const response = await fetch(`/tenders/${TENDER_ID}/tender_line_items/${itemId}.json`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        },
        body: JSON.stringify({ tender_line_item: updateData })
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        showToast('Failed to save changes: ' + (errorData.error || 'Unknown error'), 'error');
        editBtn.disabled = false;
        saveBtn.disabled = false;
        editBtn.innerHTML = originalEditHTML;
        saveBtn.innerHTML = originalSaveHTML;
        return;
      }
      
      showToast('Changes saved successfully!', 'success');
      row.classList.remove('editing-mode');
      saveBtn.remove();
      editBtn.innerHTML = originalEditHTML;
      editBtn.classList.remove('btn-error');
      editBtn.classList.add('btn-ghost');
      editBtn.title = 'Edit this row';
      editBtn.disabled = false;
      row.querySelector('.delete-row-btn').classList.add('hidden');
      
      reloadRow(row, itemId);
    } catch (error) {
      console.error('Error saving changes:', error);
      showToast('Failed to save changes', 'error');
      editBtn.disabled = false;
      saveBtn.disabled = false;
      editBtn.innerHTML = originalEditHTML;
      saveBtn.innerHTML = originalSaveHTML;
    }
  }

  async function reloadRow(row, itemId) {
    try {
      const response = await fetch(`/tenders/${TENDER_ID}/tender_line_items/${itemId}.json`);
      
      if (!response.ok) throw new Error('Failed to fetch item');
      
      const item = await response.json();
      
      // Update cells with new values
      const cells = {
        'page_number': item.page_number || 'â€”',
        'item_number': item.item_number || 'â€”',
        'item_description': item.item_description ? item.item_description.substring(0, 60) : 'â€”',
        'section_category': `<span class="badge badge-sm">${item.section_category || 'â€”'}</span>`,
        'unit_of_measure': item.unit_of_measure || 'â€”',
        'quantity': parseFloat(item.quantity).toFixed(2),
        'rate': parseFloat(item.rate).toFixed(2),
        'total_amount': (parseFloat(item.quantity) * parseFloat(item.rate)).toFixed(2)
      };
      
      row.querySelectorAll('.editable-cell').forEach(cell => {
        const field = cell.getAttribute('data-field');
        cell.innerHTML = cells[field];
      });
      
      // Update summary stats immediately with new values
      setTimeout(() => updateSummaryStatsFromTable(), 10);
    } catch (error) {
      console.error('Error reloading row:', error);
      showToast('Error reloading row data', 'error');
    }
  }

  function updateSummaryStatsFromTable() {
    // Get all rows in the table
    const rows = document.querySelectorAll('.tender-line-item-row');
    let totalItems = rows.length;
    let totalQuantity = 0;
    let grandTotal = 0;

    console.log('ðŸ“Š Calculating from', totalItems, 'rows');

    // Calculate totals from all visible rows
    rows.forEach((row, idx) => {
      const quantityCell = row.querySelector('[data-field="quantity"]');
      const rateCell = row.querySelector('[data-field="rate"]');
      
      if (quantityCell && rateCell) {
        const quantity = parseFloat(quantityCell.textContent.trim()) || 0;
        const rate = parseFloat(rateCell.textContent.trim()) || 0;
        const rowTotal = quantity * rate;
        
        console.log(`Row ${idx + 1}: Qty=${quantity}, Rate=${rate}, Total=${rowTotal}`);
        
        totalQuantity += quantity;
        grandTotal += rowTotal;
      }
    });

    console.log('ðŸ’° Final: Qty Total=', totalQuantity.toFixed(2), ', Grand Total=', grandTotal.toFixed(2));

    // Update the summary stat elements with IDs
    const totalItemsElem = document.querySelector('div#total-items');
    const totalQtyElem = document.querySelector('div#total-quantity');
    const grandTotalElem = document.querySelector('div#grand-total');

    if (totalItemsElem) {
      totalItemsElem.textContent = totalItems;
      console.log('âœ… Updated total-items to', totalItems);
    }
    if (totalQtyElem) {
      totalQtyElem.textContent = totalQuantity.toFixed(2);
      console.log('âœ… Updated total-quantity to', totalQuantity.toFixed(2));
    }
    if (grandTotalElem) {
      grandTotalElem.textContent = grandTotal.toFixed(2);
      console.log('âœ… Updated grand-total to', grandTotal.toFixed(2));
    }
  }



  async function deleteRow(button, itemId) {
    if (!confirm('Are you sure you want to delete this line item?')) return;
    
    try {
      const response = await fetch(`/tenders/${TENDER_ID}/tender_line_items/${itemId}.json`, {
        method: 'DELETE',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) {
        showToast('Failed to delete line item', 'error');
        return;
      }
      
      showToast('Line item deleted successfully!', 'success');
      refreshTenderItems();
    } catch (error) {
      console.error('Error deleting line item:', error);
      showToast('Failed to delete line item', 'error');
    }
  }

  async function refreshTenderItems() {
    const btn = document.getElementById('refresh-items-btn');
    const originalHTML = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    
    try {
      const response = await fetch(`/tenders/${TENDER_ID}/tender_line_items.json`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const items = await response.json();
      
      const totalQty = items.reduce((sum, item) => sum + parseFloat(item.quantity), 0);
      const grandTotal = items.reduce((sum, item) => sum + (parseFloat(item.quantity) * parseFloat(item.rate)), 0);
      
      // Update header badge
      const itemsCountBadge = document.getElementById('items-count');
      if (itemsCountBadge) itemsCountBadge.textContent = items.length;
      
      if (items.length === 0) {
        document.getElementById('items-container').innerHTML = `
          <div id="empty-state" class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <div>No line items yet. Click "Add Line Item" to create one.</div>
          </div>
        `;
      } else {
        let tableHTML = `
          <div class="overflow-x-auto">
            <table class="table table-sm w-full">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Page</th>
                  <th>Item Number</th>
                  <th>Description</th>
                  <th>Category</th>
                  <th>UOM</th>
                  <th>Quantity</th>
                  <th>Rate (R)</th>
                  <th class="text-right">Total Amount (R)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="items-tbody">
        `;
        
        items.forEach((item, idx) => {
          const total = parseFloat(item.quantity) * parseFloat(item.rate);
          const notes = item.notes ? `<div class="text-xs text-gray-500 mt-1">${item.notes}</div>` : '';
          tableHTML += `
            <tr class="tender-line-item-row" data-item-id="${item.id}" data-category-key="${item.section_category || ""}" data-category-display="${item.section_category || ""}">
              <td>${idx + 1}</td>
              <td class="font-mono text-sm editable-cell" data-field="page_number" title="Click to edit">${item.page_number || "â€”"}</td>
              <td class="font-mono text-sm editable-cell" data-field="item_number" title="Click to edit">${item.item_number || "â€”"}</td>
              <td class="editable-cell" data-field="item_description" title="Click to edit">
                <div class="text-sm">${item.item_description ? item.item_description.substring(0, 60) : "â€”"}</div>
                ${notes}
              </td>
              <td class="editable-cell" data-field="section_category" title="Click to edit"><span class="badge badge-sm">${item.section_category || "â€”"}</span></td>
              <td class="editable-cell" data-field="unit_of_measure" title="Click to edit">${item.unit_of_measure || "â€”"}</td>
              <td class="text-right font-semibold editable-cell" data-field="quantity" title="Click to edit">${parseFloat(item.quantity).toFixed(2)}</td>
              <td class="text-right font-semibold editable-cell" data-field="rate" title="Click to edit">${parseFloat(item.rate).toFixed(2)}</td>
              <td class="text-right font-bold" data-field="total_amount">${total.toFixed(2)}</td>
              <td class="text-center">
                ${item.line_item_rate_build_up_id ? `<a href="/line_item_rate_build_ups/${item.line_item_rate_build_up_id}" class="btn btn-xs btn-info gap-1" title="View rate buildup"><i class="fas fa-chart-bar"></i>Buildup</a>` : '<span class="text-xs text-gray-400">No buildup</span>'}
                <button class="btn btn-xs btn-ghost edit-row-btn" onclick="editRow(this, ${item.id})" title="Edit this row">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-xs btn-ghost delete-row-btn hidden" onclick="deleteRow(this, ${item.id})" title="Delete this row">
                  <i class="fas fa-trash text-red-600"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        tableHTML += `
              </tbody>
            </table>
          </div>
          <div class="mt-6 pt-4 border-t border-gray-200">
            <div class="grid grid-cols-3 gap-4">
              <div class="stat bg-base-100">
                <div class="stat-title text-sm">Total Line Items</div>
                <div class="stat-value text-lg" id="total-items">${items.length}</div>
              </div>
              <div class="stat bg-base-100">
                <div class="stat-title text-sm">Total Quantity</div>
                <div class="stat-value text-lg" id="total-quantity">${totalQty.toFixed(2)}</div>
              </div>
              <div class="stat bg-base-100">
                <div class="stat-title text-sm">Grand Total (R)</div>
                <div class="stat-value text-lg text-green-600" id="grand-total">${grandTotal.toFixed(2)}</div>
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('items-container').innerHTML = tableHTML;
        updateSummaryStatsFromTable();
      }
      
      showToast(`Loaded ${items.length} line items`, 'success');
    } catch (error) {
      console.error('Error refreshing items:', error);
      showToast('Failed to refresh items', 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  }

  // Inclusions & Exclusions Auto-Save
  function setupInclusionsExclusionsListeners() {
    const checkboxes = document.querySelectorAll('.inclusion-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        e.preventDefault();
        saveInclusionsExclusions();
      });
    });
  }

  async function saveInclusionsExclusions() {
    const checkboxes = document.querySelectorAll('.inclusion-checkbox');
    const data = {};
    
    checkboxes.forEach(checkbox => {
      const field = checkbox.getAttribute('data-field');
      data[field] = checkbox.checked;
    });

    const saveBtn = document.getElementById('save-ie-btn');
    const saveStatus = document.getElementById('save-status');
    const originalHTML = saveBtn.innerHTML;

    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveStatus.textContent = 'Saving...';
    saveStatus.classList.remove('text-success', 'text-error');

    try {
      const response = await fetch(`/tenders/${TENDER_ID}/update_inclusions_exclusions.json`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        },
        body: JSON.stringify({ tender_inclusions_exclusion: data })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to save');
      }

      saveStatus.textContent = 'âœ“ Saved successfully';
      saveStatus.classList.add('text-success');
      showToast('Inclusions & Exclusions saved!', 'success');
      
      setTimeout(() => {
        saveStatus.textContent = '';
        saveStatus.classList.remove('text-success');
      }, 3000);
    } catch (error) {
      console.error('Error saving inclusions/exclusions:', error);
      saveStatus.textContent = 'Error saving. Try again.';
      saveStatus.classList.add('text-error');
      showToast('Failed to save inclusions & exclusions', 'error');
    } finally {
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalHTML;
    }
  }

  // Mirror BOQ Items to Tender Line Items
  async function mirrorBoqItemsToLineItems() {
    const btn = document.getElementById('mirror-boq-btn');
    const originalHTML = btn.innerHTML;
    
    if (!confirm('This will create Tender Line Items from all Linked BOQ items. Continue?')) {
      return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mirroring...';
    
    try {
      const response = await fetch(`/tenders/${TENDER_ID}/mirror_boq_items.json`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        showToast('Failed to mirror items: ' + (errorData.error || 'Unknown error'), 'error');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        return;
      }
      
      const data = await response.json();
      showToast(`Successfully created ${data.count} line items!`, 'success');
      refreshTenderItems();
    } catch (error) {
      console.error('Error mirroring BOQ items:', error);
      showToast('Failed to mirror BOQ items', 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  }

  // Rate Buildup Accordion Handler
  document.addEventListener('change', async (e) => {
    if (e.target.classList.contains('buildup-toggle')) {
      const isChecked = e.target.checked;
      const buildupId = e.target.getAttribute('data-buildup-id');
      const contentDiv = document.getElementById(`buildup-content-${buildupId}`);
      
      if (isChecked && contentDiv) {
        // Fetch buildup data if not already loaded
        if (contentDiv.querySelector('.loading')) {
          try {
            const response = await fetch(`/line_item_rate_build_ups/${buildupId}.json`, {
              headers: {
                'Accept': 'application/json'
              }
            });
            
            if (!response.ok) throw new Error('Failed to fetch buildup data');
            
            const buildup = await response.json();
            
            // Build the HTML for the buildup details
            const html = buildBuildupHTML(buildup);
            contentDiv.innerHTML = html;
          } catch (error) {
            console.error('Error loading buildup:', error);
            contentDiv.innerHTML = '<div class="alert alert-error">Failed to load rate buildup details</div>';
          }
        }
      }
    }
  });

  function buildBuildupHTML(buildup) {
    const components = [
      { label: 'Material Supply', rateField: 'material_supply_rate', includedField: null, rate: buildup.material_supply_rate, included: true, alwaysIncluded: true },
      { label: 'Fabrication', rateField: 'fabrication_rate', includedField: 'fabrication_included', rate: buildup.fabrication_rate, included: buildup.fabrication_included, alwaysIncluded: false },
      { label: 'Overheads', rateField: 'overheads_rate', includedField: 'overheads_included', rate: buildup.overheads_rate, included: buildup.overheads_included, alwaysIncluded: false },
      { label: 'Shop Priming', rateField: 'shop_priming_rate', includedField: 'shop_priming_included', rate: buildup.shop_priming_rate, included: buildup.shop_priming_included, alwaysIncluded: false },
      { label: 'Onsite Painting', rateField: 'onsite_painting_rate', includedField: 'onsite_painting_included', rate: buildup.onsite_painting_rate, included: buildup.onsite_painting_included, alwaysIncluded: false },
      { label: 'Delivery', rateField: 'delivery_rate', includedField: 'delivery_included', rate: buildup.delivery_rate, included: buildup.delivery_included, alwaysIncluded: false },
      { label: 'Bolts', rateField: 'bolts_rate', includedField: 'bolts_included', rate: buildup.bolts_rate, included: buildup.bolts_included, alwaysIncluded: false },
      { label: 'Erection', rateField: 'erection_rate', includedField: 'erection_included', rate: buildup.erection_rate, included: buildup.erection_included, alwaysIncluded: false },
      { label: 'Crainage', rateField: 'crainage_rate', includedField: 'crainage_included', rate: buildup.crainage_rate, included: buildup.crainage_included, alwaysIncluded: false },
      { label: 'Cherry Picker', rateField: 'cherry_picker_rate', includedField: 'cherry_picker_included', rate: buildup.cherry_picker_rate, included: buildup.cherry_picker_included, alwaysIncluded: false },
      { label: 'Galvanizing', rateField: 'galvanizing_rate', includedField: 'galvanizing_included', rate: buildup.galvanizing_rate, included: buildup.galvanizing_included, alwaysIncluded: false }
    ];

    let html = `<form id="buildup-form-${buildup.id}" class="space-y-3 text-sm">`;
    
    components.forEach(comp => {
      const rateValue = parseFloat(comp.rate || 0).toFixed(2);
      
      if (comp.alwaysIncluded) {
        // Material Supply: no checkbox, always included
        html += `
          <div class="flex items-center justify-between gap-3 p-3 bg-blue-50 rounded border-2 border-blue-200">
            <div class="flex-1">
              <span class="font-medium text-blue-900">${comp.label}</span>
              <span class="text-xs text-blue-700 ml-2">(Always Included)</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-gray-600">R</span>
              <input type="number" 
                     step="0.01" 
                     min="0"
                     class="input input-sm input-bordered w-24 text-right buildup-rate-input" 
                     data-buildup-id="${buildup.id}"
                     data-field="${comp.rateField}"
                     value="${rateValue}"
              >
            </div>
          </div>
        `;
      } else {
        // Other components: with checkbox
        html += `
          <div class="flex items-center justify-between gap-3 p-3 bg-gray-50 rounded border border-gray-200">
            <div class="flex-1">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" 
                       class="checkbox checkbox-sm buildup-checkbox" 
                       data-buildup-id="${buildup.id}"
                       data-field="${comp.includedField}"
                       ${comp.included ? 'checked' : ''}
                >
                <span class="font-medium">${comp.label}</span>
              </label>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-gray-600">R</span>
              <input type="number" 
                     step="0.01" 
                     min="0"
                     class="input input-sm input-bordered w-24 text-right buildup-rate-input" 
                     data-buildup-id="${buildup.id}"
                     data-field="${comp.rateField}"
                     value="${rateValue}"
              >
            </div>
          </div>
        `;
      }
    });

    // Add summary section with auto-calculated values
    html += `
      <div class="mt-4 pt-4 border-t border-gray-200 space-y-2">
        <div class="flex justify-between font-semibold text-sm">
          <span>Subtotal:</span>
          <span class="text-blue-600 buildup-subtotal" data-buildup-id="${buildup.id}">R ${parseFloat(buildup.subtotal || 0).toFixed(2)}</span>
        </div>
        <div class="flex justify-between font-semibold text-sm">
          <span>Margin:</span>
          <span class="text-orange-600 buildup-margin" data-buildup-id="${buildup.id}">R ${parseFloat(buildup.margin_amount || 0).toFixed(2)}</span>
        </div>
        <div class="flex justify-between text-sm bg-green-50 p-2 rounded border-2 border-green-500">
          <span class="font-bold">Final Rate:</span>
          <span class="font-bold text-green-600 buildup-final-rate" data-buildup-id="${buildup.id}">R ${parseFloat(buildup.rounded_rate || 0).toFixed(2)}</span>
        </div>
      </div>
      
      <div class="mt-4 flex gap-2">
        <button type="button" 
                class="btn btn-sm btn-primary buildup-save-btn" 
                onclick="saveBuildupChanges(${buildup.id})"
                data-buildup-id="${buildup.id}">
          <i class="fas fa-save"></i>
          Save Changes
        </button>
        <button type="button" 
                class="btn btn-sm btn-ghost" 
                onclick="cancelBuildupEdit(${buildup.id})">
          Cancel
        </button>
      </div>
    </form>`;

    return html;
  }

  // Handle buildup checkbox/input changes
  document.addEventListener('change', (e) => {
    if (e.target.classList.contains('buildup-checkbox') || e.target.classList.contains('buildup-rate-input')) {
      updateBuildupSummary(e.target.getAttribute('data-buildup-id'));
    }
  });

  document.addEventListener('input', (e) => {
    if (e.target.classList.contains('buildup-rate-input')) {
      updateBuildupSummary(e.target.getAttribute('data-buildup-id'));
    }
  });

  function updateBuildupSummary(buildupId) {
    const form = document.getElementById(`buildup-form-${buildupId}`);
    if (!form) return;

    let subtotal = 0;

    // Always add Material Supply (it has no checkbox)
    const materialSupplyInput = form.querySelector('[data-field="material_supply_rate"]');
    if (materialSupplyInput) {
      subtotal += parseFloat(materialSupplyInput.value || 0);
    }

    // Add other components only if checked
    form.querySelectorAll('.buildup-checkbox').forEach(checkbox => {
      if (checkbox.checked) {
        const field = checkbox.getAttribute('data-field');
        const rateField = field.replace('_included', '_rate');
        const rateInput = form.querySelector(`[data-field="${rateField}"]`);
        if (rateInput) {
          subtotal += parseFloat(rateInput.value || 0);
        }
      }
    });

    // Update summary displays
    const subtotalElem = document.querySelector(`.buildup-subtotal[data-buildup-id="${buildupId}"]`);
    if (subtotalElem) {
      subtotalElem.textContent = `R ${subtotal.toFixed(2)}`;
    }
  }

  async function saveBuildupChanges(buildupId) {
    const form = document.getElementById(`buildup-form-${buildupId}`);
    if (!form) return;

    const saveBtn = form.querySelector('.buildup-save-btn');
    const originalHTML = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
      const updateData = {};
      
      form.querySelectorAll('.buildup-checkbox').forEach(checkbox => {
        const field = checkbox.getAttribute('data-field');
        updateData[field] = checkbox.checked;
      });

      form.querySelectorAll('.buildup-rate-input').forEach(input => {
        const field = input.getAttribute('data-field');
        updateData[field] = parseFloat(input.value || 0);
      });

      const response = await fetch(`/line_item_rate_build_ups/${buildupId}.json`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        },
        body: JSON.stringify({ line_item_rate_build_up: updateData })
      });

      if (!response.ok) {
        const errorData = await response.json();
        showToast('Failed to save: ' + (errorData.error || 'Unknown error'), 'error');
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalHTML;
        return;
      }

      const data = await response.json();
      
      // Update summary displays with returned values
      const subtotalElem = document.querySelector(`.buildup-subtotal[data-buildup-id="${buildupId}"]`);
      const marginElem = document.querySelector(`.buildup-margin[data-buildup-id="${buildupId}"]`);
      const finalRateElem = document.querySelector(`.buildup-final-rate[data-buildup-id="${buildupId}"]`);

      if (subtotalElem) subtotalElem.textContent = `R ${parseFloat(data.subtotal || 0).toFixed(2)}`;
      if (marginElem) marginElem.textContent = `R ${parseFloat(data.margin_amount || 0).toFixed(2)}`;
      if (finalRateElem) finalRateElem.textContent = `R ${parseFloat(data.rounded_rate || 0).toFixed(2)}`;

      showToast('Rate buildup saved successfully!', 'success');
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalHTML;
    } catch (error) {
      console.error('Error saving buildup:', error);
      showToast('Failed to save changes', 'error');
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalHTML;
    }
  }

  function cancelBuildupEdit(buildupId) {
    // Simply close the accordion
    const toggle = document.querySelector(`input.buildup-toggle[data-buildup-id="${buildupId}"]`);
    if (toggle) toggle.checked = false;
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    setupInclusionsExclusionsListeners();
  });
</script>
