<% content_for :title, "Tender Builder - #{@tender.tender_name}" %>

<div class="container mx-auto p-6">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold"><%= @tender.tender_name %></h1>
      <p class="text-gray-600 mt-1">
        <span class="inline-flex items-center gap-2">
          <i class="fa-solid fa-file-contract text-blue-600"></i>
          <%= @tender.e_number %>
          <span class="badge badge-sm"><%= @tender.status %></span>
        </span>
      </p>
    </div>
    <%= link_to "Back to Tender", tender_path(@tender), class: "btn btn-ghost" %>
  </div>

  <!-- Inclusions & Exclusions Section -->
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title mb-6">
        <i class="fas fa-check-square"></i>
        Inclusions & Exclusions
      </h2>

      <div id="inclusions-container" class="space-y-3">
        <!-- Fabrication Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Fabrication Included?</span>
            <span class="text-xs text-gray-500">Labour and manufacturing</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="fabrication_included"
            <%= @tender.tender_inclusions_exclusion&.fabrication_included ? 'checked' : '' %>
          >
        </label>

        <!-- Overheads Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Overheads Included?</span>
            <span class="text-xs text-gray-500">Administrative and indirect costs</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="overheads_included"
            <%= @tender.tender_inclusions_exclusion&.overheads_included ? 'checked' : '' %>
          >
        </label>

        <!-- Primer Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Primer Included in Line Item Rate?</span>
            <span class="text-xs text-gray-500">Base coating</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="primer_included"
            <%= @tender.tender_inclusions_exclusion&.primer_included ? 'checked' : '' %>
          >
        </label>

        <!-- Final Paint Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Final Paint Included in Line Item Rate?</span>
            <span class="text-xs text-gray-500">Finish coating</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="final_paint_included"
            <%= @tender.tender_inclusions_exclusion&.final_paint_included ? 'checked' : '' %>
          >
        </label>

        <!-- Delivery Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Delivery Included?</span>
            <span class="text-xs text-gray-500">Transportation to site</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="delivery_included"
            <%= @tender.tender_inclusions_exclusion&.delivery_included ? 'checked' : '' %>
          >
        </label>

        <!-- Bolts Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Bolts Included in Line Item Rate?</span>
            <span class="text-xs text-gray-500">Fasteners and hardware</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="bolts_included"
            <%= @tender.tender_inclusions_exclusion&.bolts_included ? 'checked' : '' %>
          >
        </label>

        <!-- Erection Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Erection Included in Line Item Rate?</span>
            <span class="text-xs text-gray-500">Assembly and installation</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="erection_included"
            <%= @tender.tender_inclusions_exclusion&.erection_included ? 'checked' : '' %>
          >
        </label>

        <!-- Crainage Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Crainage Included in Line Item Rate?</span>
            <span class="text-xs text-gray-500">Crane operations</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="crainage_included"
            <%= @tender.tender_inclusions_exclusion&.crainage_included ? 'checked' : '' %>
          >
        </label>

        <!-- Cherry Pickers Included -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Cherry Pickers Included in Line Item Rate?</span>
            <span class="text-xs text-gray-500">Aerial work platforms</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="cherry_pickers_included"
            <%= @tender.tender_inclusions_exclusion&.cherry_pickers_included ? 'checked' : '' %>
          >
        </label>

        <!-- Steel Galvanized -->
        <label class="flex items-center justify-between gap-3 cursor-pointer p-3 rounded-lg hover:bg-base-200 transition border border-gray-200">
          <span class="flex-1">
            <span class="font-semibold block">Is the Steel Galvanized?</span>
            <span class="text-xs text-gray-500">Hot-dip galvanized finish</span>
          </span>
          <input 
            type="checkbox" 
            class="checkbox checkbox-lg inclusion-checkbox"
            data-field="steel_galvanized"
            <%= @tender.tender_inclusions_exclusion&.steel_galvanized ? 'checked' : '' %>
          >
        </label>
      </div>

      <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
        <span id="save-status" class="text-sm text-gray-500"></span>
        <button 
          id="save-ie-btn" 
          class="btn btn-sm btn-primary gap-2"
          onclick="saveInclusionsExclusions()"
        >
          <i class="fas fa-save"></i>
          Save Changes
        </button>
      </div>
    </div>
  </div>

  <!-- Linked BOQ Section -->
  <% if @tender.boqs.any? %>
    <div class="card bg-base-100 shadow mt-6">
      <div class="card-body">
        <div class="flex justify-between items-center mb-4">
          <h2 class="card-title mb-0">
            <i class="fas fa-cube"></i>
            Linked BOQ Items
            <span id="boq-items-count" class="badge badge-lg"><%= @tender.boqs.first.boq_items.count %></span>
          </h2>
          <button 
            id="mirror-boq-btn"
            class="btn btn-sm btn-success gap-2"
            onclick="mirrorBoqItemsToLineItems()"
          >
            <i class="fas fa-copy"></i>
            Mirror to Line Items
          </button>
        </div>

        <div id="boq-items-container">
          <div class="overflow-x-auto">
            <table class="table table-sm w-full">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Item Number</th>
                  <th>Description</th>
                  <th>Unit</th>
                  <th>Quantity</th>
                  <th>Category</th>
                </tr>
              </thead>
              <tbody>
                <% @tender.boqs.first.boq_items.order(:sequence_order).each_with_index do |item, idx| %>
                  <tr>
                    <td><%= idx + 1 %></td>
                    <td class="font-semibold"><%= item.item_number %></td>
                    <td><%= truncate(item.item_description, length: 50) %></td>
                    <td><%= item.unit_of_measure %></td>
                    <td class="font-semibold"><%= number_with_precision(item.quantity, precision: 3) %></td>
                    <td><span class="badge"><%= item.section_category %></span></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Tender Line Items Section - Styled like BOQ Line Items -->
  <div class="card bg-base-100 shadow mt-6">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="card-title mb-0">
          <i class="fas fa-list"></i>
          Tender Line Items
          <span id="items-count" class="badge badge-lg"><%= @tender.tender_line_items.count %></span>
        </h2>
        <div class="flex gap-2">
          <button 
            id="add-new-row-btn"
            class="btn btn-sm btn-primary gap-2"
            onclick="addNewTenderLineItem()"
          >
            <i class="fas fa-plus"></i>
            Add Line Item
          </button>
          <button 
            id="refresh-items-btn" 
            class="btn btn-sm btn-outline gap-2"
            onclick="refreshTenderItems()"
          >
            <i class="fas fa-refresh"></i>
            Refresh
          </button>
        </div>
      </div>

      <div id="items-container">
        <% if @tender.tender_line_items.any? %>
          <div class="overflow-x-auto">
            <table class="table table-sm w-full">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Page</th>
                  <th>Item Number</th>
                  <th>Description</th>
                  <th>Category</th>
                  <th>UOM</th>
                  <th>Quantity</th>
                  <th>Rate (â‚¹)</th>
                  <th class="text-right">Total Amount (â‚¹)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="items-tbody">
                <% @tender.tender_line_items.each_with_index do |item, idx| %>
                  <tr class="tender-line-item-row" data-item-id="<%= item.id %>" data-category-key="<%= item.section_category || "" %>" data-category-display="<%= item.section_category || "" %>">
                    <td><%= idx + 1 %></td>
                    <td class="font-mono text-sm editable-cell" data-field="page_number" title="Click to edit"><%= item.page_number || "â€”" %></td>
                    <td class="font-mono text-sm editable-cell" data-field="item_number" title="Click to edit"><%= item.item_number || "â€”" %></td>
                    <td class="editable-cell" data-field="item_description" title="Click to edit">
                      <div class="text-sm"><%= truncate(item.item_description, length: 60) %></div>
                      <% if item.notes %>
                        <div class="text-xs text-gray-500 mt-1"><%= item.notes %></div>
                      <% end %>
                    </td>
                    <td class="editable-cell" data-field="section_category" title="Click to edit"><span class="badge badge-sm"><%= item.section_category || "â€”" %></span></td>
                    <td class="editable-cell" data-field="unit_of_measure" title="Click to edit"><%= item.unit_of_measure || "â€”" %></td>
                    <td class="text-right font-semibold editable-cell" data-field="quantity" title="Click to edit"><%= number_with_precision(item.quantity, precision: 2) %></td>
                    <td class="text-right font-semibold editable-cell" data-field="rate" title="Click to edit"><%= number_with_precision(item.rate, precision: 2) %></td>
                    <td class="text-right font-bold" data-field="total_amount"><%= number_with_precision(item.total_amount, precision: 2) %></td>
                    <td class="text-center">
                      <button class="btn btn-xs btn-ghost edit-row-btn" onclick="editRow(this, <%= item.id %>)" title="Edit this row">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-xs btn-ghost delete-row-btn hidden" onclick="deleteRow(this, <%= item.id %>)" title="Delete this row">
                        <i class="fas fa-trash text-red-600"></i>
                      </button>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <!-- Summary Row -->
          <div class="mt-6 pt-4 border-t border-gray-200">
            <div class="grid grid-cols-3 gap-4">
              <div class="stat bg-base-100">
                <div class="stat-title text-sm">Total Line Items</div>
                <div class="stat-value text-lg" id="total-items"><%= @tender.tender_line_items.count %></div>
              </div>
              <div class="stat bg-base-100">
                <div class="stat-title text-sm">Total Quantity</div>
                <div class="stat-value text-lg" id="total-quantity"><%= number_with_precision(@tender.tender_line_items.sum(:quantity), precision: 2) %></div>
              </div>
              <div class="stat bg-base-100">
                <div class="stat-title text-sm">Grand Total (â‚¹)</div>
                <div class="stat-value text-lg text-green-600" id="grand-total"><%= number_with_precision(@tender.tender_line_items.sum { |li| li.total_amount }, precision: 2) %></div>
              </div>
            </div>
          </div>
        <% else %>
          <div id="empty-state" class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <div>No line items yet. Click "Add Line Item" to create one.</div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="mt-6 flex gap-2">
    <%= link_to "Edit Tender Details", edit_tender_path(@tender), class: "btn btn-ghost" %>
    <%= link_to "Back to Tenders", tenders_path, class: "btn btn-ghost" %>
  </div>
</div>

<script>
  const TENDER_ID = '<%= @tender.id %>';

  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} shadow-lg fixed top-4 right-4 z-50 flex items-center gap-2 max-w-sm`;
    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i><span>${message}</span>`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    document.body.appendChild(container);
    return container;
  }

  async function addNewTenderLineItem() {
    try {
      const response = await fetch(`/tenders/${TENDER_ID}/tender_line_items.json`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        },
        body: JSON.stringify({ tender_line_item: { quantity: 1, rate: 0, page_number: '', item_number: '', item_description: '', unit_of_measure: '', section_category: null, notes: '' } })
      });

      if (!response.ok) {
        const errorData = await response.json();
        showToast('Failed to create line item: ' + (errorData.error || 'Unknown error'), 'error');
        return;
      }

      showToast('Line item created successfully!', 'success');
      refreshTenderItems();
    } catch (error) {
      console.error('Error creating line item:', error);
      showToast('Failed to create line item', 'error');
    }
  }

  function editRow(button, itemId) {
    const row = button.closest('tr');
    const isEditing = row.classList.contains('editing-mode');
    
    if (isEditing) {
      cancelEdit(row);
    } else {
      enableEditMode(row, itemId);
    }
  }

  function enableEditMode(row, itemId) {
    row.classList.add('editing-mode');
    
    const editBtn = row.querySelector('.edit-row-btn');
    const deleteBtn = row.querySelector('.delete-row-btn');
    editBtn.innerHTML = '<i class="fas fa-times"></i>';
    editBtn.classList.add('btn-error');
    editBtn.classList.remove('btn-ghost');
    editBtn.title = 'Cancel editing';
    deleteBtn.classList.remove('hidden');
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn btn-xs btn-success ml-1';
    saveBtn.innerHTML = '<i class="fas fa-check"></i>';
    saveBtn.title = 'Save changes';
    saveBtn.onclick = () => saveRowChanges(row, itemId);
    editBtn.parentElement.appendChild(saveBtn);
    
    const editableCells = row.querySelectorAll('.editable-cell');
    editableCells.forEach(cell => {
      const field = cell.getAttribute('data-field');
      let currentValue = cell.textContent.trim().replace('â€”', '');
      
      // Create appropriate input based on field type
      let input;
      if (field === 'section_category') {
        // For category, get the display value from row data attribute
        const categoryDisplay = row.getAttribute('data-category-display') || currentValue;
        input = createCategorySelect(field, categoryDisplay);
      } else if (field === 'quantity' || field === 'rate' || field === 'page_number') {
        input = document.createElement('input');
        input.type = 'number';
        input.step = field === 'quantity' ? '0.01' : (field === 'rate' ? '0.01' : '1');
        input.min = '0';
        input.value = currentValue;
        input.className = 'input input-bordered input-sm w-full';
      } else {
        input = document.createElement('input');
        input.type = 'text';
        input.value = currentValue;
        input.className = 'input input-bordered input-sm w-full';
      }
      
      input.setAttribute('data-field', field);
      cell.innerHTML = '';
      cell.appendChild(input);
    });
  }

  function createCategorySelect(field, currentValue) {
    const select = document.createElement('select');
    select.className = 'select select-bordered select-sm w-full';
    select.setAttribute('data-field', field);
    
    const categories = [
      'Blank',
      'Steel Sections',
      'Paintwork',
      'Bolts',
      'Gutter Meter',
      'M16 Mechanical Anchor',
      'M16 Chemical',
      'M20 Chemical',
      'M24 Chemical',
      'M16 HD Bolt',
      'M20 HD Bolt',
      'M24 HD Bolt',
      'M30 HD Bolt',
      'M36 HD Bolt',
      'M42 HD Bolt'
    ];
    
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      option.selected = cat === currentValue;
      select.appendChild(option);
    });
    
    return select;
  }

  function cancelEdit(row) {
    row.classList.remove('editing-mode');
    const saveBtn = row.querySelector('.btn-success');
    if (saveBtn) saveBtn.remove();
    
    const editBtn = row.querySelector('.edit-row-btn');
    const deleteBtn = row.querySelector('.delete-row-btn');
    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
    editBtn.classList.remove('btn-error');
    editBtn.classList.add('btn-ghost');
    editBtn.title = 'Edit this row';
    deleteBtn.classList.add('hidden');
    
    const itemId = row.getAttribute('data-item-id');
    reloadRow(row, itemId);
  }

  async function saveRowChanges(row, itemId) {
    const editBtn = row.querySelector('.edit-row-btn');
    const saveBtn = row.querySelector('.btn-success');
    const originalEditHTML = editBtn.innerHTML;
    const originalSaveHTML = saveBtn.innerHTML;
    
    editBtn.disabled = true;
    saveBtn.disabled = true;
    editBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
      const updateData = {};
      row.querySelectorAll('.editable-cell').forEach(cell => {
        const field = cell.getAttribute('data-field');
        const input = cell.querySelector('input');
        if (input) {
          updateData[field] = parseFloat(input.value);
        }
      });
      
      const response = await fetch(`/tenders/${TENDER_ID}/tender_line_items/${itemId}.json`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        },
        body: JSON.stringify({ tender_line_item: updateData })
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        showToast('Failed to save changes: ' + (errorData.error || 'Unknown error'), 'error');
        editBtn.disabled = false;
        saveBtn.disabled = false;
        editBtn.innerHTML = originalEditHTML;
        saveBtn.innerHTML = originalSaveHTML;
        return;
      }
      
      showToast('Changes saved successfully!', 'success');
      row.classList.remove('editing-mode');
      saveBtn.remove();
      editBtn.innerHTML = originalEditHTML;
      editBtn.classList.remove('btn-error');
      editBtn.classList.add('btn-ghost');
      editBtn.title = 'Edit this row';
      editBtn.disabled = false;
      row.querySelector('.delete-row-btn').classList.add('hidden');
      
      reloadRow(row, itemId);
    } catch (error) {
      console.error('Error saving changes:', error);
      showToast('Failed to save changes', 'error');
      editBtn.disabled = false;
      saveBtn.disabled = false;
      editBtn.innerHTML = originalEditHTML;
      saveBtn.innerHTML = originalSaveHTML;
    }
  }

  async function reloadRow(row, itemId) {
    try {
      const response = await fetch(`/tenders/${TENDER_ID}/tender_line_items/${itemId}.json`);
      
      if (!response.ok) throw new Error('Failed to fetch item');
      
      const item = await response.json();
      
      // Update cells with new values
      const cells = {
        'page_number': item.page_number || 'â€”',
        'item_number': item.item_number || 'â€”',
        'item_description': item.item_description ? item.item_description.substring(0, 60) : 'â€”',
        'section_category': `<span class="badge badge-sm">${item.section_category || 'â€”'}</span>`,
        'unit_of_measure': item.unit_of_measure || 'â€”',
        'quantity': parseFloat(item.quantity).toFixed(2),
        'rate': parseFloat(item.rate).toFixed(2),
        'total_amount': (parseFloat(item.quantity) * parseFloat(item.rate)).toFixed(2)
      };
      
      row.querySelectorAll('.editable-cell').forEach(cell => {
        const field = cell.getAttribute('data-field');
        cell.innerHTML = cells[field];
      });
      
      // Update summary stats immediately with new values
      setTimeout(() => updateSummaryStatsFromTable(), 10);
    } catch (error) {
      console.error('Error reloading row:', error);
      showToast('Error reloading row data', 'error');
    }
  }

  function updateSummaryStatsFromTable() {
    // Get all rows in the table
    const rows = document.querySelectorAll('.tender-line-item-row');
    let totalItems = rows.length;
    let totalQuantity = 0;
    let grandTotal = 0;

    console.log('ðŸ“Š Calculating from', totalItems, 'rows');

    // Calculate totals from all visible rows
    rows.forEach((row, idx) => {
      const quantityCell = row.querySelector('[data-field="quantity"]');
      const rateCell = row.querySelector('[data-field="rate"]');
      
      if (quantityCell && rateCell) {
        const quantity = parseFloat(quantityCell.textContent.trim()) || 0;
        const rate = parseFloat(rateCell.textContent.trim()) || 0;
        const rowTotal = quantity * rate;
        
        console.log(`Row ${idx + 1}: Qty=${quantity}, Rate=${rate}, Total=${rowTotal}`);
        
        totalQuantity += quantity;
        grandTotal += rowTotal;
      }
    });

    console.log('ðŸ’° Final: Qty Total=', totalQuantity.toFixed(2), ', Grand Total=', grandTotal.toFixed(2));

    // Update the summary stat elements with IDs
    const totalItemsElem = document.querySelector('div#total-items');
    const totalQtyElem = document.querySelector('div#total-quantity');
    const grandTotalElem = document.querySelector('div#grand-total');

    if (totalItemsElem) {
      totalItemsElem.textContent = totalItems;
      console.log('âœ… Updated total-items to', totalItems);
    }
    if (totalQtyElem) {
      totalQtyElem.textContent = totalQuantity.toFixed(2);
      console.log('âœ… Updated total-quantity to', totalQuantity.toFixed(2));
    }
    if (grandTotalElem) {
      grandTotalElem.textContent = grandTotal.toFixed(2);
      console.log('âœ… Updated grand-total to', grandTotal.toFixed(2));
    }
  }



  async function deleteRow(button, itemId) {
    if (!confirm('Are you sure you want to delete this line item?')) return;
    
    try {
      const response = await fetch(`/tenders/${TENDER_ID}/tender_line_items/${itemId}.json`, {
        method: 'DELETE',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) {
        showToast('Failed to delete line item', 'error');
        return;
      }
      
      showToast('Line item deleted successfully!', 'success');
      refreshTenderItems();
    } catch (error) {
      console.error('Error deleting line item:', error);
      showToast('Failed to delete line item', 'error');
    }
  }

  async function refreshTenderItems() {
    const btn = document.getElementById('refresh-items-btn');
    const originalHTML = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    
    try {
      const response = await fetch(`/tenders/${TENDER_ID}/tender_line_items.json`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const items = await response.json();
      
      const totalQty = items.reduce((sum, item) => sum + parseFloat(item.quantity), 0);
      const grandTotal = items.reduce((sum, item) => sum + (parseFloat(item.quantity) * parseFloat(item.rate)), 0);
      
      // Update header badge
      const itemsCountBadge = document.getElementById('items-count');
      if (itemsCountBadge) itemsCountBadge.textContent = items.length;
      
      if (items.length === 0) {
        document.getElementById('items-container').innerHTML = `
          <div id="empty-state" class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <div>No line items yet. Click "Add Line Item" to create one.</div>
          </div>
        `;
      } else {
        let tableHTML = `
          <div class="overflow-x-auto">
            <table class="table table-sm w-full">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Page</th>
                  <th>Item Number</th>
                  <th>Description</th>
                  <th>Category</th>
                  <th>UOM</th>
                  <th>Quantity</th>
                  <th>Rate (â‚¹)</th>
                  <th class="text-right">Total Amount (â‚¹)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="items-tbody">
        `;
        
        items.forEach((item, idx) => {
          const total = parseFloat(item.quantity) * parseFloat(item.rate);
          const notes = item.notes ? `<div class="text-xs text-gray-500 mt-1">${item.notes}</div>` : '';
          tableHTML += `
            <tr class="tender-line-item-row" data-item-id="${item.id}" data-category-key="${item.section_category || ""}" data-category-display="${item.section_category || ""}">
              <td>${idx + 1}</td>
              <td class="font-mono text-sm editable-cell" data-field="page_number" title="Click to edit">${item.page_number || "â€”"}</td>
              <td class="font-mono text-sm editable-cell" data-field="item_number" title="Click to edit">${item.item_number || "â€”"}</td>
              <td class="editable-cell" data-field="item_description" title="Click to edit">
                <div class="text-sm">${item.item_description ? item.item_description.substring(0, 60) : "â€”"}</div>
                ${notes}
              </td>
              <td class="editable-cell" data-field="section_category" title="Click to edit"><span class="badge badge-sm">${item.section_category || "â€”"}</span></td>
              <td class="editable-cell" data-field="unit_of_measure" title="Click to edit">${item.unit_of_measure || "â€”"}</td>
              <td class="text-right font-semibold editable-cell" data-field="quantity" title="Click to edit">${parseFloat(item.quantity).toFixed(2)}</td>
              <td class="text-right font-semibold editable-cell" data-field="rate" title="Click to edit">${parseFloat(item.rate).toFixed(2)}</td>
              <td class="text-right font-bold" data-field="total_amount">${total.toFixed(2)}</td>
              <td class="text-center">
                <button class="btn btn-xs btn-ghost edit-row-btn" onclick="editRow(this, ${item.id})" title="Edit this row">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-xs btn-ghost delete-row-btn hidden" onclick="deleteRow(this, ${item.id})" title="Delete this row">
                  <i class="fas fa-trash text-red-600"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        tableHTML += `
              </tbody>
            </table>
          </div>
          <div class="mt-6 pt-4 border-t border-gray-200">
            <div class="grid grid-cols-3 gap-4">
              <div class="stat bg-base-100">
                <div class="stat-title text-sm">Total Line Items</div>
                <div class="stat-value text-lg" id="total-items">${items.length}</div>
              </div>
              <div class="stat bg-base-100">
                <div class="stat-title text-sm">Total Quantity</div>
                <div class="stat-value text-lg" id="total-quantity">${totalQty.toFixed(2)}</div>
              </div>
              <div class="stat bg-base-100">
                <div class="stat-title text-sm">Grand Total (â‚¹)</div>
                <div class="stat-value text-lg text-green-600" id="grand-total">${grandTotal.toFixed(2)}</div>
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('items-container').innerHTML = tableHTML;
        updateSummaryStatsFromTable();
      }
      
      showToast(`Loaded ${items.length} line items`, 'success');
    } catch (error) {
      console.error('Error refreshing items:', error);
      showToast('Failed to refresh items', 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  }

  // Inclusions & Exclusions Auto-Save
  function setupInclusionsExclusionsListeners() {
    const checkboxes = document.querySelectorAll('.inclusion-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        e.preventDefault();
        saveInclusionsExclusions();
      });
    });
  }

  async function saveInclusionsExclusions() {
    const checkboxes = document.querySelectorAll('.inclusion-checkbox');
    const data = {};
    
    checkboxes.forEach(checkbox => {
      const field = checkbox.getAttribute('data-field');
      data[field] = checkbox.checked;
    });

    const saveBtn = document.getElementById('save-ie-btn');
    const saveStatus = document.getElementById('save-status');
    const originalHTML = saveBtn.innerHTML;

    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveStatus.textContent = 'Saving...';
    saveStatus.classList.remove('text-success', 'text-error');

    try {
      const response = await fetch(`/tenders/${TENDER_ID}/update_inclusions_exclusions.json`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        },
        body: JSON.stringify({ tender_inclusions_exclusion: data })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to save');
      }

      saveStatus.textContent = 'âœ“ Saved successfully';
      saveStatus.classList.add('text-success');
      showToast('Inclusions & Exclusions saved!', 'success');
      
      setTimeout(() => {
        saveStatus.textContent = '';
        saveStatus.classList.remove('text-success');
      }, 3000);
    } catch (error) {
      console.error('Error saving inclusions/exclusions:', error);
      saveStatus.textContent = 'Error saving. Try again.';
      saveStatus.classList.add('text-error');
      showToast('Failed to save inclusions & exclusions', 'error');
    } finally {
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalHTML;
    }
  }

  // Mirror BOQ Items to Tender Line Items
  async function mirrorBoqItemsToLineItems() {
    const btn = document.getElementById('mirror-boq-btn');
    const originalHTML = btn.innerHTML;
    
    if (!confirm('This will create Tender Line Items from all Linked BOQ items. Continue?')) {
      return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mirroring...';
    
    try {
      const response = await fetch(`/tenders/${TENDER_ID}/mirror_boq_items.json`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        showToast('Failed to mirror items: ' + (errorData.error || 'Unknown error'), 'error');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        return;
      }
      
      const data = await response.json();
      showToast(`Successfully created ${data.count} line items!`, 'success');
      refreshTenderItems();
    } catch (error) {
      console.error('Error mirroring BOQ items:', error);
      showToast('Failed to mirror BOQ items', 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    setupInclusionsExclusionsListeners();
  });
</script>
