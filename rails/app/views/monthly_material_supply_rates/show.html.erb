<% content_for :title, "Material Supply Rates" %>

<div class="w-full" data-controller="material-supply-rates" data-material-supply-rates-monthly-rate-id-value="<%= @monthly_material_supply_rate.id %>">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="font-bold text-4xl mb-2">Material Supply Rates â€” <%= @monthly_material_supply_rate.effective_from.strftime("%B %Y") %></h1>
      <p class="text-gray-600">Start typing to auto-save prices per tonne</p>
    </div>
    <div class="flex items-center gap-4">
      <button
        data-material-supply-rates-target="saveAllButton"
        class="hidden rounded-md px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium text-sm transition"
        data-action="material-supply-rates#saveAll"
      >
        ğŸ’¾ Save All
      </button>
      <div id="auto_save_status" class="text-sm text-gray-500">
        <span id="save_indicator" data-material-supply-rates-target="saveIndicator"></span>
      </div>
    </div>
  </div>

  <div class="border border-gray-200 rounded-lg overflow-hidden">
    <div class="overflow-x-auto max-h-screen" style="overflow-y: auto;">
      <table class="w-full border-collapse text-sm">
        <thead class="sticky top-0 z-10 bg-gray-100">
          <tr class="bg-gray-100 border-b border-gray-200">
          <th class="border-r border-gray-200 px-4 py-3 text-left font-bold bg-gray-50">Material Item</th>
          <th class="border-r border-gray-200 px-4 py-3 text-center font-bold text-xs">Waste %</th>
          <% @suppliers.each do |supplier| %>
            <th class="border-r border-gray-200 px-4 py-3 text-center font-bold text-xs">
              <%= supplier.name %>
            </th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @material_supplies.each_with_index do |material, idx| %>
          <tr class="<%= idx.even? ? 'bg-white' : 'bg-gray-50' %> border-b border-gray-200 hover:bg-blue-50 transition">
            <td class="border-r border-gray-200 px-4 py-3 font-medium text-gray-900 bg-gray-50 sticky left-0">
              <%= material.name %>
            </td>
            <td class="border-r border-gray-200 px-4 py-3 text-center text-gray-600 bg-gray-50">
              <%= material.waste_percentage %>%
            </td>
            <% @suppliers.each do |supplier| %>
              <% existing_rate = @existing_rates[[material.id, supplier.id]] %>
              <% rate_id = existing_rate&.id %>
              <td class="border-r border-gray-200 px-4 py-3 text-center">
                <div class="flex items-center justify-center gap-2">
                  <div class="flex items-center gap-1">
                    <span class="text-gray-700 font-medium">R</span>
                    <input
                      type="number"
                      class="rate-input w-28 text-center px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                      value="<%= existing_rate&.rate %>"
                      placeholder="-"
                      step="0.01"
                      min="0"
                      data-material-id="<%= material.id %>"
                      data-supplier-id="<%= supplier.id %>"
                      data-rate-id="<%= rate_id %>"
                      data-monthly-rate-id="<%= @monthly_material_supply_rate.id %>"
                    />
                  </div>
                  <% if existing_rate&.rate.to_f > 0 %>
                    <input
                      type="checkbox"
                      class="winner-checkbox w-4 h-4 cursor-pointer"
                      <%= 'checked' if existing_rate&.is_winner %>
                      data-rate-id="<%= rate_id %>"
                      data-material-id="<%= material.id %>"
                      data-supplier-id="<%= supplier.id %>"
                      data-monthly-rate-id="<%= @monthly_material_supply_rate.id %>"
                      title="Select as winning supplier for this material"
                    />
                  <% end %>
                </div>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
    </div>
  </div>

  <div class="mt-6 flex gap-3 flex-wrap">
    <%= link_to "Back to Monthly Rates", monthly_material_supply_rates_path, class: "rounded-md px-6 py-2.5 bg-gray-100 hover:bg-gray-50 text-gray-900 font-medium" %>
    
    <%= button_to "ğŸ¤– Set 2nd Cheapest as Winners", 
      set_2nd_cheapest_as_winners_monthly_material_supply_rate_path(@monthly_material_supply_rate),
      method: :post,
      class: "rounded-md px-6 py-2.5 bg-amber-500 hover:bg-amber-600 text-white font-medium transition",
      data: { turbo_confirm: "Auto-select 2nd cheapest supplier for all materials?" }
    %>
    
    <button
      data-material-supply-rates-target="saveAllButton"
      class="hidden rounded-md px-6 py-2.5 bg-blue-500 hover:bg-blue-600 text-white font-medium transition"
      data-action="material-supply-rates#saveAll"
    >
      ğŸ’¾ Save All
    </button>
    <%= link_to "Manage Materials", material_supplies_path, class: "rounded-md px-6 py-2.5 bg-blue-500 hover:bg-blue-600 text-white font-medium" %>
    <%= link_to "Manage Suppliers", suppliers_path, class: "rounded-md px-6 py-2.5 bg-blue-500 hover:bg-blue-600 text-white font-medium" %>
  </div>
</div>


