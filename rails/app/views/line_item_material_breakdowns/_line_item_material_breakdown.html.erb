<%= turbo_frame_tag dom_id(line_item_material_breakdown) do %>
  <div class="card bg-base-100 shadow-md mb-4" data-controller="line-item-material-breakdown">
    <% if local_assigns[:show_success] %>
      <div class="alert alert-success shadow-lg" role="alert">
        <div class="flex items-center gap-2">
          <i class="fas fa-check-circle text-lg"></i>
          <span>Changes saved successfully</span>
        </div>
      </div>
    <% end %>
    <!-- Header -->
    <div class="card-body pb-3">
      <div class="flex items-center justify-between gap-4">
        <div>
          <h3 class="card-title text-lg font-bold">Material Breakdown</h3>
        </div>
        <div class="flex-grow">
          <%= form_with url: update_section_category_line_item_material_breakdown_path(line_item_material_breakdown), method: :patch, class: "flex items-center justify-end gap-2", data: { turbo_stream: true } do |f| %>
            <div class="form-control flex-grow max-w-md">
              <%= f.collection_select :section_category_id, SectionCategory.all, :id, :display_name, 
                  { selected: line_item_material_breakdown.tender_line_item&.section_category_id, prompt: "Section Category..." }, 
                  { class: "select select-sm select-bordered w-full" } %>
            </div>
            <%= f.submit "Save", class: "btn btn-sm btn-primary" %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Material Rows Table Header -->
    <div class="px-6 pb-3 border-t">
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-7 gap-4 text-xs font-semibold text-gray-600 uppercase tracking-wide">
        <div class="col-span-1 lg:col-span-2">Material</div>
        <div>Waste</div>
        <div>Rate (R)</div>
        <div>Proportion (%)</div>
        <div class="text-right">Total</div>
        <div></div>
      </div>
    </div>

    <!-- Material Rows -->
    <div class="border-t" id="line_item_materials_container_<%= line_item_material_breakdown.id %>">
      <% if line_item_material_breakdown.line_item_materials.any? %>
        <% line_item_material_breakdown.line_item_materials.each do |material| %>
          <div data-line-item-material-breakdown-target="materialRow">
            <%= render partial: 'line_item_materials/line_item_material', locals: { line_item_material: material } %>
          </div>
        <% end %>
      <% else %>
        <div class="px-6 py-4 text-center text-gray-500 text-sm" id="no_materials_message_<%= line_item_material_breakdown.id %>">
          No materials added yet.
        </div>
      <% end %>
    </div>

    <!-- Add Material Button -->
    <div class="px-6 py-3 border-t bg-gray-50">
      <%= button_to line_item_materials_path,
          method: :post,
          params: { line_item_material: { line_item_material_breakdown_id: line_item_material_breakdown.id } },
          class: "btn btn-sm btn-outline" do %>
        <i class="fa-solid fa-plus"></i> Add Material
      <% end %>
    </div>

    <%= render 'line_item_material_breakdowns/totals_section', line_item_material_breakdown: line_item_material_breakdown %>
  </div>
<% end %>
