<% content_for :title, "Material Breakdown - #{@line_item_material_breakdown.tender_line_item.item_number}" %>

<div class="container mx-auto p-6">
  <% if notice.present? %>
    <div class="alert alert-success mb-6">
      <i class="fas fa-check-circle"></i>
      <span><%= notice %></span>
    </div>
  <% end %>

  <% tli = @line_item_material_breakdown.tender_line_item %>
  <% total_material_cost = @line_item_material_breakdown.line_item_materials.sum { |lim| 
    (lim.material_supply.material_supply_rates.last&.rate || 0) * lim.proportion 
  } %>

  <!-- Line Item Header -->
  <div class="card bg-base-100 shadow mb-6">
    <div class="card-body">
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div>
          <p class="text-sm font-semibold text-gray-600">Item</p>
          <p class="text-lg font-bold"><%= tli.item_number %></p>
        </div>
        <div class="md:col-span-2">
          <p class="text-sm font-semibold text-gray-600">Description</p>
          <p class="text-lg font-bold"><%= tli.item_description %></p>
        </div>
        <div>
          <p class="text-sm font-semibold text-gray-600">Unit</p>
          <p class="text-lg font-bold"><%= tli.unit_of_measure %></p>
        </div>
        <div>
          <p class="text-sm font-semibold text-gray-600">Quantity</p>
          <p class="text-lg font-bold"><%= number_with_precision(tli.quantity, precision: 2) %></p>
        </div>
        <div>
          <p class="text-sm font-semibold text-gray-600">Rate/Unit</p>
          <p class="text-lg font-bold text-green-600">₹ <%= number_with_precision(total_material_cost, precision: 2) %></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Calculation Breakdown Table -->
  <div class="card bg-base-100 shadow mb-6">
    <div class="card-body">
      <h3 class="text-xl font-bold mb-4">Calculation breakdown:</h3>
      
      <div class="overflow-x-auto">
        <table class="table table-sm w-full">
          <thead>
            <tr>
              <th>Material Supply</th>
              <th class="text-right">Waste %</th>
              <th class="text-right">Material Rate</th>
              <th class="text-right">Proportion %</th>
              <th class="text-right">RATE/UNIT</th>
              <th class="text-center">Action</th>
            </tr>
          </thead>
          <tbody id="materials-tbody">
            <% @line_item_material_breakdown.line_item_materials.includes(:material_supply).each do |lim| %>
              <tr class="material-row hover">
                <td class="font-medium"><%= lim.material_supply.name %></td>
                <td class="text-right"><%= number_with_precision(lim.material_supply.waste_percentage, precision: 2) %>%</td>
                <td class="text-right">₹ <%= number_with_precision(lim.material_supply.material_supply_rates.last&.rate || 0, precision: 2) %></td>
                <td class="text-right"><%= number_with_precision(lim.proportion * 100, precision: 2) %>%</td>
                <td class="text-right font-semibold">₹ <%= number_with_precision((lim.material_supply.material_supply_rates.last&.rate || 0) * lim.proportion, precision: 2) %></td>
                <td class="text-center">
                  <%= link_to "✎", edit_line_item_material_path(lim), class: "btn btn-xs btn-ghost" %>
                  <%= button_to "✕", lim, method: :delete, class: "btn btn-xs btn-ghost text-red-500", data: { turbo_confirm: "Remove this material?" } %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Add Material Button -->
      <div class="mt-4 flex gap-2">
        <%= link_to "+ Add Material", new_line_item_material_path(tender_line_item_id: tli.id, line_item_material_breakdown_id: @line_item_material_breakdown.id), class: "btn btn-primary btn-sm" %>
      </div>

      <!-- Summary Section -->
      <div class="mt-8 pt-6 border-t border-gray-300">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="flex justify-between items-center py-3 border-b">
            <span class="font-semibold text-lg">SUB TOTAL</span>
            <span class="text-lg font-bold text-blue-600">₹ <%= number_with_precision(total_material_cost, precision: 2) %></span>
          </div>
          <div class="flex justify-between items-center py-3 border-b">
            <span class="font-semibold text-lg">Margin</span>
            <div class="flex gap-2">
              <input type="number" step="0.01" min="0" class="input input-sm input-bordered w-20" id="margin-input" value="0.00">
              <span class="text-lg font-bold">₹ <span id="margin-amount">0.00</span></span>
            </div>
          </div>
          <div class="flex justify-between items-center py-3 border-b border-2 border-green-500 bg-green-50 rounded">
            <span class="font-bold text-lg">TOTAL</span>
            <span class="text-lg font-bold text-green-600">₹ <span id="total-amount"><%= number_with_precision(total_material_cost, precision: 2) %></span></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="mt-6 flex gap-2 flex-wrap">
    <%= link_to "Back to Tender", tender_path(tli.tender), class: "btn btn-ghost" %>
    <%= link_to "Back to Breakdowns", line_item_material_breakdowns_path, class: "btn btn-ghost" %>
  </div>
</div>

<script>
  const subtotal = <%= total_material_cost %>;
  
  document.getElementById('margin-input').addEventListener('change', function() {
    const margin = parseFloat(this.value) || 0;
    const marginAmount = (subtotal * margin / 100);
    const total = subtotal + marginAmount;
    
    document.getElementById('margin-amount').textContent = marginAmount.toFixed(2);
    document.getElementById('total-amount').textContent = total.toFixed(2);
  });
</script>
