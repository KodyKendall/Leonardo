<!-- Totals Section -->
<div class="px-6 py-4 bg-gray-50 border-t space-y-3" id="material_breakdown_totals_<%= line_item_material_breakdown.id %>">
  <div class="flex justify-between text-xs">
    <span class="text-gray-600">Subtotal:</span>
    <span class="font-semibold text-gray-900" data-line-item-material-breakdown-target="subtotalDisplay">R<%= number_with_precision(line_item_material_breakdown.subtotal, precision: 2, delimiter: ",") %></span>
  </div>

  <%= form_with model: line_item_material_breakdown,
               url: line_item_material_breakdown_path(line_item_material_breakdown),
               method: :patch,
               class: "space-y-3",
               data: {
                 turbo_stream: true,
                 controller: "margin-form",
                 action: "turbo:submit-end->margin-form#handleSuccess"
               } do |f| %>
    <div class="flex justify-between text-xs items-center gap-2">
      <span class="text-gray-600">Markup:</span>
      <div class="flex items-center gap-2">
        <div class="join">
          <%= f.number_field :margin_percentage,
              placeholder: "0",
              step: 0.1,
              class: "input input-bordered input-xs w-16 text-right join-item text-xs border-gray-300",
              data: {
                line_item_material_breakdown_target: "marginInput",
                margin_form_target: "input",
                controller: "autoselect",
                action: "focus->autoselect#select input->line-item-material-breakdown#markDirty input->line-item-material-breakdown#recalculate keydown->margin-form#submitOnEnter input->margin-form#save"
              } %>
          <span class="btn btn-xs no-animation join-item text-xs">%</span>
        </div>
      </div>
    </div>

    <!-- Before Rounding row -->
    <div class="flex justify-between text-xs text-purple-600">
      <span>Before Rounding:</span>
      <span class="font-semibold" data-line-item-material-breakdown-target="beforeRoundingDisplay">R<%= number_with_precision(line_item_material_breakdown.total_before_rounding, precision: 2, delimiter: ",") %></span>
    </div>

    <!-- Final Total row -->
    <div class="flex justify-between items-center border-t pt-3 bg-green-50 -mx-6 px-6 py-2">
      <div class="flex items-center gap-2">
        <span class="text-sm font-semibold text-gray-700">Material Supply Total:</span>
        <div class="flex items-center gap-1 ml-2">
          <span class="text-[10px] text-gray-500 italic">Round up to nearest:</span>
          <%= f.select :rounding_interval, 
              [['None', 0], 10, 20, 50, 100], 
              {}, 
              { 
                class: "select select-bordered select-xs text-[10px] h-6 min-h-6 py-0",
                data: {
                  line_item_material_breakdown_target: "roundingIntervalInput",
                  action: "change->line-item-material-breakdown#markDirty change->line-item-material-breakdown#recalculate change->margin-form#save"
                }
              } %>
        </div>
      </div>
      <span class="text-lg font-bold text-green-600" data-line-item-material-breakdown-target="totalDisplay">R<%= number_with_precision(line_item_material_breakdown.total, precision: 2, delimiter: ",") %></span>
    </div>
  <% end %>
</div>
