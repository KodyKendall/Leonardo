<!-- Required LlamaBot Imports -->
<% if defined?(javascript_importmap_tags) %> <!-- Rails 7+ -->
  <%= javascript_importmap_tags %>
<% else %> <!-- Rails 6 -->
  <%= javascript_include_tag "application" %>
<% end %>

<%= javascript_include_tag "llama_bot_rails/application" %>
<% if defined?(action_cable_meta_tag) %>
  <%= action_cable_meta_tag %>
<% end %>

<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- marked.js for Markdown parsing (REQUIRED!) -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<!-- Custom styles for LlamaBot tool icons -->
<style>
  [data-llamabot="tool-icon"] {
    width: 16px !important;
    height: 16px !important;
    display: inline-block !important;
    vertical-align: middle !important;
  }

  [data-llamabot="tool-compact"] {
    display: inline-flex !important;
    align-items: center !important;
    gap: 0.5rem !important;
    padding: 0.5rem !important;
    font-size: 0.875rem !important;
  }
</style>

<div class="container mx-auto p-6">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold"><%= @boq.boq_name %></h1>
      <p class="text-gray-600 mt-1">
        <% if @boq.tender %>
          <span class="inline-flex items-center gap-2">
            <i class="fa-solid fa-folder text-orange-600"></i>
            <%= link_to @boq.tender.tender_name, tender_path(@boq.tender), class: "text-blue-600 hover:text-blue-800 font-medium" %>
          </span>
        <% elsif @boq.client_name %>
          <%= @boq.client_name %> 
          <% if @boq.client_reference %> ¬∑ <%= @boq.client_reference %><% end %>
        <% end %>
      </p>
    </div>
    <div class="flex gap-2">
      <% if @boq.tender %>
        <%= link_to "Back to Tender", tender_path(@boq.tender), class: "btn btn-ghost" %>
      <% else %>
        <%= link_to "Back to BOQs", boqs_path, class: "btn btn-ghost" %>
      <% end %>
    </div>
  </div>

  <!-- BOQ Metadata -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <h3 class="font-semibold text-sm mb-2">BOQ Details</h3>
        <div class="space-y-2 text-sm">
          <div><span class="font-medium">File:</span> <%= @boq.file_name %></div>
          <div><span class="font-medium">Status:</span> <span class="badge <%= @boq.status == 'parsed' ? 'badge-success' : 'badge-warning' %>"><%= @boq.status %></span></div>
          <div><span class="font-medium">Received:</span> <%= @boq.received_date&.to_formatted_s(:short) || "‚Äî" %></div>
          <div><span class="font-medium">Uploaded By:</span> <%= @boq.uploaded_by&.name || "‚Äî" %></div>
          <% if @boq.parsed_at %>
            <div><span class="font-medium">Parsed:</span> <%= @boq.parsed_at.to_formatted_s(:short) %></div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <h3 class="font-semibold text-sm mb-2">QS & Client Info</h3>
        <div class="space-y-2 text-sm">
          <% if @boq.qs_name %>
            <div><span class="font-medium">Quantity Surveyor:</span> <%= @boq.qs_name %></div>
          <% else %>
            <div class="text-gray-500">No QS name provided</div>
          <% end %>
        </div>
        <% if @boq.notes %>
          <div class="mt-3 text-sm bg-blue-50 p-2 rounded border border-blue-200">
            <span class="font-medium">Notes:</span> <%= simple_format(@boq.notes) %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- CSV Preview & Download -->
  <div class="card bg-base-100 shadow-sm mb-6">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h3 class="card-title text-lg">
          <i class="fas fa-file-csv"></i>
          CSV File
        </h3>
        <% if @boq.csv_file.attached? %>
          <%= link_to "Download", rails_blob_path(@boq.csv_file, disposition: "attachment"), class: "btn btn-sm btn-outline" %>
        <% end %>
      </div>

      <!-- Header Row Selector -->
      <% if @boq.csv_file.attached? %>
        <div class="card bg-blue-50 shadow-sm mb-6 border-l-4 border-blue-500">
          <div class="card-body">
            <h3 class="card-title text-lg mb-4">
              <i class="fas fa-list text-blue-600"></i>
              Step 1: Set the Header Row!
            </h3>
            <p class="text-sm text-gray-700 mb-4">This should be the row number that has all the headers, such as Item, Number, Description, Category, etc. at the top.</p>
            <div class="flex items-end gap-3">
              <div class="form-control flex-1">
                <label class="label">
                  <span class="label-text text-sm font-medium">Header row number</span>
                </label>
                <div class="flex items-center gap-2">
                  <input 
                    type="number" 
                    id="header-row-input" 
                    min="0" 
                    value="<%= @boq.header_row_index || 0 %>"
                    class="input input-sm input-bordered flex-1"
                    placeholder="Row number"
                  />
                  <button 
                    id="header-row-down-btn"
                    class="btn btn-sm btn-outline"
                    onclick="decrementHeaderRow()"
                    title="Decrease row number"
                  >
                    <i class="fas fa-minus"></i>
                  </button>
                  <button 
                    id="header-row-up-btn"
                    class="btn btn-sm btn-outline"
                    onclick="incrementHeaderRow()"
                    title="Increase row number"
                  >
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                <label class="label">
                  <span class="label-text-alt text-xs text-gray-500">Which row contains column headers?</span>
                </label>
              </div>
              <button 
                id="update-header-btn" 
                class="btn btn-lg btn-success gap-2 font-bold shadow-md hover:shadow-lg text-white"
                onclick="updateHeaderRow()"
              >
                <i class="fas fa-check-circle"></i>
                Apply Header Row
              </button>
            </div>
          </div>
        </div>
      <% end %>

      <!-- CSV Preview -->
      <% if @boq.csv_file.attached? %>
        <div id="csv-container" data-show-all="false">
          <div id="csv-preview" class="bg-gray-50 rounded border border-gray-200 p-4 overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm text-xs">
              <% 
                require 'csv'
                begin
                  csv_content = @boq.csv_file.download.force_encoding('UTF-8')
                  # Try parsing with liberal_parsing first for complex CSVs
                  all_rows = CSV.parse(csv_content, liberal_parsing: true) rescue CSV.parse(csv_content)
                  header_row_idx = @boq.header_row_index || 0
                  
                  # Get headers from the specified row
                  headers = all_rows[header_row_idx] || [] rescue []
                  
                  # Get preview rows (starting after header row, max 20)
                  preview_rows = []
                  preview_row_indices = []
                  all_rows.each_with_index do |row, idx|
                    next if idx <= header_row_idx || preview_rows.length >= 20
                    next if row.compact.empty?
                    preview_rows << row
                    preview_row_indices << idx
                  end
                  csv_parse_error = false
                rescue => e
                  csv_parse_error = true
                  csv_error_message = e.message
                  headers = []
                  preview_rows = []
                  preview_row_indices = []
                end
              %>
                <% if csv_parse_error %>
                  <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                      <p class="font-semibold mb-1">Unable to parse CSV preview</p>
                      <p class="text-sm"><%= csv_error_message %></p>
                      <p class="text-sm mt-2">This file may have a complex format. You can still download it or adjust the header row number above to help the parser.</p>
                    </div>
                  </div>
                <% elsif headers.any? %>
                <thead>
                  <tr>
                    <th class="bg-gray-100 font-semibold text-center w-12">#</th>
                    <% headers.each do |col| %>
                      <th><%= col %></th>
                    <% end %>
                  </tr>
                </thead>
                <tbody>
                  <% preview_rows.each_with_index do |row, idx| %>
                    <tr>
                      <td class="bg-gray-100 font-semibold text-center text-sm text-gray-600 w-12"><%= preview_row_indices[idx] %></td>
                      <% row.each do |col| %>
                        <td><%= col %></td>
                      <% end %>
                    </tr>
                  <% end %>
                </tbody>
                <% else %>
                  <tr><td colspan="10" class="text-center text-gray-500 py-4">No data to display</td></tr>
                <% end %>
            </table>
          </div>

          <div id="csv-full" class="bg-gray-50 rounded border border-gray-200 p-4 overflow-x-auto hidden" style="max-height: 600px; overflow-y: auto;">
            <table class="table table-sm text-xs">
              <% 
                # Use same logic for full view
                unless csv_parse_error
                  full_rows = []
                  full_row_indices = []
                  all_rows.each_with_index do |row, idx|
                    next if idx <= header_row_idx || row.compact.empty?
                    full_rows << row
                    full_row_indices << idx
                  end
                else
                  full_rows = []
                  full_row_indices = []
                end
              %>
                <% if headers.any? %>
                <thead>
                  <tr>
                    <th class="bg-gray-100 font-semibold text-center w-12">#</th>
                    <% headers.each do |col| %>
                      <th><%= col %></th>
                    <% end %>
                  </tr>
                </thead>
                <tbody>
                  <% full_rows.each_with_index do |row, idx| %>
                    <tr>
                      <td class="bg-gray-100 font-semibold text-center text-sm text-gray-600 w-12"><%= full_row_indices[idx] %></td>
                      <% row.each do |col| %>
                        <td><%= col %></td>
                      <% end %>
                    </tr>
                  <% end %>
                </tbody>
                <% else %>
                  <tr><td colspan="10" class="text-center text-gray-500 py-4">No data to display</td></tr>
                <% end %>
            </table>
          </div>

          <% 
            total_rows = csv_parse_error ? 0 : (all_rows.count - header_row_idx - 1)
            if !csv_parse_error && total_rows > 20
          %>
            <div class="flex justify-between items-center mt-3">
              <div class="text-xs text-gray-500">
                <span id="row-count">Showing first 20 rows of <%= total_rows %> total data rows</span>
              </div>
              <div class="flex gap-2">
                <button id="copy-all-btn" class="btn btn-sm btn-ghost" onclick="copyAllToClipboard()">
                  <i class="fas fa-copy"></i> Copy All
                </button>
                <button id="view-all-btn" class="btn btn-sm btn-ghost" onclick="toggleViewAll()">
                  <i class="fas fa-expand"></i> View All
                </button>
              </div>
            </div>
          <% end %>
        </div>

        <script>
          function incrementHeaderRow() {
            const input = document.getElementById('header-row-input');
            input.value = Math.max(0, parseInt(input.value, 10) + 1);
          }

          function decrementHeaderRow() {
            const input = document.getElementById('header-row-input');
            input.value = Math.max(0, parseInt(input.value, 10) - 1);
          }

          function copyAllToClipboard() {
            const boqId = window.location.pathname.split('/').pop();
            const headerRowIdx = parseInt(document.getElementById('header-row-input').value, 10) || 0;
            
            // Show loading state
            const btn = document.getElementById('copy-all-btn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Copying...';
            
            try {
              // Fetch complete CSV data from API with header row offset
              fetch(`/boqs/${boqId}/csv_as_json?header_row_index=${headerRowIdx}`)
                .then(response => {
                  if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  return response.json();
                })
                .then(jsonArray => {
                  // Convert to formatted JSON string
                  const jsonString = JSON.stringify(jsonArray, null, 2);
                  
                  // Copy to clipboard
                  navigator.clipboard.writeText(jsonString).then(() => {
                    showToast(`JSON copied to clipboard! (${jsonArray.length} rows)`, 'success');
                  }).catch(err => {
                    console.error('Clipboard API failed:', err);
                    copyJSONAsText(jsonString);
                  });
                })
                .catch(err => {
                  console.error('Failed to fetch CSV data:', err);
                  showToast('Failed to fetch CSV data', 'error');
                })
                .finally(() => {
                  btn.disabled = false;
                  btn.innerHTML = originalHTML;
                });
            } catch (err) {
              console.error('Error:', err);
              showToast('Failed to copy CSV data', 'error');
              btn.disabled = false;
              btn.innerHTML = originalHTML;
            }
          }

          function copyJSONAsText(jsonString) {
            const textarea = document.createElement('textarea');
            textarea.value = jsonString;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            
            try {
              textarea.select();
              document.execCommand('copy');
              showToast('JSON copied to clipboard!', 'success');
            } catch (err) {
              console.error('Fallback copy failed:', err);
              showToast('Failed to copy to clipboard', 'error');
            } finally {
              document.body.removeChild(textarea);
            }
          }

          function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} shadow-lg fixed top-4 right-4 z-50 flex items-center gap-2 animate-fade-in max-w-sm`;
            toast.innerHTML = `
              <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
              <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
              toast.classList.add('animate-fade-out');
              setTimeout(() => toast.remove(), 300);
            }, 3000);
          }

          function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            document.body.appendChild(container);
            return container;
          }
        </script>

        <style>
          @keyframes fadeIn {
            from {
              opacity: 0;
              transform: translateY(10px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
          
          @keyframes fadeOut {
            from {
              opacity: 1;
              transform: translateY(0);
            }
            to {
              opacity: 0;
              transform: translateY(10px);
            }
          }
          
          .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
          }
          
          .animate-fade-out {
            animation: fadeOut 0.3s ease-out;
          }
        </style>

        <script>
          function toggleViewAll() {
            const container = document.getElementById('csv-container');
            const preview = document.getElementById('csv-preview');
            const full = document.getElementById('csv-full');
            const btn = document.getElementById('view-all-btn');
            const rowCount = document.getElementById('row-count');
            const showAll = container.getAttribute('data-show-all') === 'true';
            
            if (showAll) {
              // Hide all, show preview
              preview.classList.remove('hidden');
              full.classList.add('hidden');
              container.setAttribute('data-show-all', 'false');
              btn.innerHTML = '<i class="fas fa-expand"></i> View All';
              rowCount.textContent = 'Showing first 20 rows of <%= total_rows %> total data rows';
            } else {
              // Show all
              preview.classList.add('hidden');
              full.classList.remove('hidden');
              container.setAttribute('data-show-all', 'true');
              btn.innerHTML = '<i class="fas fa-compress"></i> View Less';
              rowCount.textContent = 'Showing all <%= total_rows %> data rows';
            }
          }

          async function updateHeaderRow() {
            const headerInput = document.getElementById('header-row-input');
            const headerRowIdx = parseInt(headerInput.value, 10);
            const boqId = window.location.pathname.split('/').pop();
            const btn = document.getElementById('update-header-btn');
            const originalHTML = btn.innerHTML;

            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';

            try {
              const response = await fetch(`/boqs/${boqId}/update_header_row`, {
                method: 'PATCH',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify({ header_row_index: headerRowIdx })
              });

              if (!response.ok) {
                const errorData = await response.json();
                showToast(errorData.error || 'Failed to update header row', 'error');
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                return;
              }

              const data = await response.json();
              
              // Update the table with new headers and preview
              updateCSVPreview(data.headers, data.preview_rows, data.total_rows);
              
              showToast('Header row updated successfully!', 'success');
            } catch (error) {
              console.error('Error updating header row:', error);
              showToast('Failed to update header row', 'error');
            } finally {
              btn.disabled = false;
              btn.innerHTML = originalHTML;
            }
          }

          function updateCSVPreview(headers, previewRows, totalRows) {
            const previewTable = document.querySelector('#csv-preview table');
            const fullTable = document.querySelector('#csv-full table');
            const rowCountSpan = document.getElementById('row-count');

            if (!previewTable) return;

            // Build header row HTML with row index column
            let headerHTML = '<thead><tr>';
            headerHTML += '<th class="bg-gray-100 font-semibold text-center w-12">#</th>';
            headers.forEach(header => {
              headerHTML += `<th>${escapeHtml(header)}</th>`;
            });
            headerHTML += '</tr></thead>';

            // Build preview rows HTML with row indices
            let previewBodyHTML = '<tbody>';
            previewRows.forEach(row => {
              previewBodyHTML += '<tr>';
              previewBodyHTML += `<td class="bg-gray-100 font-semibold text-center text-sm text-gray-600 w-12">${escapeHtml(row.row_index.toString())}</td>`;
              row.columns.forEach(col => {
                previewBodyHTML += `<td>${escapeHtml(col)}</td>`;
              });
              previewBodyHTML += '</tr>';
            });
            previewBodyHTML += '</tbody>';

            // Update preview table
            previewTable.innerHTML = headerHTML + previewBodyHTML;

            // Update full table if it exists
            if (fullTable) {
              fullTable.innerHTML = headerHTML + previewBodyHTML;
            }

            // Update row count
            if (rowCountSpan) {
              if (totalRows > 20) {
                rowCountSpan.textContent = `Showing first 20 rows of ${totalRows} total data rows`;
              } else {
                rowCountSpan.textContent = `Showing all ${totalRows} data rows`;
              }
            }
          }

          function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          }
        </script>
      <% else %>
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <div>No CSV file attached yet</div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Quick Actions / Suggested Prompts -->
  <div class="card bg-base-100 shadow-sm mb-6 border-l-4 border-blue-500">
    <div class="card-body">
      <h3 class="card-title text-lg mb-4">
        <i class="fas fa-list-check text-blue-600"></i>
        Parsing Steps
      </h3>
      <div class="space-y-3">
        <button 
          id="analyze-structure-btn"
          data-llamabot="suggested-prompt"
          class="w-full btn btn-lg btn-success gap-2 font-bold shadow-md hover:shadow-lg text-white"
        >
          <i class="fas fa-magic"></i> 
          <span>Step 2: Parse BOQ</span>
        </button>
        <p class="text-xs text-gray-600 ml-6">Click to populate the parsing request</p>
      </div>
    </div>
  </div>

  <!-- AI BOQ Parser Chat Interface (LlamaBot) -->
  <div class="card bg-base-100 shadow-sm mb-6">
    <div class="card-body">
      <h2 class="card-title mb-4">
        <i class="fas fa-llama"></i>
        BOQ Parser
      </h2>
      <p class="text-sm text-gray-600 mb-4">
        Chat with Leo to parse the CSV file and automatically create line items. Follow the steps above to get started.
      </p>
      
      <!-- LlamaBot Chat Container -->
      <div data-llamabot="chat-container" class="flex flex-col border border-gray-200 rounded-lg bg-white overflow-hidden" style="height: 500px;">
        <!-- Header -->
        <div class="flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200 p-4">
          <div class="flex items-center gap-2">
            <i class="fas fa-llama text-indigo-600"></i>
            <span class="font-semibold text-gray-800">Leo</span>
          </div>
          <div data-llamabot="connection-status" class="h-3 w-3 rounded-full bg-green-400 animate-pulse"></div>
        </div>

        <!-- Message History -->
        <div data-llamabot="message-history" class="flex-grow overflow-y-auto p-4 bg-gray-50"></div>

        <!-- Thinking Area -->
        <div data-llamabot="thinking-area" class="hidden bg-blue-50 border-t border-blue-200 px-4 py-3 text-sm text-blue-700"></div>

        <!-- Input Area -->
        <div class="border-t border-gray-200 bg-white p-4">
          <div class="text-xs font-semibold text-gray-600 mb-4 uppercase tracking-wide text-right">Step 3: Hit Send</div>
          <div class="flex gap-2">
            <textarea 
              data-llamabot="message-input" 
              placeholder="Ask the AI to parse the BOQ..." 
              class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm resize-none"
              rows="4"
            ></textarea>
            <button 
              data-llamabot="send-button" 
              class="btn btn-success btn-lg gap-2 font-bold shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed text-white"
              disabled
            >
              <i class="fas fa-paper-plane"></i>
              <span class="hidden sm:inline">Send</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 4: Verify and Parse -->
  <div class="card bg-base-100 shadow-sm mb-6 border-l-4 border-green-500">
    <div class="card-body">
      <h3 class="card-title text-lg mb-4">
        <i class="fas fa-check-circle text-green-600"></i>
        Step 4: Verify and Parse into BOQ Items!
      </h3>
      <p class="text-sm text-gray-600 mb-4">After reviewing the AI's response above, click the button below to confirm and create the BOQ line items.</p>
      <button 
        id="confirm-parse-btn"
        class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors flex items-center justify-center gap-2 font-medium"
      >
        <i class="fas fa-check"></i> 
        <span>Confirm and Parse into BOQ Items</span>
      </button>
    </div>
  </div>

  <!-- BOQ Items -->
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="card-title mb-0">
          <i class="fas fa-list"></i>
          BOQ Line Items
          <span id="items-count" class="badge badge-lg"><%= @boq_items.count %></span>
        </h2>
        <div class="flex gap-2">
          <button 
            id="copy-table-btn" 
            class="btn btn-sm btn-outline gap-2"
            onclick="copyTableToClipboard()"
          >
            <i class="fas fa-copy"></i>
            Copy Table
          </button>
          <%= link_to export_boq_csv_boq_path(@boq, format: :csv), class: "btn btn-sm btn-outline gap-2" do %>
            <i class="fas fa-download"></i>
            Download CSV
          <% end %>
          <button 
            id="refresh-items-btn" 
            class="btn btn-sm btn-outline gap-2"
            onclick="refreshBoqItems()"
          >
            <i class="fas fa-refresh"></i>
            Refresh
          </button>
        </div>
      </div>

      <div id="items-container">
        <% if @boq_items.any? %>
          <div class="overflow-x-auto">
            <table class="table table-sm w-full">
              <thead>
                <tr>
                  <th>Page</th>
                  <th>Item Number</th>
                  <th>Description</th>
                  <th>UOM</th>
                  <th>Quantity</th>
                  <th>Notes</th>
                  <th>Category</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="items-tbody">
                <% @boq_items.each_with_index do |item, idx| %>
                  <tr class="boq-item-row" data-item-id="<%= item.id %>" data-category-key="<%= item.section_category || "" %>" data-category-display="<%= BoqItem.section_categories[item.section_category] || "" %>">
                    <td class="font-mono text-sm editable-cell" data-field="page_number" title="Click to edit"><%= item.page_number || "‚Äî" %></td>
                    <td class="font-mono text-sm editable-cell" data-field="item_number" title="Click to edit"><%= item.item_number || "‚Äî" %></td>
                    <td class="editable-cell" data-field="item_description" title="Click to edit">
                      <div class="text-sm"><%= truncate(item.item_description, length: 60) %></div>
                    </td>
                    <td class="editable-cell" data-field="unit_of_measure" title="Click to edit"><%= item.unit_of_measure || "‚Äî" %></td>
                    <td class="text-right font-semibold editable-cell" data-field="quantity" title="Click to edit"><%= item.quantity || "‚Äî" %></td>
                    <td class="text-xs text-gray-500"><%= truncate(item.notes, length: 40) if item.notes %></td>
                    <td class="editable-cell" data-field="section_category" title="Click to edit"><span class="badge badge-sm"><%= item.category_human_readable || "‚Äî" %></span></td>
                    <td class="text-center">
                      <button class="btn btn-xs btn-ghost edit-row-btn" onclick="editRow(this, <%= item.id %>)" title="Edit this row">
                        <i class="fas fa-edit"></i>
                      </button>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div id="empty-state" class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <div>No line items yet. Parse the BOQ to extract items.</div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Next Step: Copy BOQ into Tender -->
  <% if @boq_items.any? && @boq.tender_id.present? %>
    <% tender = Tender.find_by(id: @boq.tender_id) %>
    <% if tender %>
      <div id="next-step-card" class="card bg-base-100 shadow-sm mb-6 border-l-4 border-blue-500">
        <div class="card-body">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <h3 class="card-title text-lg mb-2">
                <i class="fas fa-arrow-right text-blue-600"></i>
                Next Step
              </h3>
              <p class="text-gray-700">
                Copy BOQ into <strong><%= tender.tender_name %></strong>
              </p>
              <p class="text-sm text-gray-500 mt-2">
                Ready to be transferred to the tender builder.
              </p>
            </div>
            <div>
              <%= link_to "/tenders/#{tender.id}/builder", class: "btn btn-success btn-lg gap-2 font-bold shadow-md hover:shadow-lg text-white" do %>
                <i class="fas fa-hammer"></i>
                <span>Build Tender</span>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <script>
    // Copy table contents to clipboard with fallback
    function copyTableToClipboard() {
      const table = document.querySelector('#items-tbody');
      const btn = document.getElementById('copy-table-btn');
      const originalHTML = btn.innerHTML;
      
      if (!table) {
        showToast('No table data to copy', 'error');
        return;
      }
      
      try {
        let tableText = '';
        const rows = table.querySelectorAll('tr');
        
        rows.forEach(row => {
          const cells = row.querySelectorAll('td');
          const rowData = [];
          
          // Get all cells except the last one (Actions column)
          for (let i = 0; i < cells.length - 1; i++) {
            let cellText = cells[i].textContent.trim();
            // Remove extra whitespace and newlines
            cellText = cellText.replace(/\s+/g, ' ');
            rowData.push(cellText);
          }
          
          tableText += rowData.join('\t') + '\n';
        });
        
        // Try modern Clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(tableText).then(() => {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            showToast(`Copied ${rows.length} rows to clipboard`, 'success');
            
            setTimeout(() => {
              btn.disabled = false;
              btn.innerHTML = originalHTML;
            }, 2000);
          }).catch(err => {
            console.warn('Clipboard API failed, using fallback:', err);
            copyTableFallback(tableText, rows.length, btn, originalHTML);
          });
        } else {
          // Fallback for restricted environments
          copyTableFallback(tableText, rows.length, btn, originalHTML);
        }
      } catch (error) {
        console.error('Error copying table:', error);
        showToast('Failed to copy table data', 'error');
      }
    }

    // Fallback method using textarea selection
    function copyTableFallback(tableText, rowCount, btn, originalHTML) {
      const textarea = document.createElement('textarea');
      textarea.value = tableText;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      textarea.style.top = '0';
      textarea.style.left = '0';
      document.body.appendChild(textarea);
      
      try {
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        showToast(`Copied ${rowCount} rows to clipboard`, 'success');
        
        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
        }, 2000);
      } catch (err) {
        console.error('Fallback copy failed:', err);
        showToast('Failed to copy to clipboard', 'error');
      } finally {
        document.body.removeChild(textarea);
      }
    }

    // Editable table functionality
    function editRow(button, itemId) {
      const row = button.closest('tr');
      const isEditing = row.classList.contains('editing-mode');
      
      if (isEditing) {
        // Cancel edit mode
        cancelEdit(row);
      } else {
        // Enter edit mode
        enableEditMode(row, itemId);
      }
    }

    function enableEditMode(row, itemId) {
      row.classList.add('editing-mode');
      
      // Get the edit button and change it to show cancel/save
      const editBtn = row.querySelector('.edit-row-btn');
      editBtn.innerHTML = '<i class="fas fa-times"></i>';
      editBtn.classList.add('btn-error');
      editBtn.classList.remove('btn-ghost');
      editBtn.title = 'Cancel editing';
      
      // Add save button next to cancel button
      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn btn-xs btn-success ml-1';
      saveBtn.innerHTML = '<i class="fas fa-check"></i>';
      saveBtn.title = 'Save changes';
      saveBtn.onclick = () => saveRowChanges(row, itemId);
      editBtn.parentElement.appendChild(saveBtn);
      
      // Make cells editable
      const editableCells = row.querySelectorAll('.editable-cell');
      editableCells.forEach(cell => {
        const field = cell.getAttribute('data-field');
        let currentValue = cell.textContent.trim().replace('‚Äî', '');
        
        // Create appropriate input based on field type
        let input;
        if (field === 'section_category') {
          // For category, get the display value from row data attribute
          const categoryDisplay = row.getAttribute('data-category-display') || currentValue;
          input = createCategorySelect(field, categoryDisplay);
        } else if (field === 'quantity' || field === 'page_number') {
          input = document.createElement('input');
          input.type = 'number';
          input.step = field === 'quantity' ? '0.01' : '1';
          input.value = currentValue;
          input.className = 'input input-bordered input-sm w-full';
        } else {
          input = document.createElement('input');
          input.type = field === 'item_description' ? 'text' : 'text';
          input.value = currentValue;
          input.className = 'input input-bordered input-sm w-full';
        }
        
        input.setAttribute('data-field', field);
        cell.innerHTML = '';
        cell.appendChild(input);
      });
    }

    function createCategorySelect(field, currentValue) {
      const select = document.createElement('select');
      select.className = 'select select-bordered select-sm w-full';
      select.setAttribute('data-field', field);
      
      const categories = [
        'Blank',
        'Steel Sections',
        'Paintwork',
        'Bolts',
        'Gutter Meter',
        'M16 Mechanical Anchor',
        'M16 Chemical',
        'M20 Chemical',
        'M24 Chemical',
        'M16 HD Bolt',
        'M20 HD Bolt',
        'M24 HD Bolt',
        'M30 HD Bolt',
        'M36 HD Bolt',
        'M42 HD Bolt'
      ];
      
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        option.selected = cat === currentValue;
        select.appendChild(option);
      });
      
      return select;
    }

    function cancelEdit(row) {
      row.classList.remove('editing-mode');
      
      // Remove save button
      const saveBtn = row.querySelector('.btn-success');
      if (saveBtn) saveBtn.remove();
      
      // Reset edit button
      const editBtn = row.querySelector('.edit-row-btn');
      editBtn.innerHTML = '<i class="fas fa-edit"></i>';
      editBtn.classList.remove('btn-error');
      editBtn.classList.add('btn-ghost');
      editBtn.title = 'Edit this row';
      
      // Reload the row from the server to restore original values
      const itemId = row.getAttribute('data-item-id');
      reloadRow(row, itemId);
    }

    async function saveRowChanges(row, itemId) {
      const editBtn = row.querySelector('.edit-row-btn');
      const saveBtn = row.querySelector('.btn-success');
      const originalEditHTML = editBtn.innerHTML;
      const originalSaveHTML = saveBtn.innerHTML;
      
      // Show loading state
      editBtn.disabled = true;
      saveBtn.disabled = true;
      editBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      
      try {
        // Collect form data
        const formData = new FormData();
        const editableCells = row.querySelectorAll('.editable-cell');
        const updateData = {};
        
        editableCells.forEach(cell => {
          const field = cell.getAttribute('data-field');
          const input = cell.querySelector('input, select');
          if (input) {
            updateData[field] = input.value;
          }
        });
        
        // Send update request to boq_items controller
        const response = await fetch(`/boq_items/${itemId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({ boq_item: updateData })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          showToast('Failed to save changes: ' + (errorData.error || 'Unknown error'), 'error');
          editBtn.disabled = false;
          saveBtn.disabled = false;
          editBtn.innerHTML = originalEditHTML;
          saveBtn.innerHTML = originalSaveHTML;
          return;
        }
        
        const updatedItem = await response.json();
        showToast('Changes saved successfully!', 'success');
        
        // Exit edit mode
        row.classList.remove('editing-mode');
        saveBtn.remove();
        editBtn.innerHTML = originalEditHTML;
        editBtn.classList.remove('btn-error');
        editBtn.classList.add('btn-ghost');
        editBtn.title = 'Edit this row';
        editBtn.disabled = false;
        
        // Reload the row to display updated values
        reloadRow(row, itemId);
      } catch (error) {
        console.error('Error saving changes:', error);
        showToast('Failed to save changes', 'error');
        editBtn.disabled = false;
        saveBtn.disabled = false;
        editBtn.innerHTML = originalEditHTML;
        saveBtn.innerHTML = originalSaveHTML;
      }
    }

    async function reloadRow(row, itemId) {
      try {
        const boqId = window.location.pathname.split('/').pop();
        const response = await fetch(`/boq_items/${itemId}.json`);
        
        if (!response.ok) throw new Error('Failed to fetch item');
        
        const item = await response.json();
        
        // Update cells with new values
        const cells = {
          'page_number': item.page_number || '‚Äî',
          'item_number': item.item_number || '‚Äî',
          'item_description': item.item_description ? item.item_description.substring(0, 60) : '‚Äî',
          'section_category': `<span class="badge badge-sm">${item.section_category || '‚Äî'}</span>`,
          'unit_of_measure': item.unit_of_measure || '‚Äî',
          'quantity': item.quantity || '‚Äî'
        };
        
        row.querySelectorAll('.editable-cell').forEach(cell => {
          const field = cell.getAttribute('data-field');
          cell.innerHTML = cells[field];
        });
      } catch (error) {
        console.error('Error reloading row:', error);
        showToast('Error reloading row data', 'error');
      }
    }

    async function refreshBoqItems() {
      const btn = document.getElementById('refresh-items-btn');
      const originalHTML = btn.innerHTML;
      
      // Show loading state
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
      
      try {
        const boqId = window.location.pathname.split('/').pop();
        const response = await fetch(`/boqs/${boqId}.json`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const items = data.boq_items || [];
        
        // Update count badge
        document.getElementById('items-count').textContent = items.length;
        
        if (items.length === 0) {
          // Show empty state
          document.getElementById('items-container').innerHTML = `
            <div id="empty-state" class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              <div>No line items yet. Parse the BOQ to extract items.</div>
            </div>
          `;
          // Hide next step card if no items
          const nextStepCard = document.getElementById('next-step-card');
          if (nextStepCard) {
            nextStepCard.style.display = 'none';
          }
        } else {
          // Build table HTML - MATCH INITIAL TEMPLATE COLUMN ORDER EXACTLY
          let tableHTML = `
            <div class="overflow-x-auto">
              <table class="table table-sm w-full">
                <thead>
                  <tr>
                    <th>Page</th>
                    <th>Item Number</th>
                    <th>Description</th>
                    <th>UOM</th>
                    <th>Quantity</th>
                    <th>Notes</th>
                    <th>Category</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="items-tbody">
          `;
          
          items.forEach((item, idx) => {
            tableHTML += `
              <tr class="boq-item-row" data-item-id="${item.id}" data-category-key="${item.section_category || ""}" data-category-display="${item.section_category || ""}">
                <td class="font-mono text-sm editable-cell" data-field="page_number" title="Click to edit">${item.page_number || "‚Äî"}</td>
                <td class="font-mono text-sm editable-cell" data-field="item_number" title="Click to edit">${item.item_number || "‚Äî"}</td>
                <td class="editable-cell" data-field="item_description" title="Click to edit">
                  <div class="text-sm">${item.item_description ? item.item_description.substring(0, 60) : "‚Äî"}</div>
                </td>
                <td class="editable-cell" data-field="unit_of_measure" title="Click to edit">${item.unit_of_measure || "‚Äî"}</td>
                <td class="text-right font-semibold editable-cell" data-field="quantity" title="Click to edit">${item.quantity || "‚Äî"}</td>
                <td class="text-xs text-gray-500">${item.notes ? item.notes.substring(0, 40) : ''}</td>
                <td class="editable-cell" data-field="section_category" title="Click to edit"><span class="badge badge-sm">${item.section_category || "‚Äî"}</span></td>
                <td class="text-center">
                  <button class="btn btn-xs btn-ghost edit-row-btn" onclick="editRow(this, ${item.id})" title="Edit this row">
                    <i class="fas fa-edit"></i>
                  </button>
                </td>
              </tr>
            `;
          });
          
          tableHTML += `
                </tbody>
              </table>
            </div>
          `;
          
          document.getElementById('items-container').innerHTML = tableHTML;
          
          // Create next step card if items exist, tender is present, and card doesn't already exist
          if (items.length > 0 && data.tender_id) {
            let nextStepCard = document.getElementById('next-step-card');
            
            // Only create the card if it doesn't already exist
            if (!nextStepCard) {
              const cardsContainer = document.querySelector('.card.bg-base-100.shadow');
              if (cardsContainer && cardsContainer.parentNode) {
                nextStepCard = document.createElement('div');
                nextStepCard.id = 'next-step-card';
                nextStepCard.className = 'card bg-base-100 shadow-sm mb-6 border-l-4 border-blue-500';
                nextStepCard.innerHTML = `
                  <div class="card-body">
                    <div class="flex items-start justify-between gap-4">
                      <div class="flex-1">
                        <h3 class="card-title text-lg mb-2">
                          <i class="fas fa-arrow-right text-blue-600"></i>
                          Next Step
                        </h3>
                        <p class="text-gray-700">
                          Copy BOQ into <strong>${data.tender_name || 'Tender'}</strong>
                        </p>
                        <p class="text-sm text-gray-500 mt-2">
                          Ready to be transferred to the tender builder.
                        </p>
                      </div>
                      <div>
                        <a href="/tenders/${data.tender_id}/builder" class="btn btn-success btn-lg gap-2 font-bold shadow-md hover:shadow-lg text-white">
                          <i class="fas fa-hammer"></i>
                          <span>Build Tender</span>
                        </a>
                      </div>
                    </div>
                  </div>
                `;
                
                // Insert after the items card
                cardsContainer.parentNode.insertBefore(nextStepCard, cardsContainer.nextSibling);
              }
            }
            
            // Scroll to next step card
            if (nextStepCard) {
              nextStepCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
          }
        }
        
        // Show success toast
        showToast(`Loaded ${items.length} line items`, 'success');
      } catch (error) {
        console.error('Error refreshing items:', error);
        showToast('Failed to refresh items', 'error');
      } finally {
        // Restore button
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      }
    }
  </script>
</div>

<script type="module">
  console.log('üöÄ BOQ Chat: Initializing...');

  // Wait for ActionCable to be available, then initialize LlamaBot chat
  function waitForCableConnection(callback, maxWaitMs = 10000) {
    const startTime = Date.now();
    
    const interval = setInterval(() => {
      const elapsed = Date.now() - startTime;
      
      if (window.LlamaBotRails && window.LlamaBotRails.cable) {
        console.log('‚úÖ BOQ Chat: ActionCable ready');
        clearInterval(interval);
        callback(window.LlamaBotRails.cable);
      } else if (elapsed > maxWaitMs) {
        console.error('‚ùå BOQ Chat: ActionCable timeout after', maxWaitMs, 'ms');
        console.error('window.LlamaBotRails:', window.LlamaBotRails);
        clearInterval(interval);
      }
    }, 50);
  }

  async function initializeChat() {
    try {
      console.log('üì¶ BOQ Chat: Loading LlamaBot library from S3...');
      const cdnUrl = 'https://llamapress-cdn.s3.amazonaws.com/llamabot-chat-js-v0.2.19/index.js';
      console.log('üìç CDN URL:', cdnUrl);
      
      try {
        // Test CDN availability with a fetch first
        console.log('üîç Testing CDN connectivity...');
        const headResponse = await fetch(cdnUrl, { method: 'HEAD' });
        console.log('üåê CDN HEAD response status:', headResponse.status);
      } catch (fetchError) {
        console.warn('‚ö†Ô∏è CDN HEAD request failed (this may be okay):', fetchError.message);
      }
      
      // Import LlamaBot chat from S3 CDN
      console.log('üì• Attempting dynamic import...');
      let LlamaBot;
      try {
        const module = await import(cdnUrl);
        LlamaBot = module.default;
        console.log('‚úÖ BOQ Chat: LlamaBot library loaded successfully');
        console.log('LlamaBot object:', LlamaBot);
        console.log('LlamaBot.create:', typeof LlamaBot?.create);
      } catch (importError) {
        console.error('‚ùå Import failed with error:', importError);
        console.error('Error name:', importError.name);
        console.error('Error message:', importError.message);
        console.error('Error stack:', importError.stack);
        
        // Check if it's a CORS issue
        if (importError.message.includes('CORS') || importError.message.includes('Failed to fetch')) {
          console.error('üö® Likely CORS or network issue - CDN might be unreachable');
        }
        throw importError;
      }

      // Extract BOQ ID from current page URL
      const pathParts = window.location.pathname.split('/');
      const boqId = pathParts[pathParts.length - 1];
      console.log('BOQ ID extracted:', boqId);

      console.log('‚è≥ BOQ Chat: Waiting for ActionCable...');
      waitForCableConnection((consumer) => {
        try {
          console.log('üîå BOQ Chat: Initializing chat with consumer:', consumer);
          console.log('üìã LlamaBot.create type:', typeof LlamaBot.create);

          // Initialize the chat interface
          try {
            console.log('üéØ Calling LlamaBot.create with config...');
            const config = {
              actionCable: {
                consumer: consumer,
                channel: 'LlamaBotRails::ChatChannel',
                session_id: crypto.randomUUID()
              },
              agent: {
                name: 'boq_parser'  // Must match the key in langgraph.json
              },
              // Pass raw_params with each message
              messagePayload: {
                raw_params: {
                  boq_id: boqId
                }
              },
              // ERROR HANDLING: Register callback to handle and display error messages
              onError: (error) => {
                console.error('üî¥ [LlamaBot Error Handler] Error received:', error);
                console.error('üî¥ Error type:', typeof error);
                console.error('üî¥ Error keys:', Object.keys(error || {}));
                console.error('üî¥ Error content:', error?.content || error?.message || error);
                // The error callback is automatically called by LlamaBot when type="error" is received
                // LlamaBot will automatically render the error message in the chat
              },
              // Tailwind CSS classes for styling
              cssClasses: {
                humanMessage: 'bg-indigo-100 text-indigo-900 p-3 rounded-lg mb-2 max-w-xs',
                aiMessage: 'bg-blue-50 text-gray-900 p-3 rounded-lg mb-2 max-w-2xl prose prose-sm',
                errorMessage: 'bg-red-100 text-red-800 p-3 rounded-lg mb-2 max-w-xs',
                connectionStatusConnected: 'h-3 w-3 rounded-full bg-green-400 animate-pulse',
                connectionStatusDisconnected: 'h-3 w-3 rounded-full bg-red-400'
              }
            };
            console.log('üìù Config:', config);
            
            const chat = LlamaBot.create('[data-llamabot="chat-container"]', config);
            console.log('‚úÖ BOQ Chat: Initialized successfully');

            // CRITICAL FIX: Parse JSON string messages from LlamaBot Rails gem
            // The gem returns stringified JSON which must be parsed before passing to handlers
            if (chat.messageHandler && chat.messageHandler.handleMessage) {
              const originalHandleMessage = chat.messageHandler.handleMessage.bind(chat.messageHandler);
              chat.messageHandler.handleMessage = function(data) {
                // Parse data if it's a JSON string
                if (typeof data === 'string') {
                  try {
                    data = JSON.parse(data);
                  } catch (e) {
                    console.warn('‚ö†Ô∏è Could not parse message data as JSON');
                  }
                }
                
                // Handle double-wrapped messages from LlamaBot Rails gem
                if (data?.message && typeof data.message === 'string') {
                  try {
                    data = JSON.parse(data.message);
                  } catch (e) {
                    // Keep original data if parsing fails
                  }
                }
                
                return originalHandleMessage(data);
              };
            }

            // WORKAROUND: Fix ToolMessageRenderer._extractFilename to handle non-string paths
            // This prevents crashes when BOQ tools return database objects instead of file paths
            if (chat.messageRenderer?.toolRenderer) {
              const originalExtractFilename = chat.messageRenderer.toolRenderer._extractFilename;
              chat.messageRenderer.toolRenderer._extractFilename = function(path) {
                // Handle non-string paths (database tool outputs)
                if (typeof path !== 'string') {
                  console.log('‚ö†Ô∏è Non-string path detected, returning empty string');
                  return '';
                }
                // Call original for string paths (file tools)
                return originalExtractFilename.call(this, path);
              };
              console.log('‚úÖ Applied ToolMessageRenderer fix for BOQ database tools');
            }

            // DEBUGGING: Hook into handleEndMessage to see what's happening
            if (chat.messageRenderer && chat.messageRenderer.handleEndMessage) {
              const originalHandleEndMessage = chat.messageRenderer.handleEndMessage.bind(chat.messageRenderer);
              chat.messageRenderer.handleEndMessage = function() {
                console.log('üîç [DEBUG] handleEndMessage called!');
                console.log('Message history:', chat.messageRenderer.messageHistory);
                console.log('Message history children:', chat.messageRenderer.messageHistory?.children);
                return originalHandleEndMessage();
              };
              console.log('‚úÖ Hooked into handleEndMessage for debugging');
            }
          } catch (createError) {
            console.error('‚ùå BOQ Chat: LlamaBot.create error:', createError);
            console.error('Error name:', createError.name);
            console.error('Error message:', createError.message);
            console.error('Stack:', createError.stack);
            throw createError;
          }
        } catch (error) {
          console.error('‚ùå BOQ Chat: Callback error:', error);
          console.error('Stack:', error.stack);
        }
      });
    } catch (error) {
      console.error('‚ùå BOQ Chat: Library import error:', error);
      console.error('Stack:', error.stack);
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeChat);
  } else {
    initializeChat();
  }
</script>

<script>
  // Handle "Parse BOQ" Quick Action button click
  // Use event delegation to avoid timing issues with dynamic page navigation
  document.addEventListener('click', async function(e) {
    const analyzeBtn = e.target.closest('#analyze-structure-btn');
    const confirmBtn = e.target.closest('#confirm-parse-btn');
    
    if (analyzeBtn) {
      e.preventDefault();
      
      const boqId = window.location.pathname.split('/').pop();
      const headerRowInput = document.getElementById('header-row-input');
      const headerRowIdx = headerRowInput ? parseInt(headerRowInput.value, 10) || 0 : 0;
      
      try {
        // Fetch the CSV as JSON
        const response = await fetch(`/boqs/${boqId}/csv_as_json?header_row_index=${headerRowIdx}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const jsonArray = await response.json();
        const jsonString = JSON.stringify(jsonArray, null, 2);
        
        // Set the input field with the message template
        const inputField = document.querySelector('[data-llamabot="message-input"]');
        if (inputField) {
          inputField.value = `Please parse this for the BOQ with ID = ${boqId}, Here is the raw CSV data: <CSV> ${jsonString} </CSV>`;
          inputField.focus();
        }
      } catch (error) {
        console.error('Error fetching CSV data:', error);
        showToast('Failed to fetch CSV data for parsing', 'error');
      }
    } else if (confirmBtn) {
      e.preventDefault();
      
      // Set the input field with confirmation message
      const inputField = document.querySelector('[data-llamabot="message-input"]');
      if (inputField) {
        inputField.value = 'Yes, please parse into BOQ Line Items';
        inputField.focus();
      }
    }
  });
</script>

