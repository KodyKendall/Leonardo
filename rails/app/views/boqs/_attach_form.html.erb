<dialog id="boq_attach_modal" class="modal">
  <div class="modal-box w-full max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Attach Existing BOQ</h3>
    
    <div class="form-control mb-4">
      <div class="flex gap-2">
        <input 
          type="text" 
          id="boq_search_input" 
          placeholder="Search by BOQ name, client name, or QS name..." 
          class="input input-bordered w-full"
        />
        <button 
          type="button" 
          id="refresh_boqs_btn"
          class="btn btn-square btn-outline"
          title="Refresh BOQ list"
        >
          <i class="fa-solid fa-arrows-rotate"></i>
        </button>
      </div>
    </div>

    <div id="boq_search_results" class="space-y-2 max-h-96 overflow-y-auto border border-gray-200 rounded p-4 bg-gray-50">
      <p class="text-gray-500 text-sm">Click refresh or start typing to load BOQs...</p>
    </div>

    <div class="modal-action mt-4">
      <button type="button" class="btn" onclick="document.getElementById('boq_attach_modal').close()">Cancel</button>
    </div>
    
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </div>
</dialog>

<!-- Detach Confirmation Modal -->
<dialog id="boq_detach_modal" class="modal">
  <div class="modal-box w-full max-w-md">
    <h3 class="font-bold text-lg mb-4">Detach BOQ?</h3>
    
    <div class="mb-4">
      <p class="text-gray-700 mb-2">This BOQ is currently attached to:</p>
      <p class="font-semibold text-blue-600 mb-4" id="detach_tender_name"></p>
      
      <p class="text-sm text-gray-600">
        If you detach it, you'll be able to attach it to this tender. The tender it's currently attached to will no longer have this BOQ.
      </p>
    </div>

    <div class="modal-action mt-6">
      <button type="button" class="btn btn-ghost" onclick="document.getElementById('boq_detach_modal').close()">Cancel</button>
      <button type="button" class="btn btn-warning" id="confirm_detach_btn">Detach & Attach</button>
    </div>
    
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </div>
</dialog>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('boq_search_input');
  const resultsContainer = document.getElementById('boq_search_results');
  const refreshBtn = document.getElementById('refresh_boqs_btn');
  let debounceTimer;

  function loadBoqs(query = '') {
    resultsContainer.innerHTML = '<p class="text-gray-500 text-sm">Loading BOQs...</p>';
    
    fetch(`/boqs/search?q=${encodeURIComponent(query)}`, {
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json();
    })
    .then(data => {
      console.log('BOQs loaded:', data);
      if (!data || data.length === 0) {
        resultsContainer.innerHTML = '<p class="text-gray-500 text-sm">No BOQs found</p>';
        return;
      }
      
      resultsContainer.innerHTML = data.map(boq => {
        const isAttached = boq.tender_id && boq.tender_id !== null;
        const buttonText = isAttached ? 'Attached' : 'Attach';
        const buttonClass = isAttached ? 'btn btn-sm btn-disabled' : 'btn btn-sm btn-primary';
        
        let clickHandler = '';
        if (isAttached) {
          clickHandler = `openDetachModal(${boq.id}, '${(boq.boq_name || '').replace(/'/g, "\\'")}', '${(boq.tender_name || '').replace(/'/g, "\\'")}')`
        } else {
          clickHandler = `attachBoq(${boq.id}, '${(boq.boq_name || '').replace(/'/g, "\\'")}')`
        }
        
        return `
          <div class="flex items-center justify-between p-3 bg-white rounded border border-gray-200">
            <div class="flex-1">
              <p class="font-medium text-gray-800">${boq.boq_name || 'Unnamed'}</p>
              <p class="text-xs text-gray-500">
                ${boq.client_name ? 'Client: ' + boq.client_name : ''}
                ${boq.qs_name ? (boq.client_name ? ' â€¢ ' : '') + 'QS: ' + boq.qs_name : ''}
              </p>
              ${isAttached ? `<p class="text-xs text-orange-600 mt-1"><i class="fa-solid fa-link"></i> Attached to: ${boq.tender_name}</p>` : ''}
            </div>
            <button type="button" onclick="${clickHandler}" class="${buttonClass}">${buttonText}</button>
          </div>
        `;
      }).join('');
    })
    .catch(error => {
      console.error('Error loading BOQs:', error);
      resultsContainer.innerHTML = '<p class="text-red-500 text-sm">Error loading BOQs. Check console.</p>';
    });
  }

  // Refresh button
  if (refreshBtn) {
    refreshBtn.addEventListener('click', function(e) {
      e.preventDefault();
      searchInput.value = '';
      loadBoqs('');
    });
  }

  // Search input
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(debounceTimer);
      const query = this.value.trim();
      debounceTimer = setTimeout(() => {
        loadBoqs(query);
      }, 300);
    });
  }

  // Global function for button trigger
  window.loadBoqsForAttach = function() {
    loadBoqs('');
  };

  // Detach modal
  let pendingBoqForAttach = null;

  window.openDetachModal = function(boqId, boqName, tenderName) {
    pendingBoqForAttach = { id: boqId, name: boqName };
    document.getElementById('detach_tender_name').innerText = tenderName;
    const detachModal = document.getElementById('boq_detach_modal');
    if (detachModal.showModal) {
      detachModal.showModal();
    }
  };

  const confirmDetachBtn = document.getElementById('confirm_detach_btn');
  if (confirmDetachBtn) {
    confirmDetachBtn.addEventListener('click', function() {
      if (!pendingBoqForAttach) return;
      
      fetch(`/boqs/${pendingBoqForAttach.id}/detach`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          document.getElementById('boq_detach_modal').close();
          attachBoq(pendingBoqForAttach.id, pendingBoqForAttach.name);
        } else {
          alert('Error: ' + (data.message || 'Could not detach'));
        }
      })
      .catch(err => {
        console.error('Detach error:', err);
        alert('Error detaching BOQ');
      });
    });
  }

  window.attachBoq = function(boqId, boqName) {
    const tenderId = <%= @tender.id %>;
    
    fetch(`/tenders/${tenderId}/attach_boq`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ boq_id: boqId })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        document.getElementById('boq_attach_modal').close();
        window.location.reload();
      } else {
        alert('Error: ' + (data.message || 'Could not attach'));
      }
    })
    .catch(err => {
      console.error('Attach error:', err);
      alert('Error attaching BOQ');
    });
  };
});
</script>
