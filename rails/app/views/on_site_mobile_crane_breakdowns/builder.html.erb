<% content_for :title, "Mobile Crane Breakdown Builder" %>

<div class="container mx-auto px-4 py-8">
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-4xl font-bold mb-2">Mobile Crane Breakdown Builder</h1>
    <p class="text-gray-600">Configure your crane breakdown, view complements, and manage rates in one place.</p>
  </div>

  <!-- Section 1: Mobile Crane Breakdown Show -->
  <div class="mb-12">
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
      <h2 class="text-lg font-bold text-blue-900 flex items-center gap-2">
        <i class="fas fa-wrench"></i>
        Breakdown Configuration
      </h2>
      <p class="text-sm text-blue-800 mt-2">Review and manage your mobile crane breakdown settings.</p>
    </div>

    <%= render @on_site_mobile_crane_breakdown %>
  </div>

  <!-- Section 2: Crane Complements -->
  <div class="mb-12">
    <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 rounded flex items-center justify-between">
      <div>
        <h2 class="text-lg font-bold text-green-900 flex items-center gap-2">
          <i class="fas fa-cubes"></i>
          Crane Complements
        </h2>
        <p class="text-sm text-green-800 mt-2">Available crane complements by roof area range. <%= link_to "Manage complements →", crane_complements_path, class: "link text-green-600 font-medium", data: { turbo: false } %></p>
      </div>
    </div>

    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
      <% if @crane_complements.any? %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Area Range (sqm)
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Min Area
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Max Area
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Crane Recommendation
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Default Wet Rate / Day (R)
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% @crane_complements.each do |complement| %>
                <% is_matching = @on_site_mobile_crane_breakdown.erection_rate_sqm_per_day.present? && 
                                 @on_site_mobile_crane_breakdown.erection_rate_sqm_per_day >= complement.area_min_sqm && 
                                 @on_site_mobile_crane_breakdown.erection_rate_sqm_per_day <= complement.area_max_sqm %>
                <tr class="<%= is_matching ? 'bg-yellow-100 border-l-4 border-yellow-500' : 'hover:bg-gray-50' %> transition-colors">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium <%= is_matching ? 'text-yellow-900' : 'text-gray-900' %>">
                    <%= "#{number_with_precision(complement.area_min_sqm, precision: 2)} - #{number_with_precision(complement.area_max_sqm, precision: 2)}" %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm <%= is_matching ? 'text-yellow-800 font-medium' : 'text-gray-600' %>">
                    <%= number_with_precision(complement.area_min_sqm, precision: 2) %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm <%= is_matching ? 'text-yellow-800 font-medium' : 'text-gray-600' %>">
                    <%= number_with_precision(complement.area_max_sqm, precision: 2) %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                      <%= complement.crane_recommendation %>
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold <%= is_matching ? 'text-yellow-900' : 'text-gray-900' %>">
                    R <%= number_with_precision(complement.default_wet_rate_per_day, precision: 2) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="p-8 text-center text-gray-500">
          <i class="fas fa-inbox text-4xl mb-4 opacity-50"></i>
          <p class="font-medium">No crane complements found.</p>
          <p class="text-sm mt-2"><%= link_to "Add one", new_crane_complement_path, class: "link text-blue-600" %></p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Section 3: Tender Crane Selections -->
  <div class="mb-12">
    <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 mb-6 rounded flex items-center justify-between">
      <div>
        <h2 class="text-lg font-bold text-indigo-900 flex items-center gap-2">
          <i class="fas fa-list-check"></i>
          Selected Cranes
        </h2>
        <p class="text-sm text-indigo-800 mt-2">Cranes selected for this breakdown with rates and costs.</p>
      </div>
    </div>

    <%= render 'tender_crane_selections/index_table', on_site_mobile_crane_breakdown: @on_site_mobile_crane_breakdown %>
  </div>

  <!-- Section 4: Crane Rates -->
  <div class="mb-12">
    <div class="bg-purple-50 border-l-4 border-purple-500 p-4 mb-6 rounded">
      <h2 class="text-lg font-bold text-purple-900 flex items-center gap-2">
        <i class="fas fa-dollar-sign"></i>
        Crane Rates
      </h2>
      <p class="text-sm text-purple-800 mt-2">Daily rates for different crane sizes and ownership types.</p>
    </div>

    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
      <% if @crane_rates.any? %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Size
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Ownership Type
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Dry Rate / Day (R)
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Diesel / Day (R)
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Wet Rate / Day (R)
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Effective From
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  Status
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% @crane_rates.each do |rate| %>
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                    <%= rate.size %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium <%= rate.ownership_type == 'rental' ? 'bg-orange-100 text-orange-800' : 'bg-indigo-100 text-indigo-800' %>">
                      <%= rate.ownership_type.titleize %>
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    R <%= number_with_precision(rate.dry_rate_per_day, precision: 2) %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    R <%= number_with_precision(rate.diesel_per_day, precision: 2) %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                    R <%= number_with_precision(rate.wet_rate_per_day, precision: 2) %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    <%= rate.effective_from.strftime("%d %b %Y") %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <% if rate.is_active %>
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i class="fas fa-check-circle mr-1"></i>
                        Active
                      </span>
                    <% else %>
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        <i class="fas fa-times-circle mr-1"></i>
                        Inactive
                      </span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="p-8 text-center text-gray-500">
          <i class="fas fa-inbox text-4xl mb-4 opacity-50"></i>
          <p class="font-medium">No crane rates found.</p>
          <p class="text-sm mt-2"><%= link_to "Add one", new_crane_rate_path, class: "link text-blue-600" %></p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Back Button -->
  <div class="flex gap-4 mt-12 pb-8">
    <% if @on_site_mobile_crane_breakdown.tender %>
      <%= link_to "← Back to Tender", tender_path(@on_site_mobile_crane_breakdown.tender), class: "btn btn-outline", data: { turbo: false } %>
    <% else %>
      <%= link_to "← Back to Breakdowns", on_site_mobile_crane_breakdowns_path, class: "btn btn-outline", data: { turbo: false } %>
    <% end %>
  </div>
</div>
