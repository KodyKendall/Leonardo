<%= turbo_frame_tag dom_id(on_site_mobile_crane_breakdown) do %>
  <div class="bg-white rounded-lg border border-gray-200 p-6">
    <%= form_with model: on_site_mobile_crane_breakdown, local: true, data: { controller: "on-site-mobile-crane-breakdown dirty-form", action: "input->dirty-form#change change->dirty-form#change turbo:before-stream-render->dirty-form#showSaveSuccess" } do |f| %>
      <% if on_site_mobile_crane_breakdown.errors.any? %>
        <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
          <h2 class="font-bold text-red-600"><%= pluralize(on_site_mobile_crane_breakdown.errors.count, "error") %> prohibited this breakdown from being saved:</h2>
          <ul class="list-disc ml-5 mt-2">
            <% on_site_mobile_crane_breakdown.errors.full_messages.each do |message| %>
              <li class="text-red-600"><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Hidden Submit Button -->
      <%= f.submit "", style: "display: none;", data: { "dirty-form-target": "submit" } %>

      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold">Mobile Crane Breakdown</h2>
          <!-- Back to Tender Button -->
          <% if on_site_mobile_crane_breakdown.tender %>
            <div class="mt-4">
              <p class="text-xs font-medium text-gray-600 mb-2 uppercase tracking-wide">Navigate Back</p>
              <div class="flex items-center gap-2">
                <i class="fas fa-arrow-left text-gray-500 text-sm"></i>
                <%= link_to "Back to #{on_site_mobile_crane_breakdown.tender.tender_name || 'Tender'}", tender_path(on_site_mobile_crane_breakdown.tender), class: "btn btn-sm btn-primary shadow-sm hover:shadow-md", data: { turbo: false } %>
              </div>
            </div>
          <% end %>
        </div>
        
        <!-- Edit and Delete Buttons -->
        <div class="flex gap-2">
          <!-- Edit Button (Pencil Icon / Checkmark) -->
          <button type="button"
            data-on-site-mobile-crane-breakdown-target="editButton"
            data-action="click->on-site-mobile-crane-breakdown#toggleEdit"
            class="btn btn-circle btn-outline btn-sm"
            title="Edit"
            data-testid="edit-button">
            <i class="fas fa-pencil text-lg"></i>
          </button>

          <!-- Delete Button (Trash Icon) -->
          <button type="button"
            class="btn btn-circle btn-error btn-sm"
            title="Delete"
            onclick="if(confirm('Are you sure?')) { fetch('<%= on_site_mobile_crane_breakdown_path(on_site_mobile_crane_breakdown) %>', { method: 'DELETE', headers: { 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content } }).then(() => window.location = '<%= on_site_mobile_crane_breakdowns_path %>'); }">
            <i class="fas fa-trash text-lg"></i>
          </button>
        </div>
      </div>

      <!-- Total Roof Area -->
      <div class="form-control">
        <label class="label" for="on_site_mobile_crane_breakdown_total_roof_area_sqm">
          <span class="label-text font-medium">Total roof area (sqm)</span>
        </label>
        <%= f.number_field :total_roof_area_sqm, step: :any, class: "input input-bordered read-only-field", placeholder: "0.00", readonly: true, data: { "on-site-mobile-crane-breakdown-target": "field", testid: "total-roof-area-field" } %>
      </div>

      <!-- Erection Rate -->
      <div class="form-control">
        <label class="label" for="on_site_mobile_crane_breakdown_erection_rate_sqm_per_day">
          <span class="label-text font-medium">Erection rate (sqm per day)</span>
        </label>
        <%= f.number_field :erection_rate_sqm_per_day, step: :any, class: "input input-bordered read-only-field", placeholder: "0.00", readonly: true, data: { "on-site-mobile-crane-breakdown-target": "field", testid: "erection-rate-field" } %>
      </div>

      <!-- Program Duration (calculated, read-only) -->
      <div class="form-control">
        <label class="label" for="on_site_mobile_crane_breakdown_program_duration_days">
          <span class="label-text font-medium">Program duration (days)</span>
        </label>
        <div class="input input-bordered bg-gray-100 cursor-not-allowed flex items-center" id="program_duration_display" data-testid="program-duration-display">
          <%= on_site_mobile_crane_breakdown.program_duration_days %>
        </div>
        <p class="text-xs text-gray-500 mt-1">Auto-calculated from roof area รท erection rate</p>
      </div>

      <!-- Splicing Crane Required -->
      <div class="form-control my-8">
        <label class="label cursor-pointer">
          <span class="label-text font-bold text-lg">Splicing crane required?</span>
          <%= f.check_box :splicing_crane_required, { class: "checkbox checkbox-primary", data: { "on-site-mobile-crane-breakdown-target": "field", testid: "splicing-crane-required-checkbox" }, id: "splicing_crane_required_checkbox", disabled: true } %>
        </label>
      </div>

      <!-- Splicing Crane Size -->
      <div class="form-control" id="splicing_crane_size_field" data-testid="splicing-crane-size-field" style="<%= 'display: none;' unless on_site_mobile_crane_breakdown.splicing_crane_required %>">
        <label class="label" for="on_site_mobile_crane_breakdown_splicing_crane_size">
          <span class="label-text font-medium">Splicing crane size</span>
        </label>
        <%= f.text_field :splicing_crane_size, class: "input input-bordered read-only-field", placeholder: "e.g., 50T", readonly: true, data: { "on-site-mobile-crane-breakdown-target": "field", testid: "splicing-crane-size-input" } %>
      </div>

      <!-- Splicing Crane Days -->
      <div class="form-control" id="splicing_crane_days_field" data-testid="splicing-crane-days-field" style="<%= 'display: none;' unless on_site_mobile_crane_breakdown.splicing_crane_required %>">
        <label class="label" for="on_site_mobile_crane_breakdown_splicing_crane_days">
          <span class="label-text font-medium">Splicing crane days</span>
        </label>
        <%= f.number_field :splicing_crane_days, class: "input input-bordered read-only-field", placeholder: "0", readonly: true, data: { "on-site-mobile-crane-breakdown-target": "field", testid: "splicing-crane-days-input" } %>
      </div>

      <!-- Misc Crane Required -->
      <div class="form-control my-8">
        <label class="label cursor-pointer">
          <span class="label-text font-bold text-lg">Misc crane required?</span>
          <%= f.check_box :misc_crane_required, { class: "checkbox checkbox-primary", data: { "on-site-mobile-crane-breakdown-target": "field", testid: "misc-crane-required-checkbox" }, id: "misc_crane_required_checkbox", disabled: true } %>
        </label>
      </div>

      <!-- Misc Crane Size -->
      <div class="form-control" id="misc_crane_size_field" data-testid="misc-crane-size-field" style="<%= 'display: none;' unless on_site_mobile_crane_breakdown.misc_crane_required %>">
        <label class="label" for="on_site_mobile_crane_breakdown_misc_crane_size">
          <span class="label-text font-medium">Misc crane size</span>
        </label>
        <%= f.text_field :misc_crane_size, class: "input input-bordered read-only-field", placeholder: "e.g., 30T", readonly: true, data: { "on-site-mobile-crane-breakdown-target": "field", testid: "misc-crane-size-input" } %>
      </div>

      <!-- Misc Crane Days -->
      <div class="form-control" id="misc_crane_days_field" data-testid="misc-crane-days-field" style="<%= 'display: none;' unless on_site_mobile_crane_breakdown.misc_crane_required %>">
        <label class="label" for="on_site_mobile_crane_breakdown_misc_crane_days">
          <span class="label-text font-medium">Misc crane days</span>
        </label>
        <%= f.number_field :misc_crane_days, class: "input input-bordered read-only-field", placeholder: "0", readonly: true, data: { "on-site-mobile-crane-breakdown-target": "field", testid: "misc-crane-days-input" } %>
      </div>

      <!-- Status Indicator (Unsaved/Saved) -->
      <div data-dirty-form-target="indicator" class="hidden flex items-center gap-2 p-3 mt-6 bg-yellow-50 border border-yellow-200 rounded-md">
        <i class="fas fa-exclamation-circle text-yellow-600"></i>
        <span class="text-sm font-medium text-yellow-800">Unsaved changes</span>
      </div>

      <!-- Saved Confirmation (hidden by default) -->
      <div data-dirty-form-target="savedIndicator" data-testid="saved-indicator" class="hidden flex items-center gap-2 p-3 mt-6 bg-green-50 border border-green-200 rounded-md">
        <i class="fas fa-check-circle text-green-600"></i>
        <span class="text-sm font-medium text-green-800">Changes saved</span>
      </div>
    <% end %>
  </div>
<% end %>


